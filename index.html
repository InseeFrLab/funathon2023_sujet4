<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mon Yuka ğŸ¥• avec Python ğŸ</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#objectif-et-approche-pÃ©dagogique" id="toc-objectif-et-approche-pÃ©dagogique" class="nav-link active" data-scroll-target="#objectif-et-approche-pÃ©dagogique">Objectif et approche pÃ©dagogique</a>
  <ul class="collapse">
  <li><a href="#etapes-du-projet" id="toc-etapes-du-projet" class="nav-link" data-scroll-target="#etapes-du-projet">Etapes du projet</a></li>
  <li><a href="#remarques" id="toc-remarques" class="nav-link" data-scroll-target="#remarques">Remarques</a></li>
  <li><a href="#sources-et-packages-utilisÃ©s" id="toc-sources-et-packages-utilisÃ©s" class="nav-link" data-scroll-target="#sources-et-packages-utilisÃ©s">Sources et packages utilisÃ©s</a></li>
  </ul></li>
  <li><a href="#rÃ©cupÃ©ration-des-donnÃ©es-openfoodfacts" id="toc-rÃ©cupÃ©ration-des-donnÃ©es-openfoodfacts" class="nav-link" data-scroll-target="#rÃ©cupÃ©ration-des-donnÃ©es-openfoodfacts">1ï¸âƒ£ RÃ©cupÃ©ration des donnÃ©es <code>OpenFoodFacts</code></a>
  <ul class="collapse">
  <li><a href="#prÃ©liminaire" id="toc-prÃ©liminaire" class="nav-link" data-scroll-target="#prÃ©liminaire">1.1. PrÃ©liminaire (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts" id="toc-tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts" class="nav-link" data-scroll-target="#tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts">1.2. TÃ©lÃ©charger et nettoyer la base <code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#classification-automatique-dans-une-nomenclature-de-produits" id="toc-classification-automatique-dans-une-nomenclature-de-produits" class="nav-link" data-scroll-target="#classification-automatique-dans-une-nomenclature-de-produits">1.3. Classification automatique dans une nomenclature de produits (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#bis-version-alternative-via-lapi-predicat" id="toc-bis-version-alternative-via-lapi-predicat" class="nav-link" data-scroll-target="#bis-version-alternative-via-lapi-predicat">1.3.bis Version alternative via lâ€™API <code>predicat</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#ter-entrainer-son-propre-classifieur" id="toc-ter-entrainer-son-propre-classifieur" class="nav-link" data-scroll-target="#ter-entrainer-son-propre-classifieur">1.3.ter Entrainer son propre classifieur (ğŸ”´,âš«)</a></li>
  <li><a href="#ecriture-de-la-base-sur-lespace-de-stockage-distant" id="toc-ecriture-de-la-base-sur-lespace-de-stockage-distant" class="nav-link" data-scroll-target="#ecriture-de-la-base-sur-lespace-de-stockage-distant">1.4. Ecriture de la base sur lâ€™espace de stockage distant</a></li>
  </ul></li>
  <li><a href="#faire-des-statistiques-agrÃ©gÃ©es-par-catÃ©gories" id="toc-faire-des-statistiques-agrÃ©gÃ©es-par-catÃ©gories" class="nav-link" data-scroll-target="#faire-des-statistiques-agrÃ©gÃ©es-par-catÃ©gories">2ï¸âƒ£ Faire des statistiques agrÃ©gÃ©es par catÃ©gories</a>
  <ul class="collapse">
  <li><a href="#prÃ©liminaires" id="toc-prÃ©liminaires" class="nav-link" data-scroll-target="#prÃ©liminaires">2.1. PrÃ©liminaires (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas" id="toc-import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas" class="nav-link" data-scroll-target="#import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas">2.2. Import des donnÃ©es depuis lâ€™espace de stockage distant avec <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ)</a>
  <ul class="collapse">
  <li><a href="#import-et-nettoyage-des-donnÃ©es-openfoodfacts-et" id="toc-import-et-nettoyage-des-donnÃ©es-openfoodfacts-et" class="nav-link" data-scroll-target="#import-et-nettoyage-des-donnÃ©es-openfoodfacts-et">Import et nettoyage des donnÃ©es <code>OpenFoodFacts</code> (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</a></li>
  </ul></li>
  <li><a href="#statistiques-descriptives-et" id="toc-statistiques-descriptives-et" class="nav-link" data-scroll-target="#statistiques-descriptives-et">2.3. Statistiques descriptives (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</a></li>
  <li><a href="#import-et-traitement-des-donnÃ©es-avec-duckdb-et" id="toc-import-et-traitement-des-donnÃ©es-avec-duckdb-et" class="nav-link" data-scroll-target="#import-et-traitement-des-donnÃ©es-avec-duckdb-et">2.4. Import et traitement des donnÃ©es avec <code>DuckDB</code> (ğŸ”´ et âš«)</a></li>
  <li><a href="#sauvegarde-dans-lespace-de-stockage-distant" id="toc-sauvegarde-dans-lespace-de-stockage-distant" class="nav-link" data-scroll-target="#sauvegarde-dans-lespace-de-stockage-distant">2.5. Sauvegarde dans lâ€™espace de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#crÃ©ation-dun-modÃ¨le-de-graphiques" id="toc-crÃ©ation-dun-modÃ¨le-de-graphiques" class="nav-link" data-scroll-target="#crÃ©ation-dun-modÃ¨le-de-graphiques">2.6. CrÃ©ation dâ€™un modÃ¨le de graphiques (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  </ul></li>
  <li><a href="#comparer-un-produit-Ã -un-groupe-similaire" id="toc-comparer-un-produit-Ã -un-groupe-similaire" class="nav-link" data-scroll-target="#comparer-un-produit-Ã -un-groupe-similaire">3ï¸âƒ£ Comparer un produit Ã  un groupe similaire</a>
  <ul class="collapse">
  <li><a href="#dÃ©tection-de-code-barre" id="toc-dÃ©tection-de-code-barre" class="nav-link" data-scroll-target="#dÃ©tection-de-code-barre">3.1. DÃ©tection de code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#association-dun-code-barre-Ã -un-produit-dopenfoodfacts" id="toc-association-dun-code-barre-Ã -un-produit-dopenfoodfacts" class="nav-link" data-scroll-target="#association-dun-code-barre-Ã -un-produit-dopenfoodfacts">3.2. Association dâ€™un code barre Ã  un produit dâ€™<code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#production-automatique-dun-graphique" id="toc-production-automatique-dun-graphique" class="nav-link" data-scroll-target="#production-automatique-dun-graphique">Production automatique dâ€™un graphique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  </ul></li>
  <li><a href="#construire-une-application-interactive" id="toc-construire-une-application-interactive" class="nav-link" data-scroll-target="#construire-une-application-interactive">4ï¸âƒ£ Construire une application interactive</a>
  <ul class="collapse">
  <li><a href="#lancer-lapplication-pour-la-tester" id="toc-lancer-lapplication-pour-la-tester" class="nav-link" data-scroll-target="#lancer-lapplication-pour-la-tester">4.1. Lancer lâ€™application pour la tester (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#crÃ©er-lapplication-dans-un-serveur-temporaire" id="toc-crÃ©er-lapplication-dans-un-serveur-temporaire" class="nav-link" data-scroll-target="#crÃ©er-lapplication-dans-un-serveur-temporaire">4.2. CrÃ©er lâ€™application dans un serveur temporaire (ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#en-marche-vers-la-mise-en-production" id="toc-en-marche-vers-la-mise-en-production" class="nav-link" data-scroll-target="#en-marche-vers-la-mise-en-production">4.3. En marche vers la mise en production (ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</a></li>
  </ul></li>
  <li><a href="#dÃ©ploiement-de-lapplication-interactive" id="toc-dÃ©ploiement-de-lapplication-interactive" class="nav-link" data-scroll-target="#dÃ©ploiement-de-lapplication-interactive">5ï¸âƒ£ DÃ©ploiement de lâ€™application interactive</a>
  <ul class="collapse">
  <li><a href="#prÃ©liminaires-1" id="toc-prÃ©liminaires-1" class="nav-link" data-scroll-target="#prÃ©liminaires-1">5.1. PrÃ©liminaires (ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#conteneurisation-de-lapplication" id="toc-conteneurisation-de-lapplication" class="nav-link" data-scroll-target="#conteneurisation-de-lapplication">5.2. Conteneurisation de lâ€™application (ğŸ”µ,ğŸ”´,âš«)</a></li>
  <li><a href="#dÃ©ploiement-sur-le-ssp-cloud" id="toc-dÃ©ploiement-sur-le-ssp-cloud" class="nav-link" data-scroll-target="#dÃ©ploiement-sur-le-ssp-cloud">5.3. DÃ©ploiement sur le <code>SSP Cloud</code></a></li>
  <li><a href="#bonus-le-parcours" id="toc-bonus-le-parcours" class="nav-link" data-scroll-target="#bonus-le-parcours">Bonus: le parcours ğŸŸ£</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Mon Yuka ğŸ¥• avec Python ğŸ</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Ce notebook vise Ã  prÃ©senter pas Ã  pas comment crÃ©er une application interactive avec <code>Streamlit</code> reproduisant celle proposÃ©e sur <a href="https://myyuka.lab.sspcloud.fr/">myyuka.lab.sspcloud.fr</a>.</p>
<p>Cet exercice est proposÃ© dans le cadre du <code>Funathon</code> (hackathon non compÃ©titif) organisÃ© en 2023 par lâ€™Insee et le MinistÃ¨re de lâ€™Agriculture sur le thÃ¨me <em>â€œDu champ Ã  lâ€™assietteâ€</em>. Les autres sujets sont disponibles sur le <a href="https://github.com/InseeFrLab/funathon2023"><code>Github InseeFrLab</code></a>.</p>
<section id="objectif-et-approche-pÃ©dagogique" class="level1">
<h1>Objectif et approche pÃ©dagogique</h1>
<p>Lâ€™objectif de ce projet est dâ€™apprendre Ã  utiliser <code>Python</code> pour crÃ©er des applications rÃ©actives avec <code>Streamlit</code> mais aussi de se familiariser Ã  la manipulation de donnÃ©es avec <code>Python</code> et, au passage, Ã  quelques bonnes pratiques utiles pour obtenir des projets plus lisibles et reproductibles.</p>
<p>Pour parvenir Ã  cet objectif, il est possible dâ€™emprunter plusieurs voies, plus ou moins guidÃ©es. Celles-ci sont lÃ  pour permettre que ce sujet soit rÃ©alisable. Elles sont balisÃ©es de la maniÃ¨re suivante:</p>
<table class="table">
<colgroup>
<col style="width: 15%">
<col style="width: 17%">
<col style="width: 30%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Balisage</th>
<th>Approche</th>
<th>PrÃ©requis de niveau</th>
<th>Objectif pÃ©dagogique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ğŸŸ¡</td>
<td>ExÃ©cuter les cellules permet dâ€™obtenir le rÃ©sultat attendu</td>
<td>CapacitÃ© Ã  installer des <em>packages</em></td>
<td>DÃ©couvrir de nouveaux <em>packages</em> en suivant le fil conducteur du projet, dÃ©couvrir les scripts <code>Python</code>, se familiariser avec <code>Git</code></td>
</tr>
<tr class="even">
<td>ğŸŸ¢</td>
<td>Des instructions dÃ©taillÃ©es sur la maniÃ¨re de procÃ©der sont proposÃ©es</td>
<td>ConnaÃ®tre quelques manipulations avec <code>Pandas</code></td>
<td>Apprendre Ã  utiliser certains <em>packages</em> avec un projet guidÃ©, se familiariser avec les projets <code>Python</code> plus consÃ©quents que les <em>notebooks</em> <code>Jupyter</code></td>
</tr>
<tr class="odd">
<td>ğŸ”µ</td>
<td>Instructions moins dÃ©taillÃ©es</td>
<td>CapacitÃ© Ã  manipuler des donnÃ©es avec <code>Pandas</code></td>
<td>Apprendre Ã  modulariser du code pour faciliter sa rÃ©utilisation dans une application, dÃ©couvrir la rÃ©cupation de donnÃ©es via des API</td>
</tr>
<tr class="even">
<td>ğŸ”´</td>
<td>Peu dâ€™instructions</td>
<td>ExpÃ©rience en dÃ©veloppement de code <code>Python</code></td>
<td>DÃ©couvrir la crÃ©ation dâ€™application ou se familiariser avec lâ€™Ã©cosystÃ¨me <code>DuckDB</code></td>
</tr>
<tr class="odd">
<td>âš«</td>
<td>Autonomie</td>
<td>Bonne maÃ®trise de <code>Python</code> et de la ligne de commande Ì€<code>Linux</code></td>
<td>Sâ€™initier au dÃ©ploiement dâ€™une application ou Ã  lâ€™ingÃ©nieurie de donnÃ©es&nbsp;</td>
</tr>
</tbody>
</table>
<p>Le parcours vers la mise en oeuvre dâ€™une application fonctionnelle se fait par Ã©tapes, en sÃ©quenÃ§ant le projet pour permettre dâ€™avoir un projet lisible, reproductible et modulaire.</p>
<p>Les Ã©tapes ne sont pas forcÃ©ment de difficultÃ© graduelle, il sâ€™agit plutÃ´t de sÃ©quencer de maniÃ¨re logique le projet pour vous faciliter la prise en main.</p>
<p>Il est donc tout Ã  fait possible de passer, selon les parties, dâ€™une voie ğŸŸ¢ Ã  une voie ğŸ”µ ou bien de tester les codes proposÃ©s dans la voie ğŸŸ¡ dâ€™abord puis, une fois que la logique a Ã©tÃ© comprise, essayer de les faire soit-mÃªme via la voie ğŸŸ¢ ou encore essayer via la voie ğŸ”µ, ne pas y parvenir du fait du caractÃ¨re plus succinct des instructions et regarder les instructions de la voie ğŸŸ¢ ou la solution de la voie ğŸŸ¡.</p>
<p>Il est mÃªme tout Ã  fait possible de sauter une Ã©tape et reprendre Ã  partir de la suivante grÃ¢ce aux <em>checkpoints</em> proposÃ©s.</p>
<p>Les consignes sont encapsulÃ©es dans des boites dÃ©diÃ©es, afin dâ€™Ãªtre sÃ©parÃ©es des explications gÃ©nÃ©rales.</p>
<p>Par exemple, la boite verte prendra lâ€™aspect suivant:</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Exemple (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser la fonction <code>print</code> pour afficher le texte <em>â€œTotoâ€</em></p>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<p>alors que sur le mÃªme exercice, si plusieurs voies peuvent emprunter le mÃªme chemin, on utilisera une dÃ©limitation grise :</p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Exemple (ğŸ”µ,ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Afficher le texte <em>â€œTotoâ€</em></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<p>La solution associÃ©e, visible pour les personnes sur la voie ğŸŸ¡, sera:</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"toto"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="etapes-du-projet" class="level2">
<h2 class="anchored" data-anchor-id="etapes-du-projet">Etapes du projet</h2>
<p>Le projet est sÃ©quencÃ© de la maniÃ¨re suivante:</p>
<table class="table">
<colgroup>
<col style="width: 47%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>Etape</th>
<th>Objectif</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RÃ©cupÃ©ration et nettoyage de la base <code>OpenFoodFacts</code></td>
<td>Lire des donnÃ©es avec <code>Pandas</code> depuis un site web (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), appliquer des nettoyages de champs textuels (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), catÃ©goriser ces donnÃ©es avec un classifieur automatique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«) voire entrainer un classifieur <em>ad hoc</em> (ğŸ”´,âš«), Ã©crire ces donnÃ©es sur un systÃ¨me de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</td>
</tr>
<tr class="even">
<td>Faire des statistiques agrÃ©gÃ©es par catÃ©gories</td>
<td>Utiliser <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<code>DuckDB</code> (ğŸ”´,âš«) pour faire des statistiques par groupe</td>
</tr>
<tr class="odd">
<td>Trouver un produit dans <code>OpenFoodFacts</code> Ã  partir dâ€™un code barre</td>
<td>DÃ©tection visuelle dâ€™un code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), rechercher des donnÃ©es avec des critÃ¨res dâ€™appariement exact comme le code barre via <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<code>DuckDB</code> (ğŸ”´,âš«) ou via des distances textuelles (ğŸ”´,âš«)</td>
</tr>
<tr class="even">
<td>Encapsuler ces Ã©tapes dans une application <code>Streamlit</code></td>
<td>Tester une application <code>Streamlit</code> minimale (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), personnaliser celle-ci (ğŸ”´,âš« ou ğŸŸ¡,ğŸŸ¢,ğŸ”µ dÃ©sirant se focaliser sur <code>Streamlit</code>)</td>
</tr>
<tr class="odd">
<td>Mettre en production cette application</td>
<td>DÃ©ployer grÃ¢ce Ã  des serveurs standardisÃ©s une application <code>Streamlit</code> (ğŸ”´,âš«) ou proposer une version sans serveur (âš« voulant se familiariser Ã  <code>Observable</code>)</td>
</tr>
</tbody>
</table>
<p>Le dÃ©veloppement Ã  proprement parler de lâ€™application est donc assez tardif car un certain nombre dâ€™Ã©tapes prÃ©alables sont nÃ©cessaires pour ne pas avoir une application monolithique (ce qui est une bonne pratique). Si vous nâ€™Ãªtes intÃ©ressÃ©s que par dÃ©velopper une application <code>Streamlit</code>, vous pouvez directement passer aux Ã©tapes concernÃ©es (Ã  partir de la partie 3ï¸).</p>
<p>La premiÃ¨re Ã©tape (1ï¸âƒ£ <em>RÃ©cupÃ©ration et nettoyage de la base <code>OpenFoodFacts</code></em>) peut Ãªtre assez chronophage. Cela est assez reprÃ©sentatif des projets de <em>data science</em> oÃ¹ la majoritÃ© du temps est consacrÃ©e Ã  la structuration et la manipulation de donnÃ©es. La deuxiÃ¨me Ã©tape (2ï¸ <em>â€œFaire des statistiques agrÃ©gÃ©es par catÃ©goriesâ€</em>) est la moins centrale de ce sujet: si vous manquez de temps vous pouvez la passer et utiliser directement les morceaux de code mis Ã  disposition.</p>
</section>
<section id="remarques" class="level2">
<h2 class="anchored" data-anchor-id="remarques">Remarques</h2>
<p>Cette page peut Ãªtre consultÃ©e par diffÃ©rents canaux:</p>
<ul>
<li>Sur un site web, les codes faisant office de solution sont, par dÃ©fauts, cachÃ©s. Cela peut Ãªtre pratique de consulter cette page si vous Ãªtes sur un parcours de couleur diffÃ©rente que le jaune et ne voulez pas voir la solution sans le vouloir ;</li>
<li>Sur un notebook <code>Jupyter</code>, les solutions de la voie ğŸŸ¡ sont affichÃ©es par dÃ©faut. Elles peuvent Ãªtre cachÃ©es en faisant <code>View</code> &gt; <code>Collapse All Code</code></li>
</ul>
</section>
<section id="sources-et-packages-utilisÃ©s" class="level2">
<h2 class="anchored" data-anchor-id="sources-et-packages-utilisÃ©s">Sources et packages utilisÃ©s</h2>
<p>Notre source de rÃ©fÃ©rence sera <a href="https://fr.openfoodfacts.org/"><code>OpenFoodFacts</code></a>, une base contributive sur les produits alimentaires.</p>
<div class="cell markdown">
<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #ffc10780;">
<h3 class="alert-heading anchored"><i class="fa fa-lightbulb-o"></i> Hint</h3>
<p>Nous utiliserons Ã©galement un classifieur automatique issu du projet <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a>. Il sâ€™agit dâ€™un modÃ¨le qui utilise des noms de produits pour leur associer des catÃ©gories de la nomenclature <a href="https://www.insee.fr/fr/information/2408172">COICOP (Classification des fonctions de consommation des mÃ©nages)</a>.</p>
<p>Ce modÃ¨le est lÃ  Ã  des fins de dÃ©monstration du principe de la classification automatique et de la maniÃ¨re dont celle-ci peut Ãªtre intÃ©grÃ©e Ã  un processus de production de donnÃ©es. Il ne sâ€™agit pas dâ€™un modÃ¨le officiel de lâ€™Insee.</p>
</div>
</div>
</section>
</section>
<section id="rÃ©cupÃ©ration-des-donnÃ©es-openfoodfacts" class="level1">
<h1>1ï¸âƒ£ RÃ©cupÃ©ration des donnÃ©es <code>OpenFoodFacts</code></h1>
<section id="prÃ©liminaire" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©liminaire">1.1. PrÃ©liminaire (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Comme nous allons utiliser frÃ©quemment certains paramÃ¨tres, une bonne pratique consiste Ã  les stocker dans un fichier dÃ©diÃ©, au format <code>YAML</code> et dâ€™importer celui-ci via <code>Python</code>. Ceci est expliquÃ© dans <a href="https://ensae-reproductibilite.github.io/website/chapters/application.html#etape-3-gestion-des-param%C3%A8tres">ce cours de lâ€™ENSAE</a></p>
<p>Nous proposons de crÃ©er le fichier suivant au nom <code>config.yaml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_OPENFOOD</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://static.openfoodfacts.org/data/en.openfoodfacts.org.products.csv.gz"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ENDPOINT_S3</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://minio.lab.sspcloud.fr"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">BUCKET</span><span class="kw">:</span><span class="at"> </span><span class="st">"projet-funathon"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">DESTINATION_DATA_S3</span><span class="kw">:</span><span class="at"> </span><span class="st">"/2023/sujet4/diffusion"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_FASTTEXT_MINIO</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/model_coicop10.bin"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_COICOP_LABEL</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>âš ï¸ Si vous dÃ©sirez pouvoir reproduire tous les exemples de ce fichier, vous devez changer la variable <code>BUCKET</code> pour mettre votre nom dâ€™utilisateur sur le <code>SSPCloud</code>.</p>
<p>Nous allons lire ce fichier avec le package adaptÃ© pour transformer ces instructions en variables <code>Python</code> (stockÃ©es dans un dictionnaire)!,</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://stackoverflow.com/questions/1773805/how-can-i-parse-a-yaml-file-in-python">cette page</a>, importer les variables dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser le package <code>PyYAML</code> pour importer les Ã©lÃ©ments prÃ©sents dans <code>config.yaml</code> dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Importer les Ã©lÃ©ments prÃ©sents dans <code>config.yaml</code> dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell yellow-code" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yaml</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> import_yaml(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Importer un fichier YAML</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">        filename (str): Emplacement du fichier</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Le fichier YAML sous forme de dictionnaire Python</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> yaml.safe_load(stream)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> config</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Il est recommandÃ© pour la suite de copier-coller la fonction crÃ©Ã©e (ne pas oublier les imports associÃ©s) dans un fichier Ã  lâ€™emplacement <code>utils/import_yaml.py</code>. Cette approche modulaire est une bonne pratique, recommandÃ©e dans <a href="https://ensae-reproductibilite.github.io/website/">ce cours de lâ€™ENSAE</a>.</p>
<p>Pour la voie ğŸŸ¡, ce fichier a dÃ©jÃ  Ã©tÃ© crÃ©Ã© pour vous. Le tester de la maniÃ¨re suivante:</p>
<div class="cell yellow-code" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts" class="level2">
<h2 class="anchored" data-anchor-id="tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts">1.2. TÃ©lÃ©charger et nettoyer la base <code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Un export quotidien de la base de donnÃ©es <code>OpenFoodFacts</code> est fourni au format <code>CSV</code>. Lâ€™URL est le suivant:</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"URL_OPENFOOD"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Il est possible dâ€™importer de plusieurs maniÃ¨res ce type de fichier avec <code>Python</code>. Ce quâ€™on propose ici, câ€™est de le faire en deux temps, afin dâ€™avoir un contrÃ´le des options mises en oeuvre lors de lâ€™import (notamment le format de certaines variables) :</p>
<ul>
<li>Utiliser <code>requests</code> pour tÃ©lÃ©charger le fichier et lâ€™Ã©crire, de maniÃ¨re intermÃ©diaire, sur le disque local ;</li>
<li>Utiliser <code>pandas</code> avec quelques options pour importer le fichier puis le manipuler.</li>
</ul>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Utiliser la fonction <code>requests.get</code> pour tÃ©lÃ©charger le fichier. Vous pouvez vous inspirer de rÃ©ponses <a href="https://stackoverflow.com/questions/16694907/download-large-file-in-python-with-requests">ici</a></p></li>
<li><p>Utiliser <code>pd.read_csv</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates=["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer quelques types avec lâ€™argument <code>dtype</code>. Voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em> avec la mÃ©thode <code>.astype(str)</code></li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Utiliser le <em>package</em> <code>requests</code> pour tÃ©lÃ©charger le fichier. Si vous voulez afficher une barre de progression, vous pouvez vous inspirer de la fonction <code>download_pb</code> du package <a href="https://github.com/InseeFrLab/cartiflette"><code>cartiflette</code></a></p></li>
<li><p>Lire les donnÃ©es avec <code>pandas</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates = ["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer, voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em></li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>TÃ©lÃ©charger le fichier avec <code>Python</code>. Pour sâ€™assurer de la progression du tÃ©lÃ©chargement, utiliser Ã©galement la librairie <code>tqdm</code>.</p></li>
<li><p>Lire les donnÃ©es avec <code>pandas</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates = ["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer, voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em></li>
</ol>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<div id="import-openfood-solution" class="cell yellow-code" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.preprocess_openfood <span class="im">import</span> download_openfood, import_openfood</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>download_openfood(destination <span class="op">=</span> <span class="st">"openfood.csv.gz"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> import_openfood(<span class="st">"openfood.csv.gz"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>openfood.loc[:, [<span class="st">'code'</span>, <span class="st">'product_name'</span>, <span class="st">'energy-kcal_100g'</span>, <span class="st">'nutriscore_grade'</span>]].sample(<span class="dv">5</span>, random_state <span class="op">=</span> <span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lâ€™objectif de lâ€™application est de proposer pour un produit donnÃ© quelques statistiques descriptives. On propose de se focaliser sur trois scores :</p>
<ul>
<li>Le <a href="https://www.santepubliquefrance.fr/determinants-de-sante/nutrition-et-activite-physique/articles/nutri-score"><strong>nutriscore</strong></a> ;</li>
<li>Le <a href="https://fr.openfoodfacts.org/nova"><strong>score Nova</strong></a> indiquant le degrÃ© de transformation dâ€™un produit ;</li>
<li>Lâ€™<a href="https://docs.score-environnemental.com/"><strong>Ã©coscore</strong></a>, une mesure de lâ€™empreinte carbone dâ€™un produit ;</li>
</ul>
<p>Ces scores ne sont pas systÃ©matiquement disponibles sur <code>OpenFoodFacts</code> mais une part croissante des donnÃ©es prÃ©sente ces informations (directement renseignÃ©es ou imputÃ©es).</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [<span class="st">'nutriscore_grade'</span>, <span class="st">'nova_group'</span>, <span class="st">'ecoscore_grade'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Le bloc de code ci-dessous propose dâ€™harmoniser le format de ces scores pour faciliter la reprÃ©sentation graphique ultÃ©rieure.</p>
<p>Comme il ne sâ€™agit pas du coeur du sujet, il est donnÃ© directement Ã  tous les parcours. Le code source de cette fonction est disponible dans le module <code>utils.pipeline</code>:</p>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.pipeline <span class="im">import</span> clean_note</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [<span class="st">'nutriscore_grade'</span>, <span class="st">'nova_group'</span>, <span class="st">'ecoscore_grade'</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>openfood.loc[:, indices_synthetiques] <span class="op">=</span> pd.concat(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        [clean_note(openfood, s, <span class="st">"wide"</span>) <span class="cf">for</span> s <span class="kw">in</span> indices_synthetiques],</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        axis <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="classification-automatique-dans-une-nomenclature-de-produits" class="level2">
<h2 class="anchored" data-anchor-id="classification-automatique-dans-une-nomenclature-de-produits">1.3. Classification automatique dans une nomenclature de produits (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Pour proposer sur notre application quelques statistiques pertinentes sur le produit, nous allons associer chaque ligne dâ€™<code>OpenFoodFacts</code> Ã  un type de produit dans la <code>COICOP</code> pour pouvoir comparer un produit Ã  des produits similaires.</p>
<p>Nous allons ainsi utiliser le nom du produit pour infÃ©rer le type de bien dont il sâ€™agit.</p>
<p>Pour cela, dans les parcours ğŸŸ¡,ğŸŸ¢ et ğŸ”µ, nous allons dâ€™utiliser un classifieur expÃ©rimental proposÃ© sur <a href="https://github.com/InseeFrLab/predicat"><code>Github InseeFrLab/predicat</code></a> qui a Ã©tÃ© entrainÃ© sur cette tÃ¢che sur un grand volume de donnÃ©es (non spÃ©cifiquement alimentaires).</p>
<p>Pour les parcours ğŸ”´ et âš«, nous proposons Ã©galement dâ€™utiliser ce classifieur. NÃ©anmoins, une voie bis est possible pour entraÃ®ner soi-mÃªme un classifieur en utilisant la catÃ©gorisation des donnÃ©es disponible directement dans <code>OpenFoodFacts</code>. Il est proposÃ© dâ€™utiliser <code>Fasttext</code> (une librairie spÃ©cialisÃ©e open-source, dÃ©veloppÃ©e par <code>Meta</code> il y a quelques annÃ©es) dans le cadre de la voie ğŸ”´. Les personnes suivant la voie âš« sont libres dâ€™utiliser nâ€™importe quel <em>framework</em> de classification, par exemple un modÃ¨le disponible sur <a href="https://huggingface.co/">HuggingFace</a>.</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> en appliquant la mÃ©thode <code>str.upper</code> Ã  la colonne <code>product_name</code> afin de la mettre en majuscule</li>
<li>Modifier le <code>DataFrame</code> avec la syntaxe prenant la forme <code>data.replace({variable: dict_rules_replacement}, regex=True)</code></li>
<li>Observer les cas oÃ¹ il y a eu des changements, par exemple de la maniÃ¨re suivante</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(openfood</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    .dropna(subset <span class="op">=</span> [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    .loc[</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        openfood[<span class="st">"product_name"</span>].<span class="bu">str</span>.upper() <span class="op">!=</span> openfood[<span class="st">"preprocessed_labels"</span>],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> mettant en majuscule la colonne <code>product_name</code></li>
<li>Modifier le <code>DataFrame</code> avec la syntaxe utilisant la mÃ©thode <code>replace</code> (celle qui sâ€™applique aux <code>DataFrame</code>, pas celle sâ€™appliquant Ã  une <code>Serie</code>) et le dictionnaire adaptÃ©</li>
<li>Observer les cas oÃ¹ il y a eu des changements,</li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> appliquant les remplacements Ã  <code>product_name</code> grÃ¢ce Ã  la mÃ©thode <code>replace</code> (celle qui sâ€™applique aux <code>DataFrame</code>, pas celle sâ€™appliquant Ã  une <code>Serie</code>)</li>
<li>Observer les cas oÃ¹ il y a eu des changements</li>
</ol>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> appliquant les remplacements Ã  <code>product_name</code></li>
<li>Observer les cas oÃ¹ il y a eu des changements</li>
</ol>
</details>
</div>
<!----- end âš« ----->
</div>
<p>Dans un premier temps, on rÃ©cupÃ¨re les fonctions permettant dâ€™appliquer sur nos donnÃ©es le mÃªme <em>preprocessing</em> que celui qui a Ã©tÃ© mis en oeuvre lors de lâ€™entraÃ®nement du modÃ¨le:</p>
<div id="get-utils-ddc" class="cell yellow-code" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡ et ğŸŸ¢</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> download_pb</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>download_pb(<span class="st">"https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py"</span>, <span class="st">"utils/utils_ddc.py"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour observer les nettoyages de champs textuels mis en oeuvre, les lignes suivantes peuvent Ãªtre exÃ©cutÃ©es:</p>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.utils_ddc <span class="im">import</span> replace_values_ean</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>replace_values_ean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour effectuer des remplacements dans des champs textuels, le plus simple est dâ€™utiliser les expressions rÃ©guliÃ¨res (<code>regex</code>). Vous pouvez trouver une ressource complÃ¨te sur le sujet dans <a href="https://pythonds.linogaliana.fr/regex/">ce cours de <code>Python</code> de lâ€™ENSAE</a>.</p>
<p>Deux options sâ€™offrent Ã  nous:</p>
<ul>
<li>Utiliser le <em>package</em> <code>re</code> et boucler sur les lignes</li>
<li>Utiliser les fonctionnalitÃ©s trÃ¨s pratiques de <code>Pandas</code></li>
</ul>
<p>Nous privilÃ©gierons la deuxiÃ¨me approche, plus naturelle quand on utilise des <code>DataFrames</code> et plus efficace puisquâ€™elle est nativement intÃ©grÃ©e Ã  <code>Pandas</code>.</p>
<p>La syntaxe prend la forme suivante :</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data.replace({variable: dict_rules_replacement}, regex<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Câ€™est celle qui est implÃ©mentÃ©e dans la fonction <em>ad hoc</em> du script <code>utils/preprocess_openfood.py</code>. Cette derniÃ¨re sâ€™utilise de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.utils_ddc <span class="im">import</span> replace_values_ean</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.preprocess_openfood <span class="im">import</span> clean_column_dataset</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> clean_column_dataset(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        openfood, replace_values_ean,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici quelques cas oÃ¹ notre nettoyage de donnÃ©es a modifiÃ© le nom du produit :</p>
<div class="cell" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(openfood</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    .dropna(subset <span class="op">=</span> [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    .loc[</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        openfood[<span class="st">"product_name"</span>].<span class="bu">str</span>.upper() <span class="op">!=</span> openfood[<span class="st">"preprocessed_labels"</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On peut remarquer que pour aller plus loin et amÃ©liorer la normalisation des champs, il serait pertinent dâ€™appliquer un certain nombre de nettoyages supplÃ©mentaires, comme le retrait des mots de liaison (<em>stop words</em>). Des exemples de ce type de nettoyages sont prÃ©sents dans le <a href="https://pythonds.linogaliana.fr/nlpintro/">cours de <code>Python</code> de lâ€™ENSAE</a>.</p>
<p>Cela est laissÃ© comme exercice aux voies ğŸ”´ et âš«.</p>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Normaliser les champs textuels (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser <code>NLTK</code> ou <code>SpaCy</code> (solution prÃ©fÃ©rable) pour ajouter des nettoyages de champs textuels</p>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<p>On peut maintenant se tourner vers la classification Ã  proprement parler. Pour celle-ci, on propose dâ€™utiliser un modÃ¨le qui a Ã©tÃ© entrainÃ© avec la librairie <a href="https://fasttext.cc/"><code>Fasttext</code></a>. Voici comment rÃ©cupÃ©rer le modÃ¨le et le tester sur un exemple trÃ¨s basique:</p>
<div class="cell" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> download_pb</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fasttext</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(<span class="st">"fasttext_coicop.bin"</span>) <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    download_pb(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> config[<span class="st">"URL_FASTTEXT_MINIO"</span>],</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="st">"fasttext_coicop.bin"</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> fasttext.load_model(<span class="st">"fasttext_coicop.bin"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>model.predict(<span class="st">"RATATOUILLE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Le rÃ©sultat est peu intelligible. En effet, cela demande une bonne connaissance de la COICOP pour savoir de maniÃ¨re intuitive que cela correspond Ã  la catÃ©gorie <a href="https://www.insee.fr/fr/statistiques/serie/001764476"><em>â€œAutres plats cuisinÃ©s Ã  base de lÃ©gumesâ€</em></a>.</p>
<p>Avant de gÃ©nÃ©raliser le classifieur Ã  lâ€™ensemble de nos donnÃ©es, on se propose donc de rÃ©cupÃ©rer les noms des COICOP depuis le site <a href="https://www.insee.fr/fr/metadonnees/coicop2016/division/01?champRecherche=true">insee.fr</a>. Comme cela ne prÃ©sente pas de dÃ©fi majeur, le code est directement proposÃ©, quelle que soit la voie empruntÃ©e:</p>
<div class="cell" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> import_coicop_labels(url: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> pd.read_excel(url, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    coicop[<span class="st">'Code'</span>] <span class="op">=</span> coicop[<span class="st">'Code'</span>].<span class="bu">str</span>.replace(<span class="st">"'"</span>, <span class="st">""</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> coicop.rename({<span class="st">"LibellÃ©"</span>: <span class="st">"category"</span>}, axis <span class="op">=</span> <span class="st">"columns"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coicop</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Verification de la COICOP rencontrÃ©e plus haut</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>coicop.loc[coicop[<span class="st">"Code"</span>].<span class="bu">str</span>.contains(<span class="st">"01.1.7.3.2"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Maintenant nous avons tous les ingrÃ©dients pour gÃ©nÃ©raliser notre approche. Lâ€™application en sÃ©rie de prÃ©dictions via <code>Fasttext</code> Ã©tant un peu fastidieuse et peu Ã©lÃ©gante (elle nÃ©cessite dâ€™Ãªtre Ã  lâ€™aise avec les listes <code>Python</code>) et nâ€™Ã©tant pas le centre de notre sujet, la fonction suivante est fournie pour effectuer cette opÃ©ration :</p>
<div class="cell" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_predict_coicop(data, model, product_column: <span class="bu">str</span> <span class="op">=</span> <span class="st">"preprocessed_labels"</span>, output_column: <span class="bu">str</span> <span class="op">=</span> <span class="st">"coicop"</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> pd.DataFrame(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        output_column: <span class="op">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            [k[<span class="dv">0</span>] <span class="cf">for</span> k <span class="kw">in</span> model.predict(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                [<span class="bu">str</span>(libel) <span class="cf">for</span> libel <span class="kw">in</span> data[product_column]], k <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                )[<span class="dv">0</span>]]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    data[output_column] <span class="op">=</span> predictions[output_column].<span class="bu">str</span>.replace(<span class="vs">r'__label__'</span>, <span class="st">''</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> model_predict_coicop(openfood, model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="bis-version-alternative-via-lapi-predicat" class="level2">
<h2 class="anchored" data-anchor-id="bis-version-alternative-via-lapi-predicat">1.3.bis Version alternative via lâ€™API <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Lâ€™utilisation dâ€™API pour accÃ©der Ã  des donnÃ©es devient de plus en plus frÃ©quente. Si vous Ãªtes peu familiers avec les API, vous pouvez consulter ce <a href="https://pythonds.linogaliana.fr/api/">chapitre du cours de <code>Python</code> de lâ€™ENSAE</a> ou de la documentation <a href="https://www.book.utilitr.org/03_fiches_thematiques/fiche_api"><code>utilitR</code> (langage <code>R</code>)</a></p>
<p>Les API peuvent servir Ã  faire beaucoup plus que rÃ©cupÃ©rer des donnÃ©es. Elles sont notamment de plus en plus utilisÃ©es pour rÃ©cupÃ©rer des prÃ©dictions dâ€™un modÃ¨le. La plateforme <a href="https://huggingface.co/"><code>HuggingFace</code></a> est trÃ¨s apprÃ©ciÃ©e pour cela: elle a grandement facilitÃ© la rÃ©utilisation de modÃ¨les mis en disposition en <em>open source</em>. Cette approche a principalement deux avantages:</p>
<ul>
<li>Elle permet dâ€™appliquer sur les donnÃ©es fournies en entrÃ©e exactement les mÃªmes prÃ©-traitement que sur les donnÃ©es dâ€™entrainement. Ceci renforce la fiabilitÃ© des prÃ©dictions.</li>
<li>Elle facilite le travail des <em>data scientists</em> ou statisticiens car ils ne sont plus obligÃ©s de mettre en place des fonctions compliquÃ©es pour passer les prÃ©dictions dans une colonne de <code>DataFrame</code>.</li>
</ul>
<p>Ici, nous proposons de tester une API mise Ã  disposition de maniÃ¨re expÃ©rimentale pour faciliter la rÃ©utilisation de notre modÃ¨le de classification dans la nomenclature COICOP.</p>
<p>Cette API sâ€™appelle <code>predicat</code> et son code source est disponible sur <a href="https://github.com/InseeFrLab/predicat"><code>Github</code></a>.</p>
<p>Pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ, nous suggÃ©rons de se cantonner Ã  tester quelques exemples. Pour les parcours ğŸ”´ et âš« qui voudraient se tester sur les API, nous proposons de gÃ©nÃ©raliser ces appels Ã  <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> pour classifier toutes nos donnÃ©es.</p>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Consommer un modÃ¨le sous forme d'API (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Appliquer lâ€™API <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> en sÃ©rie pour catÃ©goriser lâ€™ensemble des donnÃ©es</p>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<p>Voici, pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ, un exemple dâ€™utilisation:</p>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_from_api(product_name):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    url_api <span class="op">=</span> <span class="ss">f"https://api.lab.sspcloud.fr/predicat/label?k=1&amp;q=%27</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">%27"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    output_api_predicat <span class="op">=</span> requests.get(url_api).json()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    coicop_found <span class="op">=</span> output_api_predicat[<span class="st">'coicop'</span>][<span class="ss">f"'</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">'"</span>][<span class="dv">0</span>][<span class="st">'label'</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coicop_found</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>predict_from_api(<span class="st">"Ratatouille"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour le parcours ğŸ”µ, voici un exercice pour tester sur un Ã©chantillon des donnÃ©es de lâ€™<code>OpenFoodFacts</code></p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Consommer un modÃ¨le sous forme d'API (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://github.com/InseeFrLab/predicat/blob/master/help/example-request.ipynb">ce <em>notebook</em></a>, tester lâ€™API sur une centaine de noms de produits pris alÃ©atoirement (ceux avant <em>preprocessing</em>).</p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
</section>
<section id="ter-entrainer-son-propre-classifieur" class="level2">
<h2 class="anchored" data-anchor-id="ter-entrainer-son-propre-classifieur">1.3.ter Entrainer son propre classifieur (ğŸ”´,âš«)</h2>
<p>Les grimpeurs des voies ğŸ”´ et âš« sont encouragÃ©s Ã  essayer dâ€™entraÃ®ner eux-mÃªmes un modÃ¨le de classification.</p>
<div class="cell markdown">
<!----- boite ğŸ”´, âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Entrainer son propre modÃ¨le de classification (ğŸ”´, âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://github.com/InseeFrLab/predicat/blob/master/help/example-request.ipynb">ce <em>notebook</em></a>, tester lâ€™API sur une centaine de noms de produits pris alÃ©atoirement (ceux avant <em>preprocessing</em>). Lâ€™apprentissage peut Ãªtre fait Ã  partir de la variable <code>category</code> disponible sur <code>OpenFoodFacts</code>.</p>
<p>Voici la consigne:</p>
<ul>
<li>ğŸ”´ : utiliser <code>fasttext</code></li>
<li>âš« : libertÃ© sur le <em>framework</em> utilisÃ©</li>
</ul>
</details>
</div>
<!----- end ğŸ”´, âš« ----->
</div>
</section>
<section id="ecriture-de-la-base-sur-lespace-de-stockage-distant" class="level2">
<h2 class="anchored" data-anchor-id="ecriture-de-la-base-sur-lespace-de-stockage-distant">1.4. Ecriture de la base sur lâ€™espace de stockage distant</h2>
<p>Le fait dâ€™avoir effectuÃ© en amont ce type dâ€™opÃ©ration permettra dâ€™Ã©conomiser du temps par la suite puisquâ€™on sâ€™Ã©vite des calculs Ã  la volÃ©e coÃ»teux en performance (rien de pire quâ€™une page <em>web</em> qui rame non ?).</p>
<p>Pour facilement retrouver ces donnÃ©es, on propose de les Ã©crire dans un espace de stockage accessible facilement. Pour cela, nous proposons dâ€™utiliser celui du <code>SSP Cloud</code> pour les personnes ayant un compte dessus. Pour les personnes nâ€™ayant pas de compte sur le <code>SSP Cloud</code>, vous pouvez passer cette Ã©tape et rÃ©utiliser le jeu de donnÃ©es que nous proposons pour la suite de ce parcours.</p>
<p>Nous proposons ici dâ€™utiliser le package <code>s3fs</code> qui est assez pratique pour traiter un espace distant comme on ferait dâ€™un espace de stockage local. Pour en apprendre plus sur le systÃ¨me de stockage <code>S3</code> (la technologie utilisÃ©e par le SSP Cloud) ou sur le format <code>Parquet</code>, vous pouvez consulter ce chapitre du <a href="https://pythonds.linogaliana.fr/reads3/">cours de <code>Python</code> de lâ€™ENSAE</a></p>
<p>La premiÃ¨re Ã©tape consiste Ã  initialiser la connexion (crÃ©er un <em>file system</em> distant, via <code>s3fs.S3FileSystem</code>, qui pointe vers lâ€™espace de stockage du SSP Cloud). La deuxiÃ¨me ressemble beaucoup Ã  lâ€™Ã©criture dâ€™un fichier en local, il y a seulement une couche dâ€™abstraction supplÃ©mentaire avec <code>fs.open</code>:</p>
<div class="cell" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>DESTINATION_OPENFOOD <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/openfood.parquet"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialisation de la connexion</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: config[<span class="st">"ENDPOINT_S3"</span>]}</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(DESTINATION_OPENFOOD, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    openfood.to_parquet(file_location)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>BUCKET</code> dans le fichier <code>config.yaml</code> pour que cette commande fonctionne</strong>.</p>
<p>Enfin, pour rendre ce fichier accessible Ã  votre future application, il est nÃ©cessaire dâ€™Ã©diter la cellule ci-dessous pour remplacer <code>&lt;USERNAME_SSPCLOUD&gt;</code> par votre nom dâ€™utilisateur sur le <code>SSPCloud</code> puis dâ€™exÃ©cuter la cellule suivante:</p>
<div class="cell" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mc anonymous <span class="bu">set</span> download s3<span class="op">/&lt;</span>USERNAME_SSPCLOUD<span class="op">&gt;/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>qui rend ce fichier public.</p>
<p>Le fichier sera ainsi disponible en tÃ©lÃ©chargement directement depuis un URL de la forme:</p>
<blockquote class="blockquote">
<p>https://minio.lab.sspcloud.fr/<username_sspcloud>/2023/sujet4/diffusion/openfood.parquet</username_sspcloud></p>
</blockquote>
</section>
</section>
<section id="faire-des-statistiques-agrÃ©gÃ©es-par-catÃ©gories" class="level1">
<h1>2ï¸âƒ£ Faire des statistiques agrÃ©gÃ©es par catÃ©gories</h1>
<p>Cette partie permet de calculer en amont de lâ€™application des statistiques descriptives qui pourront Ãªtre utilisÃ©es par celle-ci.</p>
<p>Il est prÃ©fÃ©rable de minimiser la quantitÃ© de calculs faits Ã  la volÃ©e dans le cadre dâ€™une application. Sinon, le risque est une latence embÃªtante pour lâ€™utilisateur voire un crash du serveur Ã  cause de besoins de ressources trop importants.</p>
<p>Cette partie propose ainsi de crÃ©er en avance une base de donnÃ©es synthÃ©tisant le nombre de produits dans une catÃ©gorie donnÃ©e (par exemple les fromages Ã  pÃ¢te crue) qui partagent la mÃªme note. Cela nous permettra dâ€™afficher des statistiques personnalisÃ©es sur les produits similaires Ã  celui quâ€™on scanne.</p>
<section id="prÃ©liminaires" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©liminaires">2.1. PrÃ©liminaires (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Sur le plan technique, cette partie propose deux cadres de manipulation de donnÃ©es diffÃ©rents, selon le balisage de la voie:</p>
<ul>
<li>ğŸŸ¡,ğŸŸ¢,ğŸ”µ: utilisation de <code>Pandas</code></li>
<li>ğŸ”´,âš«: requÃªtes SQL directement sur le fichier <code>Parquet</code> grÃ¢ce Ã  <code>DuckDB</code></li>
</ul>
<p>La deuxiÃ¨me approche permet de mettre en oeuvre des calculs plus efficaces (<code>DuckDB</code>) est plus rapide mais nÃ©cessite un peu plus dâ€™expertise sur la manipulation de donnÃ©es, notamment des connaissances en SQL.</p>
<p>Cette partie va fonctionner en trois temps:</p>
<ol type="1">
<li>Lecture des donnÃ©es <code>OpenFoodFacts</code> prÃ©cÃ©demment produites</li>
<li>Construction de statistiques descriptives standardisÃ©es</li>
<li>Construction de graphiques Ã  partir de ces statistiques descriptives</li>
</ol>
<p>Les Ã©tapes 1 et 2 sont sÃ©parÃ©es conceptuellement pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ. Pour les parcours ğŸ”´ et âš«, lâ€™utilisation de requÃªtes SQL fait que ces deux Ã©tapes conceptuelles sont intriquÃ©es. Les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ peuvent observer les morceaux de code proposÃ©s dans le cadre ğŸ”´ et âš«, câ€™est assez instructif. Lâ€™Ã©tape 3 (production de graphiques) sera la mÃªme pour tous les parcours.</p>
<div class="cell markdown">
<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #ffc10780;">
<h3 class="alert-heading anchored"><i class="fa fa-lightbulb-o"></i> Hint</h3>
<p>Cette partie peut Ãªtre faite sans avoir suivie la prÃ©cÃ©dente. Il est alors recommandÃ© dâ€™effectuer deux actions:</p>
<ol type="1">
<li>Dans le fichier <code>config.yaml</code>, remplacer <code>"projet-funathon"</code> par votre nom dâ€™utilisateur sur le <code>SSP Cloud</code></li>
<li>CrÃ©er une cellule en copiant-collant le texte suivant et en remplacant <code>&lt;USERNAME_SSPCLOUD&gt;</code> par votre nom dâ€™utilisateur sur le SSPCloud.</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># crÃ©er une cellule de code et copier dedans ce texte</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remplacer `&lt;USERNAME_SSPCLOUD&gt;` par votre nom d'utilisateur sur le SSPCloud</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mc cp s3<span class="op">/</span>projet<span class="op">-</span>funathon<span class="op">/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion<span class="op">/</span>openfood.parquet s3<span class="op">/&lt;</span>USERNAME_SSPCLOUD<span class="op">&gt;/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion<span class="op">/</span>openfood.parquet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>USERNAME_SSPCLOUD</code> pour que cette commande fonctionne</strong>.</p>
<p>Cette commande permet de copier le fichier dâ€™exemple que nous avons mis Ã  disposition vers votre espace personnel.</p>
</div>
</div>
<p>Nous proposons dâ€™importer Ã  nouveau nos configurations:</p>
<div class="cell" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Les colonnes suivantes nous seront utiles dans cette partie:</p>
<div class="cell" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>principales_infos <span class="op">=</span> [<span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici, Ã  nouveau, la configuration pour permettre Ã  <code>Python</code> de communiquer avec lâ€™espace de stockage distant:</p>
<div class="cell" data-execution_count="37">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>INPUT_OPENFOOD <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/openfood.parquet"</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialisation de la connexion</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: config[<span class="st">"ENDPOINT_S3"</span>]}</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas" class="level2">
<h2 class="anchored" data-anchor-id="import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas">2.2. Import des donnÃ©es depuis lâ€™espace de stockage distant avec <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ)</h2>
<p>Il est recommandÃ© pour les parcours ğŸŸ¡, ğŸŸ¢, ğŸ”µ de travailler avec <code>Pandas</code> pour construire des statistiques descriptives. Cela se fera en deux Ã©tapes:</p>
<ul>
<li>Import des donnÃ©es directement depuis lâ€™espace de stockage, sans Ã©criture intermÃ©diaire sur le disque local, puis nettoyage de celles-ci ;</li>
<li>Construction de fonctions standardisÃ©es pour la production de statistiques descriptives.</li>
</ul>
<section id="import-et-nettoyage-des-donnÃ©es-openfoodfacts-et" class="level3">
<h3 class="anchored" data-anchor-id="import-et-nettoyage-des-donnÃ©es-openfoodfacts-et">Import et nettoyage des donnÃ©es <code>OpenFoodFacts</code> (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</h3>
<p>Il est possible de lire un CSV de plusieurs maniÃ¨res avec <code>Python</code>. Lâ€™une dâ€™elle se fait Ã  travers le <em><a href="https://book.pythontips.com/en/latest/context_managers.html#context-managers">context manager</a></em>. Le module <code>s3fs</code> permet dâ€™utiliser ce <em>context manager</em> pour lire un fichier distant, de maniÃ¨re trÃ¨s similaire Ã  la lecture dâ€™un fichier local.</p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es depuis un espace distant (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir du <em>context manager</em> intÃ©grÃ© Ã  <code>s3fs</code>, lire les donnÃ©es en suivant les consignes suivantes:</p>
<ul>
<li>la localisation des donnÃ©es est stockÃ©e dans la variable <code>INPUT_OPENFOOD</code></li>
<li>Utiliser lâ€™option <code>columns = principales_infos + indices_synthetiques</code> pour nâ€™importer que les variables nÃ©cessaires.</li>
</ul>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es depuis un espace distant (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Lors de lâ€™Ã©criture du fichier nous avons utilisÃ© la commande suivante:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(DESTINATION_OPENFOOD, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    openfood.to_parquet(file_location)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nous proposons de suivre la mÃªme logique en changeant quelques Ã©lÃ©ments:</p>
<ul>
<li>La variable de chemin Ã  utiliser ici est <code>INPUT_OPENFOOD</code> ;</li>
<li>Le contexte nâ€™est plus Ã  lâ€™Ã©criture (<em>â€œwbâ€</em>) mais Ã  la lecture (<em>â€œrbâ€</em>) ;</li>
<li>La commande Ã  exÃ©cuter dans ce contexte nâ€™est plus lâ€™Ã©criture dâ€™un fichier parquet mais <code>pd.read_parquet</code>. Utiliser lâ€™option <code>columns = principales_infos + indices_synthetiques</code> pour nâ€™importer que les variables nÃ©cessaires.</li>
</ul>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div id="get-openfood-parquet-2" class="cell yellow-code" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># methode 1: pandas</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(INPUT_OPENFOOD, <span class="st">"rb"</span>) <span class="im">as</span> remote_file:</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    openfood <span class="op">=</span> pd.read_parquet(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        remote_file,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        columns <span class="op">=</span> principales_infos <span class="op">+</span> <span class="op">\</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        indices_synthetiques</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Les donnÃ©es ont ainsi lâ€™aspect suivant:</p>
<div class="cell" data-execution_count="41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>openfood.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="statistiques-descriptives-et" class="level2">
<h2 class="anchored" data-anchor-id="statistiques-descriptives-et">2.3. Statistiques descriptives (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</h2>
<p>On dÃ©sire calculer pour chaque classe de produits - par exemple les boissons rafraichissantes - le nombre de produits qui partagent une mÃªme note pour chaque indicateur de qualitÃ© nutritionnelle ou environnementale.</p>
<p>Nous allons utiliser le <code>DataFrame</code> suivant pour les calculs de notes:</p>
<div class="cell" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>openfood_notes <span class="op">=</span> openfood.loc[:,[<span class="st">"coicop"</span>] <span class="op">+</span> indices_synthetiques]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Pour chaque valeur de la variable <code>coicop</code>, avec la mÃ©thode <code>agg</code>, effectuer un dÃ©compte des notes (<code>value_counts</code> en <code>Pandas</code>) pour chaque variable de la liste <code>indices_synthetiques</code> grÃ¢ce Ã  la mÃ©thode <code>agg</code>. Renommer ensuite les deux variables dâ€™index â€˜coicopâ€™ et â€˜noteâ€™ grÃ¢ce Ã  la mÃ©thode <code>reset_index</code></p></li>
<li><p>Pivoter les donnÃ©es vers un format <em>long</em> via les axes <code>coicop</code> et <code>note</code></p></li>
<li><p>DÃ©dupliquer les donnÃ©es en ne gardant que les paires uniques sur les variables <code>variable, note, coicop</code></p></li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>AprÃ¨s un <code>groupby("coicop")</code>, effectuer un dÃ©compte des notes (<code>value_counts</code> en <code>Pandas</code>) pour chaque variable de la liste <code>indices_synthetiques</code> grÃ¢ce Ã  la mÃ©thode <code>agg</code> puis renommer les deux variables dâ€™index â€˜coicopâ€™ et â€˜noteâ€™ grÃ¢ce Ã  la mÃ©thode <code>reset_index</code></li>
</ol>
<details>
<summary>RÃ©ponse en cas de difficultÃ©</summary>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> (</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    openfood_notes</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"coicop"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    .agg({i:<span class="st">'value_counts'</span> <span class="cf">for</span> i <span class="kw">in</span> indices_synthetiques})</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    .reset_index(names<span class="op">=</span>[<span class="st">'coicop'</span>, <span class="st">'note'</span>])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<ol start="2" type="1">
<li><p>Utiliser <code>pd.melt</code> pour pivoter les donnÃ©es vers un format <em>long</em> via les axes <code>coicop</code> et <code>note</code></p></li>
<li><p>DÃ©dupliquer les donnÃ©es en ne gardant que les paires uniques sur les variables <code>variable, note, coicop</code> grÃ¢ce Ã  la mÃ©thode <code>drop_duplicates</code></p></li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell" data-execution_count="45">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_stats_grades(data, indices_synthetiques):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> (</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        data</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"coicop"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        .agg({i:<span class="st">'value_counts'</span> <span class="cf">for</span> i <span class="kw">in</span> indices_synthetiques})</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        .reset_index(names<span class="op">=</span>[<span class="st">'coicop'</span>, <span class="st">'note'</span>])</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> pd.melt(stats_notes, id_vars <span class="op">=</span> [<span class="st">'coicop'</span>,<span class="st">'note'</span>])</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> stats_notes.dropna().drop_duplicates(subset <span class="op">=</span> [<span class="st">'variable'</span>,<span class="st">'note'</span>,<span class="st">'coicop'</span>])</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    stats_notes[<span class="st">'value'</span>] <span class="op">=</span> stats_notes[<span class="st">'value'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats_notes</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> compute_stats_grades(openfood_notes, indices_synthetiques)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="import-et-traitement-des-donnÃ©es-avec-duckdb-et" class="level2">
<h2 class="anchored" data-anchor-id="import-et-traitement-des-donnÃ©es-avec-duckdb-et">2.4. Import et traitement des donnÃ©es avec <code>DuckDB</code> (ğŸ”´ et âš«)</h2>
<p>Cette partie propose pour les parcours ğŸ”´ et âš« de reproduire lâ€™analyse faite par les parcours ğŸŸ¡,ğŸŸ¢ et ğŸ”µ via <code>Pandas</code>.</p>
<p><code>DuckDB</code> va Ãªtre utilisÃ© pour lire et agrÃ©ger les donnÃ©es. Pour lire directement depuis un systÃ¨me de stockage distant, sans prÃ©-tÃ©lÃ©charger les donnÃ©es, vous pouvez utiliser la configuration suivante de <code>DuckDB</code>:</p>
<div class="cell" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">    INSTALL httpfs;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="st">    LOAD httpfs;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Et voici un exemple minimal de lecture de donnÃ©es Ã  partir du chemin <code>INPUT_OPENFOOD</code> dÃ©fini prÃ©cÃ©demment.</p>
<div class="cell" data-execution_count="47">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>duckdb_data <span class="op">=</span> con.sql(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"SELECT product_name, preprocessed_labels, coicop, energy_100g FROM read_parquet('s3://</span><span class="sc">{</span>INPUT_OPENFOOD<span class="sc">}</span><span class="ss">') LIMIT 10"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>duckdb_data.df() <span class="co">#conversion en pandas dataframe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Nous proposons de crÃ©er une unique requÃªte SQL qui, dans une clause <code>SELECT</code>, pour chaque classe de produit (notre variable de COICOP), compte le nombre de produits qui partagent une mÃªme note.</p>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ul>
<li>CrÃ©er une fonction <code>count_one_variable_sql</code> prenant un argument nommÃ© <code>con</code> (connexion DuckDB), un argument <code>variable</code> (par dÃ©faut Ã©gal Ã  <code>nova_group</code>) et un chemin de lecture des donnÃ©es dans le systÃ¨me <code>S3</code>. Cette fonction agrÃ¨ge calcule la statistique descriptive dÃ©sirÃ©e pour <code>variable</code>.</li>
<li>CrÃ©er le <code>DataFrame</code> qui combine toutes ces statistiques pour les variables <code>["nutriscore_grade", "ecoscore_grade", "nova_group"]</code>. Celui-ci comporte quatre variables: <code>coicop</code>, <code>note</code>, <code>value</code> et <code>variable</code>.</li>
</ul>
</details>
</div>
<!----- end âš« ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction <code>count_one_variable_sql</code> prenant un argument nommÃ© <code>con</code> (connexion DuckDB), un argument <code>variable</code> (par dÃ©faut Ã©gal Ã  <code>nova_group</code>) et un chemin de lecture des donnÃ©es dans le systÃ¨me <code>S3</code>.</p>
<p>Cette fonction effectue les opÃ©rations suivantes:</p>
<ul>
<li>CrÃ©er un <code>DataFrame</code> <code>Pandas</code> aprÃ¨s avoir agrÃ©gÃ© les donnÃ©es via <code>DuckDB</code> grÃ¢ce au modÃ¨le de requÃªte</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f"SELECT coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss"> AS note, COUNT(</span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">) AS value FROM read_parquet('s3://</span><span class="sc">{</span>path_within_s3<span class="sc">}</span><span class="ss">') GROUP BY coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>CrÃ©e une variable <code>variable</code> Ã©gale Ã  la valeur de lâ€™argument <code>variable</code></p></li>
<li><p>CrÃ©er le <code>DataFrame</code> qui combine toutes ces statistiques de la maniÃ¨re suivante en appliquant la fonction de maniÃ¨re rÃ©pÃ©tÃ©e :</p></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> [<span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span>]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> [count_one_variable_sql(con, note, INPUT_OPENFOOD) <span class="cf">for</span> note <span class="kw">in</span> grades]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> pd.concat(stats_notes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell" data-execution_count="50">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution Ã  la voie ğŸ”´ et âš« pour les curieux de la voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_one_variable_sql(con, variable, path_within_s3 <span class="op">=</span> <span class="st">"temp.parquet"</span>):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="ss">f"SELECT coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss"> AS note, COUNT(</span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">) AS value FROM read_parquet('s3://</span><span class="sc">{</span>path_within_s3<span class="sc">}</span><span class="ss">') GROUP BY coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    stats_one_variable <span class="op">=</span> con.sql(query).df().dropna()</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    stats_one_variable[<span class="st">'variable'</span>] <span class="op">=</span> variable</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats_one_variable</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> [<span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span>]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> [count_one_variable_sql(con, note, INPUT_OPENFOOD) <span class="cf">for</span> note <span class="kw">in</span> grades]</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> pd.concat(stats_notes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Ceci nous donne donc le <code>DataFrame</code> suivant:</p>
<div class="cell" data-execution_count="51">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>stats_notes_sql.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="sauvegarde-dans-lespace-de-stockage-distant" class="level2">
<h2 class="anchored" data-anchor-id="sauvegarde-dans-lespace-de-stockage-distant">2.5. Sauvegarde dans lâ€™espace de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Ces statistiques descriptives sont Ã  Ã©crire dans lâ€™espace de stockage distant pour ne plus avoir Ã  les calculer.</p>
<div class="cell" data-execution_count="52">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_stats_to_s3(data, destination):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> fs.<span class="bu">open</span>(destination, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        data.to_parquet(file_location)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>write_stats_to_s3(stats_notes, <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/stats_notes_pandas.parquet"</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>write_stats_to_s3(stats_notes_sql, <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/stats_notes_sql.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>BUCKET</code> dans le fichier <code>config.yaml</code> pour que cette commande fonctionne</strong>.</p>
</section>
<section id="crÃ©ation-dun-modÃ¨le-de-graphiques" class="level2">
<h2 class="anchored" data-anchor-id="crÃ©ation-dun-modÃ¨le-de-graphiques">2.6. CrÃ©ation dâ€™un modÃ¨le de graphiques (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>On va utiliser <code>Plotly</code> pour crÃ©er des graphiques et, ultÃ©rieurement, les afficher sur notre page web. Cela permettra dâ€™avoir un peu de rÃ©activitÃ©, câ€™est lâ€™intÃ©rÃªt de faire un format <em>web</em> plutÃ´t quâ€™une publication figÃ©e comme un <code>PDF</code>.</p>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction standardisÃ©e dont lâ€™<em>output</em> est un objet <code>Plotly</code> respectant le cahier des charges suivant, pour chaque classe de produit :</p>
<ul>
<li>Diagramme en barre prÃ©sentant le nombre de produits ayant telle ou telle note</li>
<li>PrÃ©voir un argument pour mettre en surbrillance une valeur donnÃ©e (par exemple la note <code>B</code>).</li>
<li>PrÃ©voir un argument pour le titre du graphique</li>
</ul>
</details>
</div>
<!----- end âš« ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction standardisÃ©e dont les arguments sont</p>
<ul>
<li>Un jeu de donnÃ©es nommÃ© <code>data</code></li>
<li>Une caractÃ©ristique nutritionnelle nommÃ©e <code>variable_note</code> par dÃ©faut Ã©gale Ã  <code>nutriscore_grade</code></li>
<li>Une catÃ©gorie nommÃ©e <code>coicop</code>, par dÃ©faut Ã©gale Ã  <code>01.1.7.3.2</code></li>
<li>Une note pour le produit dans une variable nommÃ©e <code>note_produit</code> par dÃ©faut Ã©gal Ã  <code>B</code></li>
<li>Un titre par dÃ©faut Ã©gal Ã  <code>Nutriscore</code></li>
</ul>
<p>Cette fonction effectue les tÃ¢ches suivantes:</p>
<ul>
<li>Ne conserver, dans notre ensemble de valeurs agrÃ©gÃ©es, que celles relatives Ã  la COICOP et Ã  la caractÃ©ristique nutritionnelle quâ€™on recherche ;</li>
<li>ReprÃ©senter sous forme de diagramme en barre les valeurs nutritionnelles pour chaque dÃ©cile de la distribution avec, en rouge, celle de notre produit (<code>valeur_produit</code>)</li>
<li>Nâ€™hÃ©sitez pas Ã  utiliser les options de <code>Plotly</code> pour personnaliser la figure</li>
</ul>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour prÃ©parer cet exercice, crÃ©er les objets suivants:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> stats_nutritionnelles.copy()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>note_produit <span class="op">=</span> <span class="st">"B"</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>titre <span class="op">=</span> <span class="st">"Nutriscore"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>Ne conserver que les observations oÃ¹ <code>data['variable']</code> est Ã©gale Ã  la valeur <code>variable_note</code> et oÃ¹ la variable <code>coicop</code> est Ã©gale Ã  la valeur <code>coicop</code>. A lâ€™issue de ces filtres, nommer le dataframe obtenu <code>example_coicop</code></li>
<li>CrÃ©er une colonne stockant les couleurs de notre graphique. Nommer cette variable <code>color</code>.</li>
<li>CrÃ©er un diagramme en barre avec: + sur lâ€™axe des <em>x</em> les quantiles + sur lâ€™axe des <em>y</em>, la valeur Ã  reprÃ©senter + la couleur Ã  partir de la variable <code>color</code> + Les <em>labels</em> : pour lâ€™axe des <em>x</em> ne rien mettre et pour lâ€™axe des <em>y</em> : <em>â€œNoteâ€</em> + Masquer la lÃ©gende + Le titre Ã  partir de la variable <code>titre</code></li>
<li>Encapsuler ce code dans une fonction nommÃ©e <code>figure_infos_notes</code> dont les arguments sont les variables prÃ©cÃ©demment crÃ©es.</li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour prÃ©parer cet exercice, crÃ©er les objets suivants:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> stats_nutritionnelles.copy()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>note_produit <span class="op">=</span> <span class="st">"B"</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>titre <span class="op">=</span> <span class="st">"Nutriscore"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>Utiliser la mÃ©thode <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.loc.html"><code>loc</code></a> pour ne conserver que les observations oÃ¹ <code>data['variable']</code> est Ã©gale Ã  la valeur <code>variable_note</code> et oÃ¹ la variable <code>coicop</code> est Ã©gale Ã  la valeur <code>coicop</code> (quâ€™on a fixÃ© Ã  <code>"01.1.7.3.2"</code>). A lâ€™issue de ces filtres, nommer le dataframe obtenu <code>example_coicop</code></li>
<li>Utiliser <a href="https://numpy.org/doc/stable/reference/generated/numpy.where.html"><code>np.where</code></a> pour crÃ©er une colonne stockant les couleurs de notre graphique. On utilisera le rouge (<em>red</em>) lorsque la variable quantile est Ã©gale Ã  <code>note_produit</code> et du bleu (<em>royalblue</em>) sinon. Nommer cette variable <code>color</code>.</li>
<li>CrÃ©er un diagramme en barre avec: + sur lâ€™axe des <em>x</em> les notes (stockÃ©s dans la variable <code>note</code>) + sur lâ€™axe des <em>y</em>, la valeur Ã  reprÃ©senter (stockÃ©e dans la variable <code>value</code>) + la couleur Ã  partir de la variable <code>color</code> + Les <em>labels</em> : pour lâ€™axe des <em>x</em> ne rien mettre et pour lâ€™axe des <em>y</em> : <em>â€œNoteâ€</em> + Masquer la lÃ©gende via lâ€™argument <code>showlegend</code> de la mÃ©thode <code>update_layout</code> + Le titre Ã  partir de la variable <code>titre</code></li>
<li>Encapsuler ce code dans une fonction nommÃ©e <code>figure_infos_nutritionnelles</code> dont les arguments sont <code>data</code>, <code>variable_nutritionnelle = 'nutriscore_grade'</code>, <code>coicop = "01.1.7.3.2"</code> et <code>valeur_produit = "B"</code>.</li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<p>Voici un exemple de fonction qui rÃ©pond aux cahiers des charges ci-dessus:</p>
<div class="cell" data-execution_count="57">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> figure_infos_notes(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    data, variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span>, note_produit <span class="op">=</span> <span class="st">"B"</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">"Nutriscore"</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    example_coicop <span class="op">=</span> data.loc[data[<span class="st">'variable'</span>] <span class="op">==</span> variable_note]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    example_coicop <span class="op">=</span> example_coicop.loc[example_coicop[<span class="st">'coicop'</span>]<span class="op">==</span>coicop]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    example_coicop[<span class="st">'color'</span>] <span class="op">=</span> np.where(example_coicop[<span class="st">'note'</span>] <span class="op">==</span> note_produit, <span class="st">"Note du produit"</span>, <span class="st">"Autres produits"</span>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.bar(</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        example_coicop,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">'note'</span>, y<span class="op">=</span><span class="st">'value'</span>, color <span class="op">=</span> <span class="st">"color"</span>, template <span class="op">=</span> <span class="st">"simple_white"</span>,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span>title,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        color_discrete_map<span class="op">=</span>{<span class="st">"Note produit"</span>: <span class="st">"red"</span>, <span class="st">"Autres produits"</span>: <span class="st">"royalblue"</span>},</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>{</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"note"</span>: <span class="st">"Note"</span>,</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"value"</span>: <span class="st">""</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    fig.update_xaxes(</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        categoryorder<span class="op">=</span><span class="st">'array'</span>,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        categoryarray<span class="op">=</span> [<span class="st">'A'</span>, <span class="st">'B'</span>, <span class="st">'C'</span>, <span class="st">'D'</span>, <span class="st">'E'</span>])</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(showlegend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(hovermode<span class="op">=</span><span class="st">"x"</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    fig.update_traces(</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        hovertemplate<span class="op">=</span><span class="st">"&lt;br&gt;"</span>.join([</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Note %</span><span class="sc">{x}</span><span class="st">"</span>,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>variable_note<span class="sc">}</span><span class="ss">: "</span> <span class="op">+</span><span class="st">" %</span><span class="sc">{y}</span><span class="st"> produits"</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici un exemple dâ€™utilisation</p>
<div class="cell" data-execution_count="58">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.construct_figures <span class="im">import</span> figure_infos_notes</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> figure_infos_notes(stats_notes)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="comparer-un-produit-Ã -un-groupe-similaire" class="level1">
<h1>3ï¸âƒ£ Comparer un produit Ã  un groupe similaire</h1>
<p>Tout ce travail prÃ©liminaire nous permettra dâ€™afficher sur notre application des statistiques propres Ã  chaque catÃ©gorie.</p>
<p>On propose dâ€™utiliser le jeu de donnÃ©es prÃ©parÃ© prÃ©cedemment</p>
<div class="cell" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>principales_infos <span class="op">=</span> [<span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>liste_colonnes <span class="op">=</span> principales_infos <span class="op">+</span> indices_synthetiques</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>liste_colonnes_sql <span class="op">=</span> [<span class="ss">f"</span><span class="ch">\"</span><span class="sc">{</span>s<span class="sc">}</span><span class="ch">\"</span><span class="ss">"</span> <span class="cf">for</span> s <span class="kw">in</span> liste_colonnes]</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>liste_colonnes_sql <span class="op">=</span> <span class="st">', '</span>.join(liste_colonnes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On va aussi utiliser la nomenclature COICOP qui peut Ãªtre importÃ©e via le code ci-dessous:</p>
<div class="cell" data-execution_count="60">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> import_coicop_labels</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="dÃ©tection-de-code-barre" class="level2">
<h2 class="anchored" data-anchor-id="dÃ©tection-de-code-barre">3.1. DÃ©tection de code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>La premiÃ¨re brique de notre application consiste Ã  repÃ©rer un produit par le scan du code-barre. Nous allons partir pour le moment dâ€™un produit dâ€™exemple, ci-dessous:</p>
<p><img src="https://images.openfoodfacts.org/images/products/500/011/260/2791/front_fr.4.400.jpg" class="img-fluid"></p>
<div class="cell" data-execution_count="61">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>url_image <span class="op">=</span> <span class="st">"https://images.openfoodfacts.org/images/products/500/011/260/2791/front_fr.4.400.jpg"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Dans le cadre de notre application, on permettra aux utilisateurs dâ€™<em>uploader</em> la photo dâ€™un produit, ce sera plus <em>fun</em>. En attendant notre application, partir dâ€™un produit standardisÃ© permet dÃ©jÃ  de mettre en oeuvre la logique Ã  rÃ©-appliquer plus tard.</p>
<p>Pour se simplifier la vie, le plus simple pour repÃ©rer un code-barre est dâ€™utiliser le <em>package</em> <a href="https://pypi.org/project/pyzbar/"><code>pyzbar</code></a>. Pour transformer une image en matrice <code>Numpy</code> (lâ€™objet attendu par <a href="https://pypi.org/project/pyzbar/"><code>pyzbar</code></a>), on peut utiliser le module <code>skimage</code> de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skimage <span class="im">import</span> io</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>io.imread(url_image)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>GrÃ¢ce Ã  <code>sklearn.image</code>, on peut utiliser lâ€™URL dâ€™une page web ou le chemin dâ€™un fichier de maniÃ¨re indiffÃ©rente pour la valeur de <code>url_image</code>.</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ğŸ”µğŸ”´ et âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Extraire le code-barre Ã  partir d'une image (ğŸŸ¢ğŸ”µğŸ”´ et âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>AprÃ¨s avoir importÃ© lâ€™image via <code>io.imread</code>, utiliser <code>pyzbar.decode</code> pour extraire les informations voulues, notamment le code-barre.</li>
<li>Si vous avez nommÃ© lâ€™objet gÃ©nÃ©rÃ©, vÃ©rifier le code-barre avec <code>obj[0].data.decode()</code>.</li>
<li>A partir de cela, crÃ©er une fonction <code>extract_ean</code> pour dÃ©coder lâ€™image (en retournant lâ€™objet gÃ©nÃ©rÃ© par <code>pyzbar</code>)</li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ğŸ”µğŸ”´ et âš« ----->
</div>
<div id="get-openfood-parquet" class="cell yellow-code" data-execution_count="64">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyzbar <span class="im">import</span> pyzbar</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_ean(url, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> io.imread(url)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    decoded_objects <span class="op">=</span> pyzbar.decode(img)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> obj <span class="kw">in</span> decoded_objects:</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># draw the barcode</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"detected barcode:"</span>, obj)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print barcode type &amp; data</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Type:"</span>, obj.<span class="bu">type</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Data:"</span>, obj.data)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decoded_objects</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> extract_ean(url_image, verbose <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>obj[<span class="dv">0</span>].data.decode()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On obtient bien un code identifiant notre produit. Il sâ€™agit de lâ€™EAN qui est un identifiant unique, partagÃ© quelque soit le point de vente dâ€™un produit. Il sâ€™agit dâ€™un identifiant prÃ©sent sur tout code-barre, utilisÃ© dans les systÃ¨mes dâ€™information des grandes enseignes mais aussi dans les bases produits qui peuvent Ãªtre utilisÃ©es de maniÃ¨re annexe (par exemple lâ€™<code>OpenFoodFacts</code>).</p>
</section>
<section id="association-dun-code-barre-Ã -un-produit-dopenfoodfacts" class="level2">
<h2 class="anchored" data-anchor-id="association-dun-code-barre-Ã -un-produit-dopenfoodfacts">3.2. Association dâ€™un code barre Ã  un produit dâ€™<code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Maintenant quâ€™on dispose dâ€™un code-barre (le numÃ©ro EAN), on va trouver le produit dans <code>OpenFoodFacts</code> Ã  partir de ce code-barre.</p>
<p>Cependant, comme il peut arriver quâ€™un produit dispose dâ€™informations incomplÃ¨tes, il peut Ãªtre utile de faire non seulement de lâ€™appariement exact (trouver le produit avec le mÃªme code EAN) mais aussi de lâ€™appariement flou (trouver un produit avec un nom proche de celui quâ€™on veut).</p>
<p>Ceci est un exercice pour les parcours ğŸ”´ et âš«, les autres voies pouvant prendre cette fonction comme donnÃ©e.</p>
<p>Pour aller plus loin sur cette question des appariements flous, il pourrait Ãªtre utile dâ€™aller vers <code>ElasticSearch</code>. Câ€™est nÃ©anmoins un sujet en soi, nous proposons donc aux curieux de consulter <a href="https://pythonds.linogaliana.fr/elastic/">cette ressource</a>.</p>
<p>Voici lâ€™EAN dâ€™exemple :</p>
<div class="cell" data-execution_count="66">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ean <span class="op">=</span> <span class="st">"5000112602999"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour avoir un outil performant, on propose dâ€™utiliser <code>DuckDB</code> pour lire et filtrer les donnÃ©es. Cela sera plus performant que lire, Ã  chaque fois que lâ€™utilisateur de notre application <em>upload</em> une image, un gros fichier (2 millions de ligne) pour nâ€™en garder quâ€™une.</p>
<p>Voici la configuration Ã  mettre en oeuvre:</p>
<div class="cell" data-execution_count="67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">    INSTALL httpfs;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">    LOAD httpfs;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>url_data <span class="op">=</span> <span class="st">"https://projet-funathon.minio.lab.sspcloud.fr/2023/sujet4/diffusion/openfood.parquet"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour commencer, effectuons une requÃªte SQL pour rÃ©cupÃ©rer le produit correspondant au code-barre quâ€™on a scannÃ©:</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es avec <code>DuckDB</code> (ğŸŸ¢ et ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>

Pour exÃ©cuter une requÃªte SQL, on utilise la structure suivante avec `DuckDB`

```python
data_pandas_from_duckdb = con.sql(REQUETE).df()
<p>La requÃªte que nous proposons dâ€™utiliser est Ã  structurer Ã  partir des Ã©lÃ©ments suivants :</p>
<ul>
<li>Pour la clause <code>SELECT</code>, la liste des colonnes Ã  utiliser est prÃ©-formattÃ©e dans lâ€™objet <code>liste_colonnes_sql</code></li>
<li>Pour la clause <code>FROM</code>, lâ€™instruction <code>read_parquet</code> peut Ãªtre utilisÃ©e avec lâ€™URL stockÃ© dans <code>url_data</code></li>
<li>Pour la clause <code>WHERE</code>, vous pouvez utiliser la syntaxe suivante pour normaliser les code-barres des deux cÃ´tÃ©s en retirant les 0 initiaux: <code>CAST(ltrim(code, '0') AS STRING) = CAST(ltrim({ean}) AS STRING)</code></li>
</ul>
</details>
</div>
<!----- end ğŸŸ¢ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ et âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es avec <code>DuckDB</code> (ğŸ”´ et âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>

La requÃªte que nous proposons d'utiliser est Ã  structurer Ã  partir des Ã©lÃ©ments suivants :

- Ne garder que les variables prÃ©sentes dans `liste_colonnes_sql`
- Lire les donnÃ©es directement depuis `url_data`
- Filtrer les donnÃ©es pour ne garder que celle dans l'OpenFood avec notre code-barre

Aide pour la voie ğŸ”´

Il faut normaliser les code-barres des deux cÃ´tÃ©s avant d'essayer
de comparer. Cela se fait de la maniÃ¨re suivante: `CAST(ltrim({ean}) AS STRING)`
A vous de mettre en oeuvre cela pour faire de la comparaison entre notre EAN et la
variable `code`.



```{=html}
</details>
</div>
<!----- end ğŸ”´ et âš« ----->
</div>
<p>Voici la solution:</p>
<div class="cell" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_product_ean(con, ean, url_data, liste_colonnes_sql):</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    openfood_produit <span class="op">=</span> con.sql(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> FROM read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE CAST(ltrim(code, '0') AS STRING) = CAST(ltrim(</span><span class="sc">{</span>ean<span class="sc">}</span><span class="ss">) AS STRING)"</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        ).df()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> openfood_produit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On va nÃ©anmoins intÃ©grer ceci dans un <em>pipeline</em> plus gÃ©nÃ©ral:</p>
<ol type="1">
<li>On cherche le produit Ã  partir du code barre</li>
<li>Si les infos sont manquantes, on rÃ©cupÃ¨re les produits dont le nom ressemble par distance de Jaro-Winkler.</li>
</ol>
<p>Voici la fonction qui permet dâ€™implÃ©menter la deuxiÃ¨me partie:</p>
<div class="cell" data-execution_count="71">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.pipeline <span class="im">import</span> clean_note</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzzy_matching_product(openfood_produit, product_name, con, url_data, liste_colonnes_sql, indices_synthetiques):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    out_textual <span class="op">=</span> con.sql(<span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> from read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE jaro_winkler_similarity('</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">',product_name) &gt; 0.9 AND </span><span class="ch">\"</span><span class="ss">energy-kcal_100g</span><span class="ch">\"</span><span class="ss"> IS NOT NULL"</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    out_textual <span class="op">=</span> out_textual.df()</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    out_textual_imputed <span class="op">=</span> pd.concat(</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>            openfood_produit.loc[:, [<span class="st">"code"</span>, <span class="st">"product_name"</span>, <span class="st">"coicop"</span>]].reset_index(drop <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>            pd.DataFrame(out_textual.loc[:, indices_synthetiques].replace(<span class="st">"NONE"</span>,<span class="st">""</span>).replace(<span class="st">''</span>,np.nan).mode(dropna<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        ], ignore_index<span class="op">=</span><span class="va">True</span>, axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    out_textual_imputed.columns <span class="op">=</span> [<span class="st">"code"</span>, <span class="st">"product_name"</span>, <span class="st">"coicop"</span>] <span class="op">+</span> indices_synthetiques</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out_textual_imputed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici finalement le <em>pipeline</em> mis en oeuvre par une fonction :</p>
<div class="cell" data-execution_count="72">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_product_openfood(con, liste_colonnes_sql, url_data, ean):</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    openfood_produit <span class="op">=</span> con.sql(</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> FROM read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE CAST(ltrim(code, '0') AS STRING) = CAST(ltrim(</span><span class="sc">{</span>ean<span class="sc">}</span><span class="ss">) AS STRING)"</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    ).df()</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    product_name <span class="op">=</span> openfood_produit[<span class="st">"product_name"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> openfood_produit[<span class="st">'nutriscore_grade'</span>].isin([<span class="st">'NONE'</span>,<span class="st">''</span>]).iloc[<span class="dv">0</span>]:</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        openfood_produit <span class="op">=</span> fuzzy_matching_product(</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>            openfood_produit, product_name, con, url_data,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>            liste_colonnes_sql, indices_synthetiques)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        openfood_produit <span class="op">=</span> openfood_produit.merge(coicop, left_on <span class="op">=</span> <span class="st">"coicop"</span>, right_on <span class="op">=</span> <span class="st">"Code"</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> openfood_produit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Qui peut Ãªtre finalisÃ© de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="73">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>openfood_produit <span class="op">=</span> find_product_openfood(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    con, liste_colonnes_sql,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    url_data, ean</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>openfood_produit.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="production-automatique-dun-graphique" class="level2">
<h2 class="anchored" data-anchor-id="production-automatique-dun-graphique">Production automatique dâ€™un graphique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>La derniÃ¨re partie du prototypage consiste Ã  enrober nos fonctions de production de graphiques dans une fonction plus gÃ©nÃ©rique.</p>
<p>Pour rappel, lâ€™import des donnÃ©es se fait de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="74">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> pd.read_parquet(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/stats_notes_pandas.parquet"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Dans notre application, nous allons utiliser cette fonction:</p>
<div class="cell" data-execution_count="75">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.construct_figures <span class="im">import</span> figure_infos_notes</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>variable <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_product_info(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    data, variable,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    stats_notes):</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> figure_infos_notes(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        stats_notes,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        variable_note <span class="op">=</span> variable,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        coicop <span class="op">=</span> data[<span class="st">'coicop'</span>].iloc[<span class="dv">0</span>],</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        note_produit <span class="op">=</span> data[variable].iloc[<span class="dv">0</span>],</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> variable.split(<span class="st">"_"</span>)[<span class="dv">0</span>].capitalize()</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="76">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_product_info(openfood_produit, variable, stats_notes)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="77">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_product_info(openfood_produit, <span class="st">"ecoscore_grade"</span>, stats_notes)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="construire-une-application-interactive" class="level1">
<h1>4ï¸âƒ£ Construire une application interactive</h1>
<p>Cette partie vise Ã  assembler les briques prÃ©cÃ©dentes afin de les rendre facilement accessibles Ã  un utilisateur final. Pour cela, nous allons construire une application interactive Ã  lâ€™aide du framework <code>Streamlit</code> en <code>Python</code>.</p>
<p>Lâ€™objectif est de crÃ©er une application sur le modÃ¨le de <a href="https://myyuka.lab.sspcloud.fr/">myyuka.lab.sspcloud.fr/</a>. Voici une petite vidÃ©o de dÃ©monstration de lâ€™application:</p>
<div class="cell" data-execution_count="78">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> HTML</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">"""</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;video width="520" height="240" alt="test" controls&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="st">        &lt;source src="https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/video_out.webm" type="video/mp4"&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/video&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="30">

    <video width="520" height="240" alt="test" controls="">
        <source src="https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/video_out.webm" type="video/mp4">
    </video>
</div>
</div>
<p>Selon le parcours suivi, la construction de cette application sera plus ou moins guidÃ©e.</p>
<section id="lancer-lapplication-pour-la-tester" class="level2">
<h2 class="anchored" data-anchor-id="lancer-lapplication-pour-la-tester">4.1. Lancer lâ€™application pour la tester (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Il est rare dâ€™avoir une application fonctionnelle du premier coup, cela peut demander beaucoup dâ€™essai-erreur pour parvenir Ã  ses fins. Il est donc utile de rÃ©guliÃ¨rement lancer lâ€™application pour la tester. Cela se fait en lanÃ§ant un serveur local, câ€™est-Ã -dire en crÃ©ant une tÃ¢che qui fonctionne en arriÃ¨re-plan et qui va crÃ©er une interaction entre un navigateur et du code <code>Python</code>.</p>
<p>Pour lancer ce serveur web local plusieurs mÃ©thodes sont possibles sur le <code>SSP Cloud</code>, en partant du principe que votre application est stockÃ©e dans un fichier <code>app.py</code></p>
<ul>
<li>Pour les personnes familiÃ¨res de la ligne de commande, vous pouvez en lancer une (en cliquant sur <code>+</code> dans le menu Ã  gauche de <code>Jupyter</code> et exÃ©cuter, dans le bon dossier de travail, <code>streamlit run app.py --server.port 5000 --server.address 0.0.0.0</code></li>
<li>Pour les personnes dÃ©sirant lancer la commande depuis <code>Jupyter</code>, il suffit dâ€™exÃ©cuter la cellule suivante:</li>
</ul>
<div class="cell" data-execution_count="79">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>streamlit run app.py <span class="op">--</span>server.port <span class="dv">5000</span> <span class="op">--</span>server.address <span class="fl">0.0.0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Remarque: si vous nâ€™Ãªtes pas sur le <code>SSP Cloud</code>, vous pouvez retirer lâ€™option <code>--server.address 0.0.0.0</code>.</p>
<p>Il reste Ã  accÃ©der au navigateur sur lequel lâ€™application a Ã©tÃ© dÃ©ployÃ©e. Sur un poste local, vous ouvririez lâ€™URL <code>localhost:5000</code> sur votre navigateur. Pour accÃ©der Ã  votre application depuis le SSP Cloud, il va falloir y accÃ©der diffÃ©remment.</p>
<ol type="1">
<li>Il convient dâ€™ouvrir un nouvel onglet sur votre navigateur web pour retourner sur votre espace SSPCloud: <a href="https://datalab.sspcloud.fr/my-services">datalab.sspcloud.fr/my-services</a>. Si vous Ãªtes sur une autre page, vous pouvez cliquer Ã  gauche sur <code>My Services</code>.</li>
<li>Ensuite, il faut cliquer sur le bouton <code>README</code> pour accÃ©der Ã  des informations sur le service <code>Jupyter</code> ouvert.</li>
</ol>
<p><img src="img/demo_readme_sspcloud.png" class="img-fluid"></p>
<p>Il faut ensuite cliquer sur le lien ci-dessous:</p>
<p><img src="img/demo_readme_sspcloud2.png" class="img-fluid"></p>
<p>Cela va ouvrir un nouvel onglet sur votre navigateur oÃ¹, cette fois, vous aurez lâ€™application. Chaque action que vous effectuerez sur celle-ci dÃ©clenchera une opÃ©ration dans la<br>
ligne de commande que vous avez lancÃ©e.</p>
<p>Pour le parcours ğŸŸ¡, la voie sâ€™arrÃªte Ã  ce niveau. Vous pouvez nÃ©anmoins basculer du cÃ´tÃ© de la voie ğŸŸ¢ pour apprendre de maniÃ¨re guidÃ©e Ã  crÃ©er votre application <code>Streamlit</code>.</p>
<p>Pour les parcours ğŸŸ¢,ğŸ”µ,ğŸ”´ et âš«, vous allez pouvoir crÃ©er vous-mÃªme lâ€™application, de maniÃ¨re plus ou moins guidÃ©e.</p>
</section>
<section id="crÃ©er-lapplication-dans-un-serveur-temporaire" class="level2">
<h2 class="anchored" data-anchor-id="crÃ©er-lapplication-dans-un-serveur-temporaire">4.2. CrÃ©er lâ€™application dans un serveur temporaire (ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Voici la gradation des niveaux pour crÃ©er lâ€™application:</p>
<ul>
<li>ğŸŸ¢: Lire et comprendre le contenu du fichier <code>app.py</code> qui gÃ©nÃ¨re lâ€™application</li>
<li>ğŸ”µ: AprÃ¨s avoir supprimÃ© le fichier dâ€™exemple <code>app.py</code>, mettre en oeuvre lâ€™application avec des consignes guidÃ©es</li>
<li>ğŸ”´: AprÃ¨s avoir supprimÃ© le fichier dâ€™exemple <code>app.py</code>, mettre en oeuvre lâ€™application Ã  partir dâ€™un cachier des charges dÃ©taillÃ©</li>
<li>âš«: AprÃ¨s avoir supprimÃ© le fichier dâ€™exemple <code>app.py</code>, mettre en oeuvre lâ€™application uniquement Ã  partir de lâ€™exemple sur <a href="https://myyuka.lab.sspcloud.fr/">myyuka.lab.sspcloud.fr/</a> et de la vidÃ©o prÃ©cÃ©demment prÃ©sentÃ©e. IdÃ©alement, faire en sorte que le contenu du site soit <em>responsive</em> câ€™est-Ã -dire quâ€™il soit bien adaptÃ© Ã  la taille de lâ€™Ã©cran.</li>
</ul>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> CrÃ©er l'application (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Bon courage, force et honneur, tout Ã§a tout Ã§aâ€¦</p>
</details>
</div>
<!----- end âš« ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> CrÃ©er l'application (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour commencer, voici lâ€™ensemble de lâ€™environnement, que nous vous proposons de prendre comme donnÃ©:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> streamlit_javascript <span class="im">import</span> st_javascript</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> cv2</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> duckdb</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.detect_barcode <span class="im">import</span> extract_ean, visualise_barcode</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.pipeline <span class="im">import</span> find_product_openfood</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.construct_figures <span class="im">import</span> plot_product_info</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.utils_app <span class="im">import</span> local_css, label_grade_formatter</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.download_pb <span class="im">import</span> import_coicop_labels</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Une personnalisation sympa pour l'onglet</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    st.set_page_config(page_title<span class="op">=</span><span class="st">"PYuka"</span>, page_icon<span class="op">=</span><span class="st">"ğŸ"</span>)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --------------------</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># METADATA</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    indices_synthetiques <span class="op">=</span> [</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    principales_infos <span class="op">=</span> [</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>, <span class="op">\</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'url'</span>, <span class="st">'image_url'</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    liste_colonnes <span class="op">=</span> principales_infos <span class="op">+</span> indices_synthetiques</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    liste_colonnes_sql <span class="op">=</span> [<span class="ss">f"</span><span class="ch">\"</span><span class="sc">{</span>s<span class="sc">}</span><span class="ch">\"</span><span class="ss">"</span> <span class="cf">for</span> s <span class="kw">in</span> liste_colonnes]</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>    liste_colonnes_sql <span class="op">=</span> <span class="st">', '</span>.join(liste_colonnes_sql)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    con.execute(<span class="st">"""</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a><span class="st">        INSTALL httpfs;</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a><span class="st">        LOAD httpfs;</span></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="st">        SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>)</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LOAD DATASET</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    url_data <span class="op">=</span> <span class="st">"https://projet-funathon.minio.lab.sspcloud.fr/2023/sujet4/diffusion/openfood.parquet"</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> pd.read_parquet(<span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/stats_notes_pandas.parquet"</span>)</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --------------------</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>    st.title(<span class="st">'Mon Yuka ğŸ¥• avec Python ğŸ'</span>)</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feuille de style &amp; taille de l'Ã©cran pour adapter l'interface</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>    local_css(<span class="st">"style.css"</span>)</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> st_javascript(</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"window.innerWidth"</span></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>Si lâ€™Ã©cran a une taille suffisante (on propose comme taille discriminante 500px),la partie gauche de lâ€™Ã©cran est consacrÃ©e aux <em>inputs</em> (sinon câ€™est en haut de la page) :
<ul>
<li>Un bouton permet Ã  lâ€™utilisateur de choisir sa mÃ©thode dâ€™<em>upload</em> de photo: soit un <em>file uploader</em>, soit une capture Ã  partir de la camÃ©ra</li>
<li>Si lâ€™Ã©cran a une taille suffisante, afficher lâ€™image reconnue</li>
<li>CrÃ©er une liste modifiable de statistiques Ã  afficher Ã  partir dâ€™un sÃ©lecteur adaptÃ©. Pour formatter les champs Ã  afficher, vous pouvez utiliser la fonction <code>label_grade_formatter</code> qui va, par exemple, transformer <code>nutriscore_grade</code> en <code>Nutriscore</code></li>
</ul></li>
<li>CrÃ©er le corps principal de lâ€™application avec les instructions suivantes:
<ul>
<li>CrÃ©er une fonction enrobant <code>find_product_openfood</code> pour rÃ©cupÃ©rer la donnÃ©e adaptÃ©e Ã  partir dâ€™un EAN. NommÃ© le <code>DataFrame</code> obtenu <code>subset</code></li>
<li>Utiliser <code>extract_ean</code> pour dÃ©coder lâ€™image. Stocker lâ€™objet en sortie dâ€™<code>OpenCV</code> sous le nom <code>decoded_objects</code></li>
<li>A partir de lâ€™objet <code>subset</code>: crÃ©er un texte qui renvoie vers lâ€™URL du produit sur <code>OpenFoodFacts</code>, afficher lâ€™image du produit, afficher le <code>DataFrame</code> dans lâ€™interface de notre application</li>
<li>Utiliser notre fonction de production de graphique pour afficher des statistiques descriptives Ã  partir de notre choix dâ€™options.</li>
</ul></li>
</ol>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> CrÃ©er l'application (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour commencer, voici lâ€™ensemble de lâ€™environnement, que nous vous proposons de prendre comme donnÃ©:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> streamlit_javascript <span class="im">import</span> st_javascript</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> cv2</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> duckdb</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.detect_barcode <span class="im">import</span> extract_ean, visualise_barcode</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.pipeline <span class="im">import</span> find_product_openfood</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.construct_figures <span class="im">import</span> plot_product_info</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.utils_app <span class="im">import</span> local_css, label_grade_formatter</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> utils.download_pb <span class="im">import</span> import_coicop_labels</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Une personnalisation sympa pour l'onglet</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    st.set_page_config(page_title<span class="op">=</span><span class="st">"PYuka"</span>, page_icon<span class="op">=</span><span class="st">"ğŸ"</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --------------------</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># METADATA</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    indices_synthetiques <span class="op">=</span> [</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    principales_infos <span class="op">=</span> [</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>, <span class="op">\</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'url'</span>, <span class="st">'image_url'</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    liste_colonnes <span class="op">=</span> principales_infos <span class="op">+</span> indices_synthetiques</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    liste_colonnes_sql <span class="op">=</span> [<span class="ss">f"</span><span class="ch">\"</span><span class="sc">{</span>s<span class="sc">}</span><span class="ch">\"</span><span class="ss">"</span> <span class="cf">for</span> s <span class="kw">in</span> liste_colonnes]</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>    liste_colonnes_sql <span class="op">=</span> <span class="st">', '</span>.join(liste_colonnes_sql)</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>    con.execute(<span class="st">"""</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="st">        INSTALL httpfs;</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="st">        LOAD httpfs;</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="st">        SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>)</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LOAD DATASET</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>    url_data <span class="op">=</span> <span class="st">"https://projet-funathon.minio.lab.sspcloud.fr/2023/sujet4/diffusion/openfood.parquet"</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> pd.read_parquet(<span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/stats_notes_pandas.parquet"</span>)</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --------------------</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>    st.title(<span class="st">'Mon Yuka ğŸ¥• avec Python ğŸ'</span>)</span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feuille de style &amp; taille de l'Ã©cran pour adapter l'interface</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>    local_css(<span class="st">"style.css"</span>)</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>    width <span class="op">=</span> st_javascript(</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"window.innerWidth"</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br> Nous proposons ensuite de construire ce fichier par Ã©tape</p>
<p>Etape 1: Construire la partie <em>inputs</em> en suivant le modÃ¨le Ã  trou suivant:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> width <span class="op">&gt;</span> <span class="dv">500</span>:</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pour les grands Ã©crans on met une partie Ã  gauche</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># qui centralise plusieurs type d'input</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> st.sidebar:</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1. choix de la mÃ©thode d'upload</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> input_method <span class="op">==</span> <span class="st">'Photo enregistrÃ©e'</span>:</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 2. file uploader</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 3. camera uploader</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> input_url <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>                <span class="co"># visualise l'image s'il y a un input</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> visualise_barcode(input_url)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>                cv2.imwrite(<span class="st">'barcode_opencv.jpg'</span>, img)</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 4. afficher l'image</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5. choix des statistiques Ã  afficher</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pour les petits Ã©crans (type smartphone)</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># le file uploader est au dÃ©but</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. choix de la mÃ©thode d'upload</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> input_method <span class="op">==</span> <span class="st">'Photo enregistrÃ©e'</span>:</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2. file uploader</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 3. camera uploader</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>            picture <span class="op">=</span> st.camera_input(<span class="st">"Take a picture"</span>)</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>            input_url <span class="op">=</span> picture</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5. choix des statistiques Ã  afficher</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>Celui-ci est Ã  remplir de la maniÃ¨re suivante:</p>
<ol type="1">
<li>CrÃ©er un bouton qui permet Ã  lâ€™utilisateur de choisir sa mÃ©thode dâ€™<em>upload</em> de photo. Celui-ci est Ã  enregistrer sous le nom <code>input_method</code></li>
<li>Proposer un <em>file uploader</em> dont la valeur peut Ãªtre utilisÃ©e sous le nom <code>input_url</code></li>
<li>Proposer un outil de capture de camÃ©ra dont la valeur peut Ãªtre utilisÃ©e sous le nom <code>input_url</code></li>
<li>Si lâ€™Ã©cran a une taille suffisante (on propose comme taille discriminante 500px), afficher lâ€™image stockÃ©e dans le fichier temporaire <code>barcode_opencv.jpg</code></li>
<li>CrÃ©er une liste modifiable de statistiques Ã  afficher Ã  partir dâ€™un sÃ©lecteur adaptÃ©. Pour formatter les champs Ã  afficher, vous pouvez utiliser la fonction <code>label_grade_formatter</code> qui va, par exemple, transformer <code>nutriscore_grade</code> en <code>Nutriscore</code></li>
</ol>
<p>Etape 2: Construire la partie sâ€™adaptant Ã  ces <em>inputs</em> avec le modÃ¨le suivant Ã  trou suivant:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ----------------------------------------------------------</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PARTIE 2: EXPLOITATION DES INPUTS DANS NOTRE APP</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CHARGEMENT DE LA LIGNE DANS OPENFOODFACTS</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@st.cache_data</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_data(ean):</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. CrÃ©er le DataFrame avec la fonction `find_product_openfood` </span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># openfood_data = </span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> openfood_data</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> input_url <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Showcase product</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>        st.write(<span class="st">'Produit exemple: Coca-Cola'</span>)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> load_data(<span class="st">"5000112602791"</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>        decoded_objects <span class="op">=</span> extract_ean(subset[<span class="st">"image_url"</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. utiliser `extract_ean` pour dÃ©coder l'image</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># decoded_objects</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. RÃ©cupÃ©rer l'EAN</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>        ean <span class="op">=</span> decoded_objects[<span class="dv">0</span>].data.decode(<span class="st">"utf-8"</span>)</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>        st.markdown(<span class="ss">f'ğŸ‰ __EAN dÃ©tectÃ©__: &lt;span style="color:Red"&gt;</span><span class="sc">{</span>ean<span class="sc">}</span><span class="ss">&lt;/span&gt;'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> load_data(ean)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Mettre un lien avec l'URL du produit sur openfoodfacts</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Afficher l'image du produit</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 5. Afficher le DataFrame</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># put some statistics</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> <span class="ss">f"&lt;div&gt;Statistiques parmi les &lt;span class='highlight blue'&gt;</span><span class="sc">{</span>subset[<span class="st">'category'</span>]<span class="sc">.</span>iloc[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">&lt;span class='bold'&gt;COICOP&lt;/span&gt;"</span>                </span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>        st.markdown(t, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 6. Afficher les figures plotly</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># we don't manage to get EAN</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>        st.write(<span class="st">'ğŸš¨ ProblÃ¨me de lecture de la photo, essayez de mieux cibler le code-barre'</span>)</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>        st.image(<span class="st">"https://i.kym-cdn.com/entries/icons/original/000/025/458/grandma.jpg"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Voici des indications pour complÃ©ter ces trous:</p>
<ol type="1">
<li>CrÃ©er une fonction enrobant <code>find_product_openfood</code> pour rÃ©cupÃ©rer la donnÃ©e adaptÃ©e Ã  partir dâ€™un EAN</li>
<li>Utiliser <code>extract_ean</code> pour dÃ©coder lâ€™image. Stocker lâ€™objet en sortie dâ€™<code>OpenCV</code> sous le nom <code>decoded_objects</code></li>
<li>A partir de lâ€™objet <code>subset</code>, crÃ©er un texte qui renvoie vers lâ€™URL du produit sur <code>OpenFoodFacts</code></li>
<li>Afficher lâ€™image du produit, lâ€™URL Ã©tant la variable adÃ©quate de <code>subset</code></li>
<li>Afficher le <code>DataFrame</code> dans lâ€™interface de notre application</li>
<li>Utiliser notre fonction de production de graphique pour afficher des statistiques descriptives Ã  partir de notre choix dâ€™options.</li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<p>Voici une proposition dâ€™application, afin de reproduire en local le contenu de <a href="https://myyuka.lab.sspcloud.fr/">myyuka.lab.sspcloud.fr/</a></p>
<div class="cell" data-execution_count="83">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour la voie ğŸŸ¢</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'app.py'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    app_content <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    app_content</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>import streamlit as st
from streamlit_javascript import st_javascript

import cv2
import pandas as pd
import duckdb

from utils.detect_barcode import extract_ean, visualise_barcode
from utils.pipeline import find_product_openfood
from utils.construct_figures import plot_product_info
from utils.utils_app import local_css, label_grade_formatter
from utils.download_pb import import_coicop_labels

# Une personnalisation sympa pour l'onglet
st.set_page_config(page_title="PYuka", page_icon="ğŸ")


# --------------------
# METADATA
indices_synthetiques = [
    "nutriscore_grade", "ecoscore_grade", "nova_group"
]
principales_infos = [
    'product_name', 'code', 'preprocessed_labels', 'coicop', \
    'url', 'image_url'
]
liste_colonnes = principales_infos + indices_synthetiques
liste_colonnes_sql = [f"\"{s}\"" for s in liste_colonnes]
liste_colonnes_sql = ', '.join(liste_colonnes_sql)

con = duckdb.connect(database=':memory:')
con.execute("""
    INSTALL httpfs;
    LOAD httpfs;
    SET s3_endpoint='minio.lab.sspcloud.fr'
""")

# LOAD DATASET
url_data = "https://projet-funathon.minio.lab.sspcloud.fr/2023/sujet4/diffusion/openfood.parquet"
stats_notes = pd.read_parquet("https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/stats_notes_pandas.parquet")
coicop = import_coicop_labels(
    "https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"
)

# --------------------


st.title('Mon Yuka ğŸ¥• avec Python ğŸ')

# Feuille de style &amp; taille de l'Ã©cran pour adapter l'interface
local_css("style.css")
width = st_javascript(
    "window.innerWidth"
)

# --------------------------------
# PARTIE 1: LES INPUTS

if width &gt; 500:
    # pour les grands Ã©crans on met une partie Ã  gauche
    # qui centralise plusieurs type d'input
    with st.sidebar:
        # choix de la mÃ©thode d'upload
        input_method = st.radio(
                "MÃ©thode d'upload de la photo",
                ('Photo enregistrÃ©e', 'Capture de la webcam'))
        if input_method == 'Photo enregistrÃ©e':
            # file uploader
            input_url = st.file_uploader("Uploaded une photo:", accept_multiple_files=False)
        else:
            # camera uploader
            picture = st.camera_input("Take a picture")
            input_url = picture
        
        if input_url is not None:
            # visualise l'image s'il y a un input
            img = visualise_barcode(input_url)
            cv2.imwrite('barcode_opencv.jpg', img)
            st.image('barcode_opencv.jpg')

        # choix des statistiques Ã  afficher
        options = st.multiselect(
                'Quelles statistiques afficher ?',
                ["nutriscore_grade", "nova_group", "ecoscore_grade"],
                ["nutriscore_grade", "nova_group", "ecoscore_grade"],
                format_func=label_grade_formatter)
else:
    # pour les petits Ã©crans (type smartphone)
    # le file uploader est au dÃ©but
    input_method = st.radio(
                    "MÃ©thode d'upload de la photo",
                    ('Photo enregistrÃ©e', 'Capture de la webcam'))
    if input_method == 'Photo enregistrÃ©e':
        # file uploader
        input_url = st.file_uploader("Uploaded une photo:", accept_multiple_files=False)
    else:
        # camera uploader
        picture = st.camera_input("Take a picture")
        input_url = picture
    # choix des statistiques Ã  afficher
    options = st.multiselect(
                    'Quelles statistiques afficher ?',
                    ["nutriscore_grade", "nova_group", "ecoscore_grade"],
                    ["nutriscore_grade", "nova_group", "ecoscore_grade"],
                    format_func=label_grade_formatter)


# ----------------------------------------------------------
# PARTIE 2: EXPLOITATION DES INPUTS DANS NOTRE APP



# CHARGEMENT DE LA LIGNE DANS OPENFOODFACTS
@st.cache_data
def load_data(ean):
    openfood_data = find_product_openfood(con, liste_colonnes_sql, url_data, ean, coicop)
    return openfood_data

if input_url is None:
    # Showcase product
    st.write('Produit exemple: Coca-Cola')
    subset = load_data("5000112602791")
    decoded_objects = extract_ean(subset["image_url"].iloc[0])
else:
    # decode image
    decoded_objects = extract_ean(input_url)
    
try:
    # we manage to read EAN
    ean = decoded_objects[0].data.decode("utf-8")
    st.markdown(f'ğŸ‰ __EAN dÃ©tectÃ©__: &lt;span style="color:Red"&gt;{ean}&lt;/span&gt;', unsafe_allow_html=True)
    subset = load_data(ean)
    # visualise product
    st.markdown(f'Consulter ce produit sur le [site `Openfoodfacts`]({subset["url"].iloc[0]})')
    st.image(subset["image_url"].iloc[0])                
    st.dataframe(subset.loc[:, ~subset.columns.str.contains("url")])
    # put some statistics
    t = f"&lt;div&gt;Statistiques parmi les &lt;span class='highlight blue'&gt;{subset['category'].iloc[0]}&lt;span class='bold'&gt;COICOP&lt;/span&gt;"                
    st.markdown(t, unsafe_allow_html=True)
    # images
    for var in options:
        fig = plot_product_info(subset, var, stats_notes)
        st.plotly_chart(fig, height=800, use_container_width=True)
except:
    # we don't
    st.write('ğŸš¨ ProblÃ¨me de lecture de la photo, essayez de mieux cibler le code-barre')
    st.image("https://i.kym-cdn.com/entries/icons/original/000/025/458/grandma.jpg")

</code></pre>
</div>
</div>
</section>
<section id="en-marche-vers-la-mise-en-production" class="level2">
<h2 class="anchored" data-anchor-id="en-marche-vers-la-mise-en-production">4.3. En marche vers la mise en production (ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Pour le parcours ğŸŸ¢, la voie sâ€™arrÃªte Ã  ce niveau. Vous pouvez nÃ©anmoins basculer du cÃ´tÃ© de la voie ğŸ”µ pour apprendre de maniÃ¨re guidÃ©e Ã  mettre en production votre travail en dÃ©ployant automatiquement une application.</p>
<p>Pour les parcours ğŸ”µ,ğŸ”´ et âš«, vous allez pouvoir dÃ©ployer vous-mÃªme lâ€™application, de maniÃ¨re plus ou moins guidÃ©e.</p>
</section>
</section>
<section id="dÃ©ploiement-de-lapplication-interactive" class="level1">
<h1>5ï¸âƒ£ DÃ©ploiement de lâ€™application interactive</h1>
<section id="prÃ©liminaires-1" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©liminaires-1">5.1. PrÃ©liminaires (ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Lâ€™application construite dans la partie prÃ©cÃ©dente reste pour le moment Ã  un niveau local: elle nâ€™est accessible que via lâ€™utilisateur qui lâ€™a dÃ©ployÃ©e et ce sur la machine oÃ¹ elle a Ã©tÃ© dÃ©ployÃ©e. Lâ€™objectif de cette derniÃ¨re partie est de <strong>dÃ©ployer</strong> lâ€™application, câ€™est Ã  dire de la rendre accessible en continu Ã  nâ€™importe quel utilisateur. Pour cela, on va devoir sâ€™intÃ©resser Ã  la technologie des <strong>conteneurs</strong>, qui est Ã  la base des infrastructures de production modernes.</p>
<p>Le fait de lancer ce notebook via un simple <a href="LIEN%20A%20METTRE">lien de lancement</a> nous a permis de commencer Ã  travailler directement, sans trop nous soucier de lâ€™environnement de dÃ©veloppement dans lequel on se trouvait.</p>
<p>Mais dÃ¨s lors que lâ€™on souhaite passer de son environnement de dÃ©veloppement Ã  un environnement de production, il est nÃ©cessaire de se poser un ensemble de questions pour sâ€™assurer que le projet fonctionne ailleurs que sur sa machine personnelle :</p>
<ul>
<li>quelle est la version de <code>Python</code> Ã  installer pour que le projet fonctionne ?</li>
<li>quels sont les packages <code>Python</code> utilisÃ©s par le projet et quelles sont leurs versions ?</li>
<li>quelles sont les Ã©ventuelles librairies systÃ¨mes, i.e.&nbsp;dÃ©pendantes du systÃ¨me dâ€™exploitation installÃ©, nÃ©cessaires pour que les packages <code>Python</code> sâ€™installent correctement ?</li>
</ul>
<p>La technologie standard pour assurer la <strong>portabilitÃ©</strong> dâ€™un projet, câ€™est Ã  dire de fonctionner sur diffÃ©rents environnements informatiques, est celle des <strong>conteneurs</strong>. SchÃ©matiquement, il sâ€™agit de boÃ®tes virtuelles qui contiennent lâ€™ensemble de lâ€™environnement (librairies systÃ¨mes, interprÃ©teur <code>Python</code>, code applicatif, configurationâ€¦) permettant de faire tourner lâ€™application, tout en restant lÃ©gÃ¨res et donc faciles Ã  redistribuer. En fait, chaque service lancÃ© sur le <code>SSP Cloud</code> est un conteneur, et ce notebook tourne donc lui-mÃªmeâ€¦ dans un conteneur !</p>
<p>Lâ€™enjeu de cette partie est donc de dÃ©voiler pas Ã  pas la boÃ®te noire afin de comprendre dans quel environnement on se trouve, et comment celui-ci va nous permettre de dÃ©ployer notre application.</p>
</section>
<section id="conteneurisation-de-lapplication" class="level2">
<h2 class="anchored" data-anchor-id="conteneurisation-de-lapplication">5.2. Conteneurisation de lâ€™application (ğŸ”µ,ğŸ”´,âš«)</h2>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Comprendre la crÃ©ation de l'image `Docker` de l'application (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Le projet contient Ã  la racine un fichier <code>Dockerfile</code>. Il sâ€™agit de la â€œrecetteâ€ de construction de lâ€™image <code>Docker</code> de lâ€™application, i.e.&nbsp;qui spÃ©cifie lâ€™environnement nÃ©cessaire Ã  son bon fonctionnement.</p>
<p>En vous inspirant de la <a href="https://docs.streamlit.io/knowledge-base/tutorials/deploy/docker#create-a-dockerfile">documentation Streamlit</a> (en Anglais) ou bien de cette <a href="https://ensae-reproductibilite.github.io/website/chapters/portability.html#dockerfile">page de cours</a>, essayez de comprendre pas Ã  pas les Ã©tapes de construction de lâ€™image <code>Docker</code> de lâ€™application.</p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´, âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> CrÃ©er le `Dockerfile` de l'application (ğŸ”´, âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Une image <code>Docker</code> est construite Ã  partir dâ€™un fichier spÃ©cifique gÃ©nÃ©ralement placÃ© Ã  la racine du projet, le <code>Dockerfile</code>. Sans regarder le <code>Dockerfile</code> existant dans le projet, et en vous inspirant de la <a href="https://docs.streamlit.io/knowledge-base/tutorials/deploy/docker#create-a-dockerfile">documentation Streamlit</a> (en Anglais), essayez de construire le <code>Dockerfile</code> pertinent pour lâ€™application, puis comparez votre solution Ã  lâ€™existant.</p>
<p>Quelques consignes supplÃ©mentaires :</p>
<ul>
<li>on utilisera comme image de base <code>inseefrlab/onyxia-jupyter-python:py3.10.9</code></li>
<li>on se mettra en utilisateur <em>root</em> via lâ€™<a href="https://docs.docker.com/engine/reference/builder/#user">instruction USER</a></li>
<li>on aura besoin dâ€™installer les librairies systÃ¨me suivantes via <code>apt-get</code> : <code>ffmpeg, libsm6, libxext6, libzbar0</code></li>
<li>on copiera tous les fichiers du projet local sur lâ€™image <code>Docker</code> Ã  lâ€™aide de lâ€™<a href="https://docs.docker.com/engine/reference/builder/#copy">instruction COPY</a></li>
<li>on fera tourner lâ€™application sur le port <code>8000</code> du conteneur (quâ€™il faudra donc prendre soin dâ€™exposer)</li>
<li>on ne fera pas de <code>HEALTHCHECK</code></li>
</ul>
</details>
</div>
<!----- end ğŸ”´, âš« ----->
</div>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Construire l'image `Docker` de l'application par intÃ©gration continue (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Une fois le <code>Dockerfile</code> construit (du moins sa premiÃ¨re version), on va lâ€™utiliser pour construire une image <code>Docker</code> (la â€œboÃ®teâ€ virtuelle) et mettre celle-ci sur un registre (rÃ©pertoire dâ€™images) afin que celle-ci puisse Ãªtre rÃ©utilisÃ©e dans un autre environnement que celui oÃ¹ on lâ€™a dÃ©veloppÃ©e.</p>
<p>On pourrait faire cela â€œÃ  la mainâ€ en ligne de commandes (cf.&nbsp;<a href="https://docs.docker.com/get-started/02_our_app/">documentation Docker</a>), mais on va plutÃ´t automatiser le processus en passant par un <em>pipeline</em> (sÃ©rie dâ€™Ã©tapes) dâ€™intÃ©gration continue.</p>
<p>Ainsi, Ã  chaque mise Ã  jour du code source de lâ€™application (nouvelles fonctionnalitÃ©s, correction de bugs, etc.), notre image sera automatiquement mise Ã  jour.</p>
<p>Les Ã©tapes Ã  suivre sont les suivantes :</p>
<ul>
<li>si nÃ©cessaire, crÃ©er un compte personnel sur <a href="https://github.com">GitHub</a> et sur le <a href="https://hub.docker.com/">DockerHub</a> (registre dâ€™images open-source)</li>
<li>bien sâ€™assurer que le <code>Dockerfile</code> obtenu Ã  lâ€™Ã©tape prÃ©cÃ©dente est identique Ã  celui existant dans le projet</li>
<li><a href="https://docs.github.com/fr/get-started/quickstart/fork-a-repo">forker</a> le <a href="https://github.com/InseeFrLab/funathon2023_sujet4">dÃ©pÃ´t du projet</a> afin de lâ€™avoir dans votre espace personnel sur <code>GitHub</code></li>
<li><a href="https://docs.github.com/fr/repositories/creating-and-managing-repositories/cloning-a-repository">cloner</a> le dÃ©pÃ´t forkÃ© (i.e.&nbsp;de la forme <code>votre_nom_utilisateur_gh/funathon2023_sujet4</code>) via un terminal</li>
<li>crÃ©er un nouveau dÃ©pÃ´t public sur le <code>DockerHub</code></li>
<li>crÃ©er les secrets <code>DOCKERHUB_USERNAME</code> et <code>DOCKERHUB_TOKEN</code> (cf.&nbsp;<a href="https://docs.docker.com/build/ci/github-actions/#step-one-create-the-repository">documentation Docker</a>), nÃ©cessaires pour que le CI <code>GitHub</code> puisse pousser une image sur le <code>DockerHub</code></li>
<li>ajuster le fichier dâ€™intÃ©gration continue (<code>.github/workflows/docker.yaml</code>) pour que le dÃ©pÃ´t sur lequel est envoyÃ© lâ€™image ne soit plus <code>inseefrlab/funathon2023_sujet4</code> mais <code>votre_nom_utilisateur_dh/funathon2023_sujet4</code></li>
<li><em>commit</em>/<em>push</em> les changements sur <code>GitHub</code></li>
<li>si tout sâ€™est bien passÃ©, une action devrait se lancer (cf.&nbsp;onglet <code>Actions</code> du dÃ©pÃ´t) afin de construire lâ€™image et de lâ€™envoyer sur le <code>DockerHub</code></li>
<li>si lâ€™action sâ€™est bien dÃ©roulÃ©e (flÃ¨che verte), aller vÃ©rifier que lâ€™image est bien disponible dans votre espace sur le <code>DockerHub</code></li>
</ul>
</details>
</div>
<!----- end âš« ----->
</div>
</section>
<section id="dÃ©ploiement-sur-le-ssp-cloud" class="level2">
<h2 class="anchored" data-anchor-id="dÃ©ploiement-sur-le-ssp-cloud">5.3. DÃ©ploiement sur le <code>SSP Cloud</code></h2>
<p>Maintenant que lâ€™image de notre application est disponible sur le <code>DockerHub</code>, elle peut Ã  prÃ©sent Ãªtre rÃ©cupÃ©rÃ©e (<em>pull</em>) et dÃ©ployÃ©e sur nâ€™importe quel environnement. Dans notre cas, on va la dÃ©ployer sur un cluster <code>Kubernetes</code>, lâ€™infrastructure sous-jacente du <code>SSP Cloud</code>. Le fonctionnement de <code>Kubernetes</code> est assez technique, mais lâ€™on pourra sâ€™abstraire de certaines parties selon le niveau de difficultÃ© choisi.</p>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> DÃ©ploiement de l'application Ã  partir du `DockerHub` `InseeFrLab` (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>En amont de ce projet, nous avons construit une image <code>Docker</code> fonctionnelle de lâ€™application, disponible sur le <code>DockerHub</code> dans lâ€™espace <a href="https://hub.docker.com/repository/docker/inseefrlab/funathon2023_sujet4">inseefrlab</a>. Nous avons Ã©galement crÃ©Ã©s dans le rÃ©pertoire <code>deployment/</code> Ã  la racine du projet les trois fichiers standards nÃ©cessaires au dÃ©ploiement dâ€™une application sur <code>Kubernetes</code>.</p>
<p>Afin de dÃ©ployer lâ€™application, suivre les instructions suivantes :</p>
<ul>
<li>inspecter les fichiers <code>deployment.yml</code>, <code>service.yml</code> et <code>ingress.yml</code> et repÃ©rer les Ã©lÃ©ments suivants :
<ul>
<li>oÃ¹ est spÃ©cifiÃ©e lâ€™image que lâ€™on va dÃ©ployer. Pour la difficultÃ© âš«: remplacer lâ€™image actuelle par celle que vous avez construite et envoyÃ©e sur le <code>DockerHub</code> dans la partie prÃ©cÃ©dente</li>
<li>oÃ¹ sont spÃ©cifiÃ©es les ressources computationnelles que lâ€™on va allouer Ã  lâ€™application</li>
<li>oÃ¹ est dÃ©fini le port que lâ€™on a exposÃ© dans le <code>Dockerfile</code>. Pour la difficultÃ© âš«: si vous nâ€™avez pas exposÃ© lâ€™application sur le port <code>8000</code>, modifier cette ligne</li>
<li>oÃ¹ est dÃ©fini le port sur lequel on va exposer lâ€™application sur le cluster <code>Kubernetes</code></li>
<li>oÃ¹ est dÃ©finie lâ€™URL Ã  laquelle on va exposer lâ€™application pour que les utilisateurs puissent sâ€™y connecter. La modifier (Ã  2 reprises) pour y indiquer une adresse personalisÃ©e pour votre dÃ©ploiement. Seule contrainte : elle doit Ãªtre de la forme : <code>*.lab.sspcloud.fr</code></li>
</ul></li>
<li>ouvrir un terminal dans le service <code>Jupyter</code></li>
<li>se placer dans le projet du funathon : <code>cd funathon2023_sujet4</code></li>
<li>appliquer les contrats de dÃ©ploiement : <code>kubernetes apply -f deployment/</code></li>
<li>vÃ©rifier le lancement du conteneur : <code>watch kubernetes get pods</code>. Le nom associÃ© devrait Ãªtre de la forme <code>funathon2023-sujet4-****-*****</code></li>
<li>une fois que le conteneur est indiquÃ© comme <code>Running</code>, entrer dans un navigateur lâ€™URL que vous avez spÃ©cifiÃ© dans le fichier <code>ingress.yml</code>, et vÃ©rifier que lâ€™application fonctionne correctement</li>
</ul>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<p>Votre application est maintenant dÃ©ployÃ©e, vous pouvez partager cette URL avec nâ€™importe quel utilisateur dans le monde !</p>
</section>
<section id="bonus-le-parcours" class="level2">
<h2 class="anchored" data-anchor-id="bonus-le-parcours">Bonus: le parcours ğŸŸ£</h2>
<p>Un dernier <em>challenge</em> pour les amateurs de sensations fortes : crÃ©er la mÃªme application sur un site <em>web</em> statique grÃ¢ce au <em>web assembly</em> (par exemple grÃ¢ce Ã  <code>Observable</code> et <code>Quarto</code>) !</p>
<p>Pour avoir un site web statique, lâ€™identification du code-barre devra Ãªtre faite en dehors de lâ€™application, par exemple par le moyen dâ€™une API</p>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb68" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Mon Yuka ğŸ¥• avec Python ğŸ"</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="an">eval:</span><span class="co"> false</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">  keep-ipynb: true</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>Ce notebook vise Ã  prÃ©senter pas Ã  pas comment crÃ©er une application interactive</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>avec <span class="in">`Streamlit`</span> reproduisant celle proposÃ©e sur <span class="co">[</span><span class="ot">myyuka.lab.sspcloud.fr</span><span class="co">](https://myyuka.lab.sspcloud.fr/)</span>.</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>Cet exercice est proposÃ© dans le cadre du <span class="in">`Funathon`</span> (hackathon non compÃ©titif)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>organisÃ© en 2023 par l'Insee et le MinistÃ¨re de l'Agriculture sur le thÃ¨me _"Du champ Ã  l'assiette"_. </span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>Les autres sujets sont disponibles</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>sur le <span class="co">[</span><span class="ot">`Github InseeFrLab`</span><span class="co">](https://github.com/InseeFrLab/funathon2023)</span>. </span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="fu"># Objectif et approche pÃ©dagogique</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>L'objectif de ce projet est d'apprendre Ã  utiliser <span class="in">`Python`</span> pour crÃ©er des </span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>applications rÃ©actives avec <span class="in">`Streamlit`</span> mais aussi de se familiariser Ã </span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>la manipulation de donnÃ©es avec <span class="in">`Python`</span> et, au passage, Ã  quelques bonnes</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>pratiques utiles pour obtenir des projets plus lisibles et reproductibles. </span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>Pour parvenir Ã  cet objectif, il est possible d'emprunter plusieurs voies,</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>plus ou moins guidÃ©es. Celles-ci sont lÃ  pour permettre que ce sujet </span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>soit rÃ©alisable. Elles sont balisÃ©es de la maniÃ¨re suivante:</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>| Balisage | Approche | PrÃ©requis de niveau | Objectif pÃ©dagogique |</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>|--------|---------|----------------|-------------------|</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>| ğŸŸ¡ | ExÃ©cuter les cellules permet d'obtenir le rÃ©sultat attendu | CapacitÃ© Ã  installer des _packages_ | DÃ©couvrir de nouveaux _packages_ en suivant le fil conducteur du projet, dÃ©couvrir les scripts <span class="in">`Python`</span>, se familiariser avec <span class="in">`Git`</span>  |</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>| ğŸŸ¢ | Des instructions dÃ©taillÃ©es sur la maniÃ¨re de procÃ©der sont proposÃ©es | ConnaÃ®tre quelques manipulations avec <span class="in">`Pandas`</span> | Apprendre Ã  utiliser certains _packages_ avec un projet guidÃ©, se familiariser avec les projets `Python` plus consÃ©quents que les _notebooks_ <span class="in">`Jupyter`</span> |</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>| ğŸ”µ | Instructions moins dÃ©taillÃ©es | CapacitÃ© Ã  manipuler des donnÃ©es avec <span class="in">`Pandas`</span> | Apprendre Ã  modulariser du code pour faciliter sa rÃ©utilisation dans une application, dÃ©couvrir la rÃ©cupation de donnÃ©es via des API |</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>| ğŸ”´ | Peu d'instructions | ExpÃ©rience en dÃ©veloppement de code <span class="in">`Python`</span> | DÃ©couvrir la crÃ©ation d'application ou se familiariser avec l'Ã©cosystÃ¨me <span class="in">`DuckDB`</span> |</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>| âš« | Autonomie | Bonne maÃ®trise de <span class="in">`Python`</span> et de la ligne de commande Ì€<span class="in">`Linux`</span> | S'initier au dÃ©ploiement d'une application ou Ã  l'ingÃ©nieurie de donnÃ©es&nbsp;|</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>Le parcours vers la mise en oeuvre d'une application fonctionnelle se fait par Ã©tapes, en sÃ©quenÃ§ant le projet</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>pour permettre d'avoir un projet lisible, reproductible et modulaire. </span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>Les Ã©tapes ne sont</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>pas forcÃ©ment de difficultÃ© graduelle, il s'agit plutÃ´t de sÃ©quencer de maniÃ¨re logique le projet</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>pour vous faciliter la prise en main.</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>Il est donc tout Ã  fait possible de passer, selon les parties, d'une voie ğŸŸ¢ Ã  une voie ğŸ”µ ou bien de tester les codes proposÃ©s dans la voie ğŸŸ¡ d'abord puis, une fois que la logique a Ã©tÃ© comprise, essayer de les faire soit-mÃªme via la voie ğŸŸ¢ ou encore essayer via la voie ğŸ”µ, ne pas y parvenir du fait du caractÃ¨re plus succinct des instructions et regarder les instructions de la voie ğŸŸ¢ ou la solution de la voie ğŸŸ¡.</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>Il est mÃªme tout Ã  fait possible de sauter une Ã©tape et reprendre Ã  partir de la suivante grÃ¢ce aux _checkpoints_ proposÃ©s. </span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>Les consignes sont encapsulÃ©es dans des boites dÃ©diÃ©es, afin d'Ãªtre sÃ©parÃ©es des explications gÃ©nÃ©rales. </span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>Par exemple, la boite verte prendra l'aspect suivant:</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>::: {.cell .markdown}</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!----- boite ğŸŸ¢ -----&gt;</span></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a><span class="in">#| output: asis</span></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: true</span></span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a><span class="in">from utils_notebook import create_box_level</span></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a><span class="in">create_box_level(color = "ğŸŸ¢", title = "Exemple (ğŸŸ¢)")</span></span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;details&gt;</span></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;summary&gt;</span>DÃ©rouler pour rÃ©vÃ©ler les instructions<span class="kw">&lt;/summary&gt;</span></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a><span class="in">Utiliser la fonction `print` pour afficher le texte _"Toto"_</span></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/details&gt;</span></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!----- end ğŸŸ¢ -----&gt;</span></span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>alors que sur le mÃªme exercice, si plusieurs voies peuvent emprunter le mÃªme chemin, on </span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>utilisera une dÃ©limitation grise :</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>::: {.cell .markdown}</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!----- boite ğŸ”µ -----&gt;</span></span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a><span class="in">#| output: asis</span></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a><span class="in">#| eval: true</span></span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a><span class="in">from utils_notebook import create_box_level</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a><span class="in">create_box_level(color = "grey", title = "Exemple (ğŸ”µ,ğŸ”´,âš«)")</span></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;details&gt;</span></span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;summary&gt;</span>DÃ©rouler pour rÃ©vÃ©ler les instructions<span class="kw">&lt;/summary&gt;</span></span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a><span class="in">Afficher le texte _"Toto"_</span></span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/details&gt;</span></span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!----- end ğŸ”µ -----&gt;</span></span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>La solution associÃ©e, visible pour les personnes sur la voie ğŸŸ¡, sera:</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"toto"</span>)</span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true" tabindex="-1"></a><span class="fu">## Etapes du projet</span></span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true" tabindex="-1"></a>Le projet est sÃ©quencÃ© de la maniÃ¨re suivante: </span>
<span id="cb68-126"><a href="#cb68-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-127"><a href="#cb68-127" aria-hidden="true" tabindex="-1"></a>| Etape | Objectif |</span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true" tabindex="-1"></a>|--------|---------|</span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true" tabindex="-1"></a>| RÃ©cupÃ©ration et nettoyage de la base <span class="in">`OpenFoodFacts`</span> | Lire des donnÃ©es avec <span class="in">`Pandas`</span> depuis un site web (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), appliquer des nettoyages de champs textuels (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), catÃ©goriser ces donnÃ©es avec un classifieur automatique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«) voire entrainer un classifieur _ad hoc_ (ğŸ”´,âš«), Ã©crire ces donnÃ©es sur un systÃ¨me de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«) |</span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true" tabindex="-1"></a>| Faire des statistiques agrÃ©gÃ©es par catÃ©gories | Utiliser <span class="in">`Pandas`</span> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<span class="in">`DuckDB`</span> (ğŸ”´,âš«) pour faire des statistiques par groupe |</span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true" tabindex="-1"></a>| Trouver un produit dans <span class="in">`OpenFoodFacts`</span> Ã  partir d'un code barre | DÃ©tection visuelle d'un code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), rechercher des donnÃ©es avec des critÃ¨res d'appariement exact comme le code barre via <span class="in">`Pandas`</span> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<span class="in">`DuckDB`</span> (ğŸ”´,âš«)  ou via des distances textuelles (ğŸ”´,âš«)|</span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true" tabindex="-1"></a>| Encapsuler ces Ã©tapes dans une application <span class="in">`Streamlit`</span> | Tester une application <span class="in">`Streamlit`</span> minimale (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), personnaliser celle-ci (ğŸ”´,âš« ou ğŸŸ¡,ğŸŸ¢,ğŸ”µ dÃ©sirant se focaliser sur <span class="in">`Streamlit`</span>) |</span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true" tabindex="-1"></a>| Mettre en production cette application | DÃ©ployer grÃ¢ce Ã  des serveurs standardisÃ©s une application <span class="in">`Streamlit`</span> (ğŸ”´,âš«) ou proposer une version sans serveur (âš« voulant se familiariser Ã  <span class="in">`Observable`</span>) |</span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true" tabindex="-1"></a>Le dÃ©veloppement Ã  proprement parler de l'application est donc assez tardif car un certain nombre d'Ã©tapes prÃ©alables sont nÃ©cessaires pour ne pas avoir une application monolithique (ce qui est une bonne pratique). Si vous n'Ãªtes intÃ©ressÃ©s que par dÃ©velopper une application <span class="in">`Streamlit`</span>, vous pouvez directement passer aux Ã©tapes concernÃ©es (Ã  partir de la partie 3ï¸). </span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-138"><a href="#cb68-138" aria-hidden="true" tabindex="-1"></a>La premiÃ¨re Ã©tape (1ï¸âƒ£ _RÃ©cupÃ©ration et nettoyage de la base `OpenFoodFacts`_) peut Ãªtre assez chronophage. Cela est assez reprÃ©sentatif des projets de _data science_ oÃ¹ la majoritÃ© du temps est consacrÃ©e</span>
<span id="cb68-139"><a href="#cb68-139" aria-hidden="true" tabindex="-1"></a>Ã  la structuration et la manipulation de donnÃ©es. La deuxiÃ¨me Ã©tape (2ï¸ _"Faire des statistiques agrÃ©gÃ©es par catÃ©gories"_) est la moins centrale de ce sujet: si vous manquez de temps vous pouvez la passer</span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true" tabindex="-1"></a>et utiliser directement les morceaux de code mis Ã  disposition. </span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true" tabindex="-1"></a><span class="fu">## Remarques</span></span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true" tabindex="-1"></a>Cette page peut Ãªtre consultÃ©e par diffÃ©rents canaux:</span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sur un site web, les codes</span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true" tabindex="-1"></a>faisant office de solution sont, par dÃ©fauts, cachÃ©s. Cela peut Ãªtre pratique</span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true" tabindex="-1"></a>de consulter cette page si vous Ãªtes sur un parcours de couleur diffÃ©rente que le </span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true" tabindex="-1"></a>jaune et ne voulez pas voir la solution sans le vouloir ;</span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sur un notebook <span class="in">`Jupyter`</span>, les solutions de la voie ğŸŸ¡ sont affichÃ©es par dÃ©faut.</span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true" tabindex="-1"></a>Elles peuvent Ãªtre cachÃ©es en faisant <span class="in">`View`</span> &gt; <span class="in">`Collapse All Code`</span></span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sources et packages utilisÃ©s</span></span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true" tabindex="-1"></a>Notre source de rÃ©fÃ©rence sera <span class="co">[</span><span class="ot">`OpenFoodFacts`</span><span class="co">](https://fr.openfoodfacts.org/)</span>, une </span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true" tabindex="-1"></a>base contributive sur les produits alimentaires. </span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true" tabindex="-1"></a>::: {.cell .markdown}</span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #ffc10780;"&gt;</span></span>
<span id="cb68-163"><a href="#cb68-163" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;h3 class="alert-heading"&gt;&lt;i class="fa fa-lightbulb-o"&gt;&lt;/i&gt; Hint&lt;/h3&gt;</span></span>
<span id="cb68-164"><a href="#cb68-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-165"><a href="#cb68-165" aria-hidden="true" tabindex="-1"></a>Nous utiliserons Ã©galement un classifieur automatique issu du projet <span class="co">[</span><span class="ot">`predicat`</span><span class="co">](https://github.com/InseeFrLab/predicat)</span>.</span>
<span id="cb68-166"><a href="#cb68-166" aria-hidden="true" tabindex="-1"></a>Il s'agit d'un modÃ¨le qui utilise des noms de produits pour leur associer des catÃ©gories de la</span>
<span id="cb68-167"><a href="#cb68-167" aria-hidden="true" tabindex="-1"></a>nomenclature <span class="co">[</span><span class="ot">COICOP (Classification des fonctions de consommation des mÃ©nages)</span><span class="co">](https://www.insee.fr/fr/information/2408172)</span>.</span>
<span id="cb68-168"><a href="#cb68-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-169"><a href="#cb68-169" aria-hidden="true" tabindex="-1"></a>Ce modÃ¨le est lÃ  Ã  des fins de dÃ©monstration du principe de la classification automatique et de la maniÃ¨re dont celle-ci</span>
<span id="cb68-170"><a href="#cb68-170" aria-hidden="true" tabindex="-1"></a>peut Ãªtre intÃ©grÃ©e Ã  un processus de production de donnÃ©es. Il ne s'agit pas d'un modÃ¨le</span>
<span id="cb68-171"><a href="#cb68-171" aria-hidden="true" tabindex="-1"></a>officiel de l'Insee. </span>
<span id="cb68-172"><a href="#cb68-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-173"><a href="#cb68-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb68-174"><a href="#cb68-174" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/div&gt;</span></span>
<span id="cb68-175"><a href="#cb68-175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-176"><a href="#cb68-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-177"><a href="#cb68-177" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-178"><a href="#cb68-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-179"><a href="#cb68-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-180"><a href="#cb68-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-181"><a href="#cb68-181" aria-hidden="true" tabindex="-1"></a>{{&lt; include _1_recup.qmd &gt;}}</span>
<span id="cb68-182"><a href="#cb68-182" aria-hidden="true" tabindex="-1"></a>{{&lt; include _2_statistics.qmd &gt;}}</span>
<span id="cb68-183"><a href="#cb68-183" aria-hidden="true" tabindex="-1"></a>{{&lt; include _3_match_barcode.qmd &gt;}}</span>
<span id="cb68-184"><a href="#cb68-184" aria-hidden="true" tabindex="-1"></a>{{&lt; include _4_app.qmd &gt;}}</span>
<span id="cb68-185"><a href="#cb68-185" aria-hidden="true" tabindex="-1"></a>{{&lt; include _5_deployment.qmd &gt;}}</span>
<span id="cb68-186"><a href="#cb68-186" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>