<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mon Yuka ğŸ¥• avec Python ğŸ</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mon Yuka ğŸ¥• avec Python ğŸ</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Ce notebook vise Ã  prÃ©senter pas Ã  pas comment crÃ©er une application interactive avec <code>Streamlit</code> reproduisant celle proposÃ©e sur <a href="https://myyuka.lab.sspcloud.fr/">myyuka.lab.sspcloud.fr</a>.</p>
<p>Cet exercice est proposÃ© dans le cadre du <code>Funathon</code> (hackathon non compÃ©titif) organisÃ© en 2023 par lâ€™Insee et le MinistÃ¨re de lâ€™Agriculture sur le thÃ¨me <em>â€œDu champ Ã  lâ€™assietteâ€</em>. Les autres sujets sont disponibles sur le <a href="https://github.com/InseeFrLab/funathon2023"><code>Github InseeFrLab</code></a>.</p>
<p>##&nbsp;Objectif et approche pÃ©dagogique</p>
<p>Lâ€™objectif de ce projet est dâ€™apprendre Ã  utiliser <code>Python</code> pour crÃ©er des applications rÃ©actives avec <code>Streamlit</code> mais aussi de se familiariser Ã  la manipulation de donnÃ©es avec <code>Python</code> et, au passage, Ã  quelques bonnes pratiques utiles pour obtenir des projets plus lisibles et reproductibles.</p>
<p>Pour parvenir Ã  cet objectif, il est possible dâ€™emprunter plusieurs voies, plus ou moins guidÃ©es. Celles-ci sont lÃ  pour permettre que ce sujet soit rÃ©alisable. Elles sont balisÃ©es de la maniÃ¨re suivante:</p>
<table class="table">
<colgroup>
<col style="width: 15%">
<col style="width: 17%">
<col style="width: 30%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th>Balisage</th>
<th>Approche</th>
<th>PrÃ©requis de niveau</th>
<th>Objectif pÃ©dagogique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ğŸŸ¡</td>
<td>ExÃ©cuter les cellules permet dâ€™obtenir le rÃ©sultat attendu</td>
<td>CapacitÃ© Ã  installer des <em>packages</em></td>
<td>DÃ©couvrir de nouveaux <em>packages</em> en suivant le fil conducteur du projet, dÃ©couvrir les scripts <code>Python</code>, se familiariser avec <code>Git</code></td>
</tr>
<tr class="even">
<td>ğŸŸ¢</td>
<td>Des instructions dÃ©taillÃ©es sur la maniÃ¨re de procÃ©der sont proposÃ©es</td>
<td>ConnaÃ®tre quelques manipulations avec <code>Pandas</code></td>
<td>Apprendre Ã  utiliser certains <em>packages</em> avec un projet guidÃ©, se familiariser avec les projets <code>Python</code> plus consÃ©quents que les <em>notebooks</em> <code>Jupyter</code></td>
</tr>
<tr class="odd">
<td>ğŸ”µ</td>
<td>Instructions moins dÃ©taillÃ©es</td>
<td>CapacitÃ© Ã  manipuler des donnÃ©es avec <code>Pandas</code></td>
<td>Apprendre Ã  modulariser du code pour faciliter sa rÃ©utilisation dans une application, dÃ©couvrir la rÃ©cupation de donnÃ©es via des API</td>
</tr>
<tr class="even">
<td>ğŸ”´</td>
<td>Peu dâ€™instructions</td>
<td>ExpÃ©rience en dÃ©veloppement de code <code>Python</code></td>
<td>DÃ©couvrir la crÃ©ation dâ€™application ou se familiariser avec lâ€™Ã©cosystÃ¨me <code>DuckDB</code></td>
</tr>
<tr class="odd">
<td>âš«</td>
<td>Autonomie</td>
<td>Bonne maÃ®trise de <code>Python</code> et de la ligne de commande Ì€<code>Linux</code></td>
<td>Sâ€™initier au dÃ©ploiement dâ€™une application ou Ã  lâ€™ingÃ©nieurie de donnÃ©es&nbsp;</td>
</tr>
</tbody>
</table>
<p>Le parcours vers la mise en oeuvre dâ€™une application fonctionnelle se fait par Ã©tapes, en sÃ©quenÃ§ant le projet pour permettre dâ€™avoir un projet lisible, reproductible et modulaire.</p>
<p>Les Ã©tapes ne sont pas forcÃ©ment de difficultÃ© graduelle, il sâ€™agit plutÃ´t de sÃ©quencer de maniÃ¨re logique le projet pour vous faciliter la prise en main.</p>
<p>Il est donc tout Ã  fait possible de passer, selon les parties, dâ€™une voie ğŸŸ¢ Ã  une voie ğŸ”µ ou bien de tester les codes proposÃ©s dans la voie ğŸŸ¡ dâ€™abord puis, une fois que la logique a Ã©tÃ© comprise, essayer de les faire soit-mÃªme via la voie ğŸŸ¢ ou encore essayer via la voie ğŸ”µ, ne pas y parvenir du fait du caractÃ¨re plus succinct des instructions et regarder les instructions de la voie ğŸŸ¢ ou la solution de la voie ğŸŸ¡.</p>
<p>Il est mÃªme tout Ã  fait possible de sauter une Ã©tape et reprendre Ã  partir de la suivante grÃ¢ce aux <em>checkpoints</em> proposÃ©s.</p>
<p>Les consignes sont encapsulÃ©es dans des boites dÃ©diÃ©es, afin dâ€™Ãªtre sÃ©parÃ©es des explications gÃ©nÃ©rales. Par exemple, la boite verte prendra lâ€™aspect suivant:</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Exemple (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser la fonction <code>print</code> pour afficher le texte <em>â€œTotoâ€</em></p>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<p>alors que sur le mÃªme exercice, si plusieurs voies peuvent emprunter le mÃªme chemin, on utilisera une dÃ©limitation grise :</p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Exemple (ğŸ”µ,ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Afficher le texte <em>â€œTotoâ€</em></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<p>La solution associÃ©e, visible pour les personnes sur la voie ğŸŸ¡, sera:</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"toto"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>###&nbsp;Etapes du projet</p>
<p>Le projet est sÃ©quencÃ© de la maniÃ¨re suivante:</p>
<table class="table">
<colgroup>
<col style="width: 47%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th>Etape</th>
<th>Objectif</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RÃ©cupÃ©ration et nettoyage de la base <code>OpenFoodFacts</code></td>
<td>Lire des donnÃ©es avec <code>Pandas</code> depuis un site web (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), appliquer des nettoyages de champs textuels (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«), catÃ©goriser ces donnÃ©es avec un classifieur automatique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«) voire entrainer un classifieur <em>ad hoc</em> (ğŸ”´,âš«), Ã©crire ces donnÃ©es sur un systÃ¨me de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</td>
</tr>
<tr class="even">
<td>Faire des statistiques agrÃ©gÃ©es par catÃ©gories</td>
<td>Utiliser <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<code>DuckDB</code> (ğŸ”´,âš«) pour faire des statistiques par groupe</td>
</tr>
<tr class="odd">
<td>Trouver un produit dans <code>OpenFoodFacts</code> Ã  partir dâ€™un code barre</td>
<td>DÃ©tection visuelle dâ€™un code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), rechercher des donnÃ©es avec des critÃ¨res dâ€™appariement exact comme le code barre via <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ) ou Ì€<code>DuckDB</code> (ğŸ”´,âš«) ou via des distances textuelles (ğŸ”´,âš«)</td>
</tr>
<tr class="even">
<td>Encapsuler ces Ã©tapes dans une application <code>Streamlit</code></td>
<td>Tester une application <code>Streamlit</code> minimale (ğŸŸ¡,ğŸŸ¢,ğŸ”µ, ğŸ”´,âš«), personnaliser celle-ci (ğŸ”´,âš« ou ğŸŸ¡,ğŸŸ¢,ğŸ”µ dÃ©sirant se focaliser sur <code>Streamlit</code>)</td>
</tr>
<tr class="odd">
<td>Mettre en production cette application</td>
<td>DÃ©ployer grÃ¢ce Ã  des serveurs standardisÃ©s une application <code>Streamlit</code> (ğŸ”´,âš«) ou proposer une version sans serveur (âš« voulant se familiariser Ã  <code>Observable</code>)</td>
</tr>
</tbody>
</table>
<p>Le dÃ©veloppement Ã  proprement parler de lâ€™application est donc assez tardif car un certain nombre dâ€™Ã©tapes prÃ©alables sont nÃ©cessaires pour ne pas avoir une application monolithique (ce qui est une bonne pratique). Si vous nâ€™Ãªtes intÃ©ressÃ©s que par dÃ©velopper une application <code>Streamlit</code>, vous pouvez directement passer aux Ã©tapes concernÃ©es (Ã  partir de la partie 3ï¸).</p>
<p>La premiÃ¨re Ã©tape (1ï¸âƒ£ <em>RÃ©cupÃ©ration et nettoyage de la base <code>OpenFoodFacts</code></em>) peut Ãªtre assez chronophage. Cela est assez reprÃ©sentatif des projets de <em>data science</em> oÃ¹ la majoritÃ© du temps est consacrÃ©e Ã  la structuration et la manipulation de donnÃ©es. La deuxiÃ¨me Ã©tape (2ï¸ <em>â€œFaire des statistiques agrÃ©gÃ©es par catÃ©goriesâ€</em>) est la moins centrale de ce sujet: si vous manquez de temps vous pouvez la passer et utiliser directement les morceaux de code mis Ã  disposition.</p>
<section id="remarque" class="level3">
<h3 class="anchored" data-anchor-id="remarque">Remarque</h3>
<p>Cette page peut Ãªtre consultÃ©e par diffÃ©rents canaux:</p>
<ul>
<li>Sur un site web, les codes faisant office de solution sont, par dÃ©fauts, cachÃ©s. Cela peut Ãªtre pratique de consulter cette page si vous Ãªtes sur un parcours de couleur diffÃ©rente que le jaune et ne voulez pas voir la solution sans le vouloir ;</li>
<li>Sur un notebook <code>Jupyter</code>, les solutions de la voie ğŸŸ¡ sont affichÃ©es par dÃ©faut. Elles peuvent Ãªtre cachÃ©es en faisant <code>View</code> &gt; <code>Collapse All Code</code></li>
</ul>
</section>
<section id="sources-et-packages-utilisÃ©s" class="level3">
<h3 class="anchored" data-anchor-id="sources-et-packages-utilisÃ©s">Sources et packages utilisÃ©s</h3>
<p>Notre source de rÃ©fÃ©rence sera <a href="https://fr.openfoodfacts.org/"><code>OpenFoodFacts</code></a>, une base contributive sur les produits alimentaires.</p>
<div class="cell markdown">
<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #ffc10780;">
<h3 class="alert-heading anchored"><i class="fa fa-lightbulb-o"></i> Hint</h3>
<p>Nous utiliserons Ã©galement un classifieur automatique issu du projet <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a>. Il sâ€™agit dâ€™un modÃ¨le qui utilise des noms de produits pour leur associer des catÃ©gories de la nomenclature <a href="https://www.insee.fr/fr/information/2408172">COICOP (Classification des fonctions de consommation des mÃ©nages)</a>.</p>
<p>Ce modÃ¨le est lÃ  Ã  des fins de dÃ©monstration du principe de la classification automatique et de la maniÃ¨re dont celle-ci peut Ãªtre intÃ©grÃ©e Ã  un processus de production de donnÃ©es. Il ne sâ€™agit pas dâ€™un modÃ¨le officiel de lâ€™Insee.</p>
</div>
</div>
<p>#&nbsp;1ï¸âƒ£ RÃ©cupÃ©ration des donnÃ©es <code>OpenFoodFacts</code></p>
</section>
<section id="prÃ©liminaire" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©liminaire">1.1. PrÃ©liminaire (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Comme nous allons utiliser frÃ©quemment certains paramÃ¨tres, une bonne pratique consiste Ã  les stocker dans un fichier dÃ©diÃ©, au format <code>YAML</code> et dâ€™importer celui-ci via <code>Python</code>. Ceci est expliquÃ© dans <a href="https://ensae-reproductibilite.github.io/website/chapters/application.html#etape-3-gestion-des-param%C3%A8tres">ce cours de lâ€™ENSAE</a></p>
<p>Nous proposons de crÃ©er le fichier suivant au nom <code>config.yaml</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_OPENFOOD</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://static.openfoodfacts.org/data/en.openfoodfacts.org.products.csv.gz"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ENDPOINT_S3</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://minio.lab.sspcloud.fr"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">BUCKET</span><span class="kw">:</span><span class="at"> </span><span class="st">"projet-funathon"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">DESTINATION_DATA_S3</span><span class="kw">:</span><span class="at"> </span><span class="st">"/2023/sujet4/diffusion"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_FASTTEXT_MINIO</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/model_coicop10.bin"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">URL_COICOP_LABEL</span><span class="kw">:</span><span class="at"> </span><span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>âš ï¸ Si vous dÃ©sirez pouvoir reproduire tous les exemples de ce fichier, vous devez changer la variable <code>BUCKET</code> pour mettre votre nom dâ€™utilisateur sur le <code>SSPCloud</code>.</p>
<p>Nous allons lire ce fichier avec le package adaptÃ© pour transformer ces instructions en variables <code>Python</code> (stockÃ©es dans un dictionnaire)!,</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://stackoverflow.com/questions/1773805/how-can-i-parse-a-yaml-file-in-python">cette page</a>, importer les variables dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser le package <code>PyYAML</code> pour importer les Ã©lÃ©ments prÃ©sents dans <code>config.yaml</code> dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Utiliser un fichier YAML (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Importer les Ã©lÃ©ments prÃ©sents dans <code>config.yaml</code> dans un objet <code>Python</code> nommÃ© <code>config</code></p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell yellow-code" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yaml</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> import_yaml(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Importer un fichier YAML</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">        filename (str): Emplacement du fichier</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        dict: Le fichier YAML sous forme de dictionnaire Python</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> stream:</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        config <span class="op">=</span> yaml.safe_load(stream)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> config</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Il est recommandÃ© pour la suite de copier-coller la fonction crÃ©Ã©e (ne pas oublier les imports associÃ©s) dans un fichier Ã  lâ€™emplacement <code>utils/import_yaml.py</code>. Cette approche modulaire est une bonne pratique, recommandÃ©e dans <a href="https://ensae-reproductibilite.github.io/website/">ce cours de lâ€™ENSAE</a>.</p>
<p>Pour la voie ğŸŸ¡, ce fichier a dÃ©jÃ  Ã©tÃ© crÃ©Ã© pour vous. Le tester de la maniÃ¨re suivante:</p>
<div class="cell yellow-code" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts" class="level2">
<h2 class="anchored" data-anchor-id="tÃ©lÃ©charger-et-nettoyer-la-base-openfoodfacts">1.2. TÃ©lÃ©charger et nettoyer la base <code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Un export quotidien de la base de donnÃ©es <code>OpenFoodFacts</code> est fourni au format <code>CSV</code>. Lâ€™URL est le suivant:</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"URL_OPENFOOD"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Il est possible dâ€™importer de plusieurs maniÃ¨res ce type de fichier avec <code>Python</code>. Ce quâ€™on propose ici, câ€™est de le faire en deux temps, afin dâ€™avoir un contrÃ´le des options mises en oeuvre lors de lâ€™import (notamment le format de certaines variables) :</p>
<ul>
<li>Utiliser <code>requests</code> pour tÃ©lÃ©charger le fichier et lâ€™Ã©crire, de maniÃ¨re intermÃ©diaire, sur le disque local ;</li>
<li>Utiliser <code>pandas</code> avec quelques options pour importer le fichier puis le manipuler.</li>
</ul>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Utiliser la fonction <code>requests.get</code> pour tÃ©lÃ©charger le fichier. Vous pouvez vous inspirer de rÃ©ponses <a href="https://stackoverflow.com/questions/16694907/download-large-file-in-python-with-requests">ici</a></p></li>
<li><p>Utiliser <code>pd.read_csv</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates=["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer quelques types avec lâ€™argument <code>dtype</code>. Voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em> avec la mÃ©thode <code>.astype(str)</code></li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Utiliser le <em>package</em> <code>requests</code> pour tÃ©lÃ©charger le fichier. Si vous voulez afficher une barre de progression, vous pouvez vous inspirer de la fonction <code>download_pb</code> du package <a href="https://github.com/InseeFrLab/cartiflette"><code>cartiflette</code></a></p></li>
<li><p>Lire les donnÃ©es avec <code>pandas</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates = ["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer, voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em></li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> TÃ©lÃ©charger et importer OpenFoodFacts (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>TÃ©lÃ©charger le fichier avec <code>Python</code>. Pour sâ€™assurer de la progression du tÃ©lÃ©chargement, utiliser Ã©galement la librairie <code>tqdm</code>.</p></li>
<li><p>Lire les donnÃ©es avec <code>pandas</code> avec les options suivantes: + Le fichier utilise <code>\t</code> comme tabulation + Utiliser lâ€™argument <code>parse_dates = ["created_datetime", "last_modified_datetime", "last_image_datetime"]</code> + Il est nÃ©cessaire de figer, voici le dictionnaire Ã  passer</p></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"code "</span>: <span class="st">"str"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes"</span>: <span class="st">"str"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"emb_codes_tags"</span>: <span class="st">"str"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"energy_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alcohol_100g"</span>: <span class="st">"float"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Forcer la colonne <code>code</code> Ã  Ãªtre de type <em>string</em></li>
</ol>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<div id="import-openfood-solution" class="cell yellow-code" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.preprocess_openfood <span class="im">import</span> download_openfood, import_openfood</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>download_openfood(destination <span class="op">=</span> <span class="st">"openfood.csv.gz"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> import_openfood(<span class="st">"openfood.csv.gz"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>openfood.loc[:, [<span class="st">'code'</span>, <span class="st">'product_name'</span>, <span class="st">'energy-kcal_100g'</span>, <span class="st">'nutriscore_grade'</span>]].sample(<span class="dv">5</span>, random_state <span class="op">=</span> <span class="dv">12345</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lâ€™objectif de lâ€™application est de proposer pour un produit donnÃ© quelques statistiques descriptives. On propose de se focaliser sur trois scores :</p>
<ul>
<li>Le <a href="https://www.santepubliquefrance.fr/determinants-de-sante/nutrition-et-activite-physique/articles/nutri-score"><strong>nutriscore</strong></a> ;</li>
<li>Le <a href="https://fr.openfoodfacts.org/nova"><strong>score Nova</strong></a> indiquant le degrÃ© de transformation dâ€™un produit ;</li>
<li>Lâ€™<a href="https://docs.score-environnemental.com/"><strong>Ã©coscore</strong></a>, une mesure de lâ€™empreinte carbone dâ€™un produit ;</li>
</ul>
<p>Ces scores ne sont pas systÃ©matiquement disponibles sur <code>OpenFoodFacts</code> mais une part croissante des donnÃ©es prÃ©sente ces informations (directement renseignÃ©es ou imputÃ©es).</p>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [<span class="st">'nutriscore_grade'</span>, <span class="st">'nova_group'</span>, <span class="st">'ecoscore_grade'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Le bloc de code ci-dessous propose dâ€™harmoniser le format de ces scores pour faciliter la reprÃ©sentation graphique ultÃ©rieure.</p>
<p>Comme il ne sâ€™agit pas du coeur du sujet, il est donnÃ© directement Ã  tous les parcours. Le code source de cette fonction est disponible dans le module <code>utils.pipeline</code>:</p>
<div class="cell" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.pipeline <span class="im">import</span> clean_note</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [<span class="st">'nutriscore_grade'</span>, <span class="st">'nova_group'</span>, <span class="st">'ecoscore_grade'</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>openfood.loc[:, indices_synthetiques] <span class="op">=</span> pd.concat(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        [clean_note(openfood, s, <span class="st">"wide"</span>) <span class="cf">for</span> s <span class="kw">in</span> indices_synthetiques],</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        axis <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="classification-automatique-dans-une-nomenclature-de-produits" class="level2">
<h2 class="anchored" data-anchor-id="classification-automatique-dans-une-nomenclature-de-produits">1.3. Classification automatique dans une nomenclature de produits (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Pour proposer sur notre application quelques statistiques pertinentes sur le produit, nous allons associer chaque ligne dâ€™<code>OpenFoodFacts</code> Ã  un type de produit dans la <code>COICOP</code> pour pouvoir comparer un produit Ã  des produits similaires.</p>
<p>Nous allons ainsi utiliser le nom du produit pour infÃ©rer le type de bien dont il sâ€™agit.</p>
<p>Pour cela, dans les parcours ğŸŸ¡,ğŸŸ¢ et ğŸ”µ, nous allons dâ€™utiliser un classifieur expÃ©rimental proposÃ© sur <a href="https://github.com/InseeFrLab/predicat"><code>Github InseeFrLab/predicat</code></a> qui a Ã©tÃ© entrainÃ© sur cette tÃ¢che sur un grand volume de donnÃ©es (non spÃ©cifiquement alimentaires).</p>
<p>Pour les parcours ğŸ”´ et âš«, nous proposons Ã©galement dâ€™utiliser ce classifieur. NÃ©anmoins, une voie bis est possible pour entraÃ®ner soi-mÃªme un classifieur en utilisant la catÃ©gorisation des donnÃ©es disponible directement dans <code>OpenFoodFacts</code>. Il est proposÃ© dâ€™utiliser <code>Fasttext</code> (une librairie spÃ©cialisÃ©e open-source, dÃ©veloppÃ©e par <code>Meta</code> il y a quelques annÃ©es) dans le cadre de la voie ğŸ”´. Les personnes suivant la voie âš« sont libres dâ€™utiliser nâ€™importe quel <em>framework</em> de classification, par exemple un modÃ¨le disponible sur <a href="https://huggingface.co/">HuggingFace</a>.</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> en appliquant la mÃ©thode <code>str.upper</code> Ã  la colonne <code>product_name</code> afin de la mettre en majuscule</li>
<li>Modifier le <code>DataFrame</code> avec la syntaxe prenant la forme <code>data.replace({variable: dict_rules_replacement}, regex=True)</code></li>
<li>Observer les cas oÃ¹ il y a eu des changements, par exemple de la maniÃ¨re suivante</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(openfood</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    .dropna(subset <span class="op">=</span> [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    .loc[</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        openfood[<span class="st">"product_name"</span>].<span class="bu">str</span>.upper() <span class="op">!=</span> openfood[<span class="st">"preprocessed_labels"</span>],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> mettant en majuscule la colonne <code>product_name</code></li>
<li>Modifier le <code>DataFrame</code> avec la syntaxe utilisant la mÃ©thode <code>replace</code> (celle qui sâ€™applique aux <code>DataFrame</code>, pas celle sâ€™appliquant Ã  une <code>Serie</code>) et le dictionnaire adaptÃ©</li>
<li>Observer les cas oÃ¹ il y a eu des changements,</li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> appliquant les remplacements Ã  <code>product_name</code> grÃ¢ce Ã  la mÃ©thode <code>replace</code> (celle qui sâ€™applique aux <code>DataFrame</code>, pas celle sâ€™appliquant Ã  une <code>Serie</code>)</li>
<li>Observer les cas oÃ¹ il y a eu des changements</li>
</ol>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Nettoyer les donnÃ©es textuelles (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>RÃ©cupÃ©rer le dictionnaire de rÃ¨gles dans <a href="https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py">ce fichier</a></li>
<li>CrÃ©er une colonne <code>preprocessed_labels</code> appliquant les remplacements Ã  <code>product_name</code></li>
<li>Observer les cas oÃ¹ il y a eu des changements</li>
</ol>
</details>
</div>
<!----- end âš« ----->
</div>
<p>Dans un premier temps, on rÃ©cupÃ¨re les fonctions permettant dâ€™appliquer sur nos donnÃ©es le mÃªme <em>preprocessing</em> que celui qui a Ã©tÃ© mis en oeuvre lors de lâ€™entraÃ®nement du modÃ¨le:</p>
<div id="get-utils-ddc" class="cell yellow-code" data-execution_count="21">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡ et ğŸŸ¢</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> download_pb</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>download_pb(<span class="st">"https://raw.githubusercontent.com/InseeFrLab/predicat/master/app/utils_ddc.py"</span>, <span class="st">"utils/utils_ddc.py"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour observer les nettoyages de champs textuels mis en oeuvre, les lignes suivantes peuvent Ãªtre exÃ©cutÃ©es:</p>
<div class="cell" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.utils_ddc <span class="im">import</span> replace_values_ean</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>replace_values_ean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour effectuer des remplacements dans des champs textuels, le plus simple est dâ€™utiliser les expressions rÃ©guliÃ¨res (<code>regex</code>). Vous pouvez trouver une ressource complÃ¨te sur le sujet dans <a href="https://pythonds.linogaliana.fr/regex/">ce cours de <code>Python</code> de lâ€™ENSAE</a>.</p>
<p>Deux options sâ€™offrent Ã  nous:</p>
<ul>
<li>Utiliser le <em>package</em> <code>re</code> et boucler sur les lignes</li>
<li>Utiliser les fonctionnalitÃ©s trÃ¨s pratiques de <code>Pandas</code></li>
</ul>
<p>Nous privilÃ©gierons la deuxiÃ¨me approche, plus naturelle quand on utilise des <code>DataFrames</code> et plus efficace puisquâ€™elle est nativement intÃ©grÃ©e Ã  <code>Pandas</code>.</p>
<p>La syntaxe prend la forme suivante :</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data.replace({variable: dict_rules_replacement}, regex<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Câ€™est celle qui est implÃ©mentÃ©e dans la fonction <em>ad hoc</em> du script <code>utils/preprocess_openfood.py</code>. Cette derniÃ¨re sâ€™utilise de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.utils_ddc <span class="im">import</span> replace_values_ean</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.preprocess_openfood <span class="im">import</span> clean_column_dataset</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> clean_column_dataset(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        openfood, replace_values_ean,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici quelques cas oÃ¹ notre nettoyage de donnÃ©es a modifiÃ© le nom du produit :</p>
<div class="cell" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(openfood</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    .dropna(subset <span class="op">=</span> [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    .loc[</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        openfood[<span class="st">"product_name"</span>].<span class="bu">str</span>.upper() <span class="op">!=</span> openfood[<span class="st">"preprocessed_labels"</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"product_name"</span>, <span class="st">"preprocessed_labels"</span>]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On peut remarquer que pour aller plus loin et amÃ©liorer la normalisation des champs, il serait pertinent dâ€™appliquer un certain nombre de nettoyages supplÃ©mentaires, comme le retrait des mots de liaison (<em>stop words</em>). Des exemples de ce type de nettoyages sont prÃ©sents dans le <a href="https://pythonds.linogaliana.fr/nlpintro/">cours de <code>Python</code> de lâ€™ENSAE</a>.</p>
<p>Cela est laissÃ© comme exercice aux voies ğŸ”´ et âš«.</p>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Normaliser les champs textuels (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Utiliser <code>NLTK</code> ou <code>SpaCy</code> (solution prÃ©fÃ©rable) pour ajouter des nettoyages de champs textuels</p>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<p>On peut maintenant se tourner vers la classification Ã  proprement parler. Pour celle-ci, on propose dâ€™utiliser un modÃ¨le qui a Ã©tÃ© entrainÃ© avec la librairie <a href="https://fasttext.cc/"><code>Fasttext</code></a>. Voici comment rÃ©cupÃ©rer le modÃ¨le et le tester sur un exemple trÃ¨s basique:</p>
<div class="cell" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> download_pb</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fasttext</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.exists(<span class="st">"fasttext_coicop.bin"</span>) <span class="kw">is</span> <span class="va">False</span>:</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    download_pb(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> config[<span class="st">"URL_FASTTEXT_MINIO"</span>],</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="st">"fasttext_coicop.bin"</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> fasttext.load_model(<span class="st">"fasttext_coicop.bin"</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>model.predict(<span class="st">"RATATOUILLE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Le rÃ©sultat est peu intelligible. En effet, cela demande une bonne connaissance de la COICOP pour savoir de maniÃ¨re intuitive que cela correspond Ã  la catÃ©gorie <a href="https://www.insee.fr/fr/statistiques/serie/001764476"><em>â€œAutres plats cuisinÃ©s Ã  base de lÃ©gumesâ€</em></a>.</p>
<p>Avant de gÃ©nÃ©raliser le classifieur Ã  lâ€™ensemble de nos donnÃ©es, on se propose donc de rÃ©cupÃ©rer les noms des COICOP depuis le site <a href="https://www.insee.fr/fr/metadonnees/coicop2016/division/01?champRecherche=true">insee.fr</a>. Comme cela ne prÃ©sente pas de dÃ©fi majeur, le code est directement proposÃ©, quelle que soit la voie empruntÃ©e:</p>
<div class="cell" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> import_coicop_labels(url: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> pd.read_excel(url, skiprows<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    coicop[<span class="st">'Code'</span>] <span class="op">=</span> coicop[<span class="st">'Code'</span>].<span class="bu">str</span>.replace(<span class="st">"'"</span>, <span class="st">""</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> coicop.rename({<span class="st">"LibellÃ©"</span>: <span class="st">"category"</span>}, axis <span class="op">=</span> <span class="st">"columns"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coicop</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Verification de la COICOP rencontrÃ©e plus haut</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>coicop.loc[coicop[<span class="st">"Code"</span>].<span class="bu">str</span>.contains(<span class="st">"01.1.7.3.2"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Maintenant nous avons tous les ingrÃ©dients pour gÃ©nÃ©raliser notre approche. Lâ€™application en sÃ©rie de prÃ©dictions via <code>Fasttext</code> Ã©tant un peu fastidieuse et peu Ã©lÃ©gante (elle nÃ©cessite dâ€™Ãªtre Ã  lâ€™aise avec les listes <code>Python</code>) et nâ€™Ã©tant pas le centre de notre sujet, la fonction suivante est fournie pour effectuer cette opÃ©ration :</p>
<div class="cell" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_predict_coicop(data, model, product_column: <span class="bu">str</span> <span class="op">=</span> <span class="st">"preprocessed_labels"</span>, output_column: <span class="bu">str</span> <span class="op">=</span> <span class="st">"coicop"</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> pd.DataFrame(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        output_column: <span class="op">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            [k[<span class="dv">0</span>] <span class="cf">for</span> k <span class="kw">in</span> model.predict(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                [<span class="bu">str</span>(libel) <span class="cf">for</span> libel <span class="kw">in</span> data[product_column]], k <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                )[<span class="dv">0</span>]]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    data[output_column] <span class="op">=</span> predictions[output_column].<span class="bu">str</span>.replace(<span class="vs">r'__label__'</span>, <span class="st">''</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>openfood <span class="op">=</span> model_predict_coicop(openfood, model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="bis-version-alternative-via-lapi-predicat" class="level2">
<h2 class="anchored" data-anchor-id="bis-version-alternative-via-lapi-predicat">1.3.bis Version alternative via lâ€™API <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Lâ€™utilisation dâ€™API pour accÃ©der Ã  des donnÃ©es devient de plus en plus frÃ©quente. Si vous Ãªtes peu familiers avec les API, vous pouvez consulter ce <a href="https://pythonds.linogaliana.fr/api/">chapitre du cours de <code>Python</code> de lâ€™ENSAE</a> ou de la documentation <a href="https://www.book.utilitr.org/03_fiches_thematiques/fiche_api"><code>utilitR</code> (langage <code>R</code>)</a></p>
<p>Les API peuvent servir Ã  faire beaucoup plus que rÃ©cupÃ©rer des donnÃ©es. Elles sont notamment de plus en plus utilisÃ©es pour rÃ©cupÃ©rer des prÃ©dictions dâ€™un modÃ¨le. La plateforme <a href="https://huggingface.co/"><code>HuggingFace</code></a> est trÃ¨s apprÃ©ciÃ©e pour cela: elle a grandement facilitÃ© la rÃ©utilisation de modÃ¨les mis en disposition en <em>open source</em>. Cette approche a principalement deux avantages:</p>
<ul>
<li>Elle permet dâ€™appliquer sur les donnÃ©es fournies en entrÃ©e exactement les mÃªmes prÃ©-traitement que sur les donnÃ©es dâ€™entrainement. Ceci renforce la fiabilitÃ© des prÃ©dictions.</li>
<li>Elle facilite le travail des <em>data scientists</em> ou statisticiens car ils ne sont plus obligÃ©s de mettre en place des fonctions compliquÃ©es pour passer les prÃ©dictions dans une colonne de <code>DataFrame</code>.</li>
</ul>
<p>Ici, nous proposons de tester une API mise Ã  disposition de maniÃ¨re expÃ©rimentale pour faciliter la rÃ©utilisation de notre modÃ¨le de classification dans la nomenclature COICOP.</p>
<p>Cette API sâ€™appelle <code>predicat</code> et son code source est disponible sur <a href="https://github.com/InseeFrLab/predicat"><code>Github</code></a>.</p>
<p>Pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ, nous suggÃ©rons de se cantonner Ã  tester quelques exemples. Pour les parcours ğŸ”´ et âš« qui voudraient se tester sur les API, nous proposons de gÃ©nÃ©raliser ces appels Ã  <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> pour classifier toutes nos donnÃ©es.</p>
<div class="cell markdown">
<!----- boite ğŸ”´,âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Consommer un modÃ¨le sous forme d'API (ğŸ”´,âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Appliquer lâ€™API <a href="https://github.com/InseeFrLab/predicat"><code>predicat</code></a> en sÃ©rie pour catÃ©goriser lâ€™ensemble des donnÃ©es</p>
</details>
</div>
<!----- end ğŸ”´,âš« ----->
</div>
<p>Voici, pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ, un exemple dâ€™utilisation:</p>
<div class="cell" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_from_api(product_name):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    url_api <span class="op">=</span> <span class="ss">f"https://api.lab.sspcloud.fr/predicat/label?k=1&amp;q=%27</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">%27"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    output_api_predicat <span class="op">=</span> requests.get(url_api).json()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    coicop_found <span class="op">=</span> output_api_predicat[<span class="st">'coicop'</span>][<span class="ss">f"'</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">'"</span>][<span class="dv">0</span>][<span class="st">'label'</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coicop_found</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>predict_from_api(<span class="st">"Ratatouille"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour le parcours ğŸ”µ, voici un exercice pour tester sur un Ã©chantillon des donnÃ©es de lâ€™<code>OpenFoodFacts</code></p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Consommer un modÃ¨le sous forme d'API (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://github.com/InseeFrLab/predicat/blob/master/help/example-request.ipynb">ce <em>notebook</em></a>, tester lâ€™API sur une centaine de noms de produits pris alÃ©atoirement (ceux avant <em>preprocessing</em>).</p>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
</section>
<section id="ter-entrainer-son-propre-classifieur" class="level2">
<h2 class="anchored" data-anchor-id="ter-entrainer-son-propre-classifieur">1.3.ter Entrainer son propre classifieur (ğŸ”´,âš«)</h2>
<p>Les grimpeurs des voies ğŸ”´ et âš« sont encouragÃ©s Ã  essayer dâ€™entraÃ®ner eux-mÃªmes un modÃ¨le de classification.</p>
<div class="cell markdown">
<!----- boite ğŸ”´, âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Entrainer son propre modÃ¨le de classification (ğŸ”´, âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir des exemples prÃ©sents dans <a href="https://github.com/InseeFrLab/predicat/blob/master/help/example-request.ipynb">ce <em>notebook</em></a>, tester lâ€™API sur une centaine de noms de produits pris alÃ©atoirement (ceux avant <em>preprocessing</em>). Lâ€™apprentissage peut Ãªtre fait Ã  partir de la variable <code>category</code> disponible sur <code>OpenFoodFacts</code>.</p>
<p>Voici la consigne:</p>
<ul>
<li>ğŸ”´ : utiliser <code>fasttext</code></li>
<li>âš« : libertÃ© sur le <em>framework</em> utilisÃ©</li>
</ul>
</details>
</div>
<!----- end ğŸ”´, âš« ----->
</div>
</section>
<section id="ecriture-de-la-base-sur-lespace-de-stockage-distant" class="level2">
<h2 class="anchored" data-anchor-id="ecriture-de-la-base-sur-lespace-de-stockage-distant">1.4. Ecriture de la base sur lâ€™espace de stockage distant</h2>
<p>Le fait dâ€™avoir effectuÃ© en amont ce type dâ€™opÃ©ration permettra dâ€™Ã©conomiser du temps par la suite puisquâ€™on sâ€™Ã©vite des calculs Ã  la volÃ©e coÃ»teux en performance (rien de pire quâ€™une page <em>web</em> qui rame non ?).</p>
<p>Pour facilement retrouver ces donnÃ©es, on propose de les Ã©crire dans un espace de stockage accessible facilement. Pour cela, nous proposons dâ€™utiliser celui du <code>SSP Cloud</code> pour les personnes ayant un compte dessus. Pour les personnes nâ€™ayant pas de compte sur le <code>SSP Cloud</code>, vous pouvez passer cette Ã©tape et rÃ©utiliser le jeu de donnÃ©es que nous proposons pour la suite de ce parcours.</p>
<p>Nous proposons ici dâ€™utiliser le package <code>s3fs</code> qui est assez pratique pour traiter un espace distant comme on ferait dâ€™un espace de stockage local. Pour en apprendre plus sur le systÃ¨me de stockage <code>S3</code> (la technologie utilisÃ©e par le SSP Cloud) ou sur le format <code>Parquet</code>, vous pouvez consulter ce chapitre du <a href="https://pythonds.linogaliana.fr/reads3/">cours de <code>Python</code> de lâ€™ENSAE</a></p>
<p>La premiÃ¨re Ã©tape consiste Ã  initialiser la connexion (crÃ©er un <em>file system</em> distant, via <code>s3fs.S3FileSystem</code>, qui pointe vers lâ€™espace de stockage du SSP Cloud). La deuxiÃ¨me ressemble beaucoup Ã  lâ€™Ã©criture dâ€™un fichier en local, il y a seulement une couche dâ€™abstraction supplÃ©mentaire avec <code>fs.open</code>:</p>
<div class="cell" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>DESTINATION_OPENFOOD <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/openfood.parquet"</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialisation de la connexion</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: config[<span class="st">"ENDPOINT_S3"</span>]}</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(DESTINATION_OPENFOOD, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    openfood.to_parquet(file_location)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>BUCKET</code> dans le fichier <code>config.yaml</code> pour que cette commande fonctionne</strong>.</p>
<p>Enfin, pour rendre ce fichier accessible Ã  votre future application, il est nÃ©cessaire dâ€™Ã©diter la cellule ci-dessous pour remplacer <code>&lt;USERNAME_SSPCLOUD&gt;</code> par votre nom dâ€™utilisateur sur le <code>SSPCloud</code> puis dâ€™exÃ©cuter la cellule suivante:</p>
<div class="cell" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mc anonymous <span class="bu">set</span> download s3<span class="op">/&lt;</span>USERNAME_SSPCLOUD<span class="op">&gt;/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>qui rend ce fichier public.</p>
<p>Le fichier sera ainsi disponible en tÃ©lÃ©chargement directement depuis un URL de la forme:</p>
<blockquote class="blockquote">
<p>https://minio.lab.sspcloud.fr/<username_sspcloud>/2023/sujet4/diffusion/openfood.parquet</username_sspcloud></p>
</blockquote>
<p>#&nbsp;2ï¸âƒ£ Faire des statistiques agrÃ©gÃ©es par catÃ©gories</p>
<p>Cette partie permet de calculer en amont de lâ€™application des statistiques descriptives qui pourront Ãªtre utilisÃ©es par celle-ci.</p>
<p>Il est prÃ©fÃ©rable de minimiser la quantitÃ© de calculs faits Ã  la volÃ©e dans le cadre dâ€™une application. Sinon, le risque est une latence embÃªtante pour lâ€™utilisateur voire un crash du serveur Ã  cause de besoins de ressources trop importants.</p>
<p>Cette partie propose ainsi de crÃ©er en avance une base de donnÃ©es synthÃ©tisant le nombre de produits dans une catÃ©gorie donnÃ©e (par exemple les fromages Ã  pÃ¢te crue) qui partagent la mÃªme note. Cela nous permettra dâ€™afficher des statistiques personnalisÃ©es sur les produits similaires Ã  celui quâ€™on scanne.</p>
</section>
<section id="prÃ©liminaires" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©liminaires">2.1. PrÃ©liminaires (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Sur le plan technique, cette partie propose deux cadres de manipulation de donnÃ©es diffÃ©rents, selon le balisage de la voie:</p>
<ul>
<li>ğŸŸ¡,ğŸŸ¢,ğŸ”µ: utilisation de <code>Pandas</code></li>
<li>ğŸ”´,âš«: requÃªtes SQL directement sur le fichier <code>Parquet</code> grÃ¢ce Ã  <code>DuckDB</code></li>
</ul>
<p>La deuxiÃ¨me approche permet de mettre en oeuvre des calculs plus efficaces (<code>DuckDB</code>) est plus rapide mais nÃ©cessite un peu plus dâ€™expertise sur la manipulation de donnÃ©es, notamment des connaissances en SQL.</p>
<p>Cette partie va fonctionner en trois temps:</p>
<ol type="1">
<li>Lecture des donnÃ©es <code>OpenFoodFacts</code> prÃ©cÃ©demment produites</li>
<li>Construction de statistiques descriptives standardisÃ©es</li>
<li>Construction de graphiques Ã  partir de ces statistiques descriptives</li>
</ol>
<p>Les Ã©tapes 1 et 2 sont sÃ©parÃ©es conceptuellement pour les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ. Pour les parcours ğŸ”´ et âš«, lâ€™utilisation de requÃªtes SQL fait que ces deux Ã©tapes conceptuelles sont intriquÃ©es. Les parcours ğŸŸ¡,ğŸŸ¢,ğŸ”µ peuvent observer les morceaux de code proposÃ©s dans le cadre ğŸ”´ et âš«, câ€™est assez instructif. Lâ€™Ã©tape 3 (production de graphiques) sera la mÃªme pour tous les parcours.</p>
<div class="cell markdown">
<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #ffc10780;">
<h3 class="alert-heading anchored"><i class="fa fa-lightbulb-o"></i> Hint</h3>
<p>Cette partie peut Ãªtre faite sans avoir suivie la prÃ©cÃ©dente. Il est alors recommandÃ© dâ€™effectuer deux actions:</p>
<ol type="1">
<li>Dans le fichier <code>config.yaml</code>, remplacer <code>"projet-funathon"</code> par votre nom dâ€™utilisateur sur le <code>SSP Cloud</code></li>
<li>CrÃ©er une cellule en copiant-collant le texte suivant et en remplacant <code>&lt;USERNAME_SSPCLOUD&gt;</code> par votre nom dâ€™utilisateur sur le SSPCloud.</li>
</ol>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># crÃ©er une cellule de code et copier dedans ce texte</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># remplacer `&lt;USERNAME_SSPCLOUD&gt;` par votre nom d'utilisateur sur le SSPCloud</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mc cp s3<span class="op">/</span>projet<span class="op">-</span>funathon<span class="op">/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion<span class="op">/</span>openfood.parquet s3<span class="op">/&lt;</span>USERNAME_SSPCLOUD<span class="op">&gt;/</span><span class="dv">2023</span><span class="op">/</span>sujet4<span class="op">/</span>diffusion<span class="op">/</span>openfood.parquet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>USERNAME_SSPCLOUD</code> pour que cette commande fonctionne</strong>.</p>
<p>Cette commande permet de copier le fichier dâ€™exemple que nous avons mis Ã  disposition vers votre espace personnel.</p>
</div>
</div>
<p>Nous proposons dâ€™importer Ã  nouveau nos configurations:</p>
<div class="cell" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.import_yaml <span class="im">import</span> import_yaml</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Les colonnes suivantes nous seront utiles dans cette partie:</p>
<div class="cell" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>principales_infos <span class="op">=</span> [<span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici, Ã  nouveau, la configuration pour permettre Ã  <code>Python</code> de communiquer avec lâ€™espace de stockage distant:</p>
<div class="cell" data-execution_count="37">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> import_yaml(<span class="st">"config.yaml"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>INPUT_OPENFOOD <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/openfood.parquet"</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialisation de la connexion</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    client_kwargs<span class="op">=</span>{<span class="st">"endpoint_url"</span>: config[<span class="st">"ENDPOINT_S3"</span>]}</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas" class="level2">
<h2 class="anchored" data-anchor-id="import-des-donnÃ©es-depuis-lespace-de-stockage-distant-avec-pandas">2.2. Import des donnÃ©es depuis lâ€™espace de stockage distant avec <code>Pandas</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ)</h2>
<p>Il est recommandÃ© pour les parcours ğŸŸ¡, ğŸŸ¢, ğŸ”µ de travailler avec <code>Pandas</code> pour construire des statistiques descriptives. Cela se fera en deux Ã©tapes:</p>
<ul>
<li>Import des donnÃ©es directement depuis lâ€™espace de stockage, sans Ã©criture intermÃ©diaire sur le disque local, puis nettoyage de celles-ci ;</li>
<li>Construction de fonctions standardisÃ©es pour la production de statistiques descriptives.</li>
</ul>
<section id="import-et-nettoyage-des-donnÃ©es-openfoodfacts-et" class="level3">
<h3 class="anchored" data-anchor-id="import-et-nettoyage-des-donnÃ©es-openfoodfacts-et">Import et nettoyage des donnÃ©es <code>OpenFoodFacts</code> (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</h3>
<p>Il est possible de lire un CSV de plusieurs maniÃ¨res avec <code>Python</code>. Lâ€™une dâ€™elle se fait Ã  travers le <em><a href="https://book.pythontips.com/en/latest/context_managers.html#context-managers">context manager</a></em>. Le module <code>s3fs</code> permet dâ€™utiliser ce <em>context manager</em> pour lire un fichier distant, de maniÃ¨re trÃ¨s similaire Ã  la lecture dâ€™un fichier local.</p>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es depuis un espace distant (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>A partir du <em>context manager</em> intÃ©grÃ© Ã  <code>s3fs</code>, lire les donnÃ©es en suivant les consignes suivantes:</p>
<ul>
<li>la localisation des donnÃ©es est stockÃ©e dans la variable <code>INPUT_OPENFOOD</code></li>
<li>Utiliser lâ€™option <code>columns = principales_infos + indices_synthetiques</code> pour nâ€™importer que les variables nÃ©cessaires.</li>
</ul>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Lire les donnÃ©es depuis un espace distant (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Lors de lâ€™Ã©criture du fichier nous avons utilisÃ© la commande suivante:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(DESTINATION_OPENFOOD, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    openfood.to_parquet(file_location)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nous proposons de suivre la mÃªme logique en changeant quelques Ã©lÃ©ments:</p>
<ul>
<li>La variable de chemin Ã  utiliser ici est <code>INPUT_OPENFOOD</code> ;</li>
<li>Le contexte nâ€™est plus Ã  lâ€™Ã©criture (<em>â€œwbâ€</em>) mais Ã  la lecture (<em>â€œrbâ€</em>) ;</li>
<li>La commande Ã  exÃ©cuter dans ce contexte nâ€™est plus lâ€™Ã©criture dâ€™un fichier parquet mais <code>pd.read_parquet</code>. Utiliser lâ€™option <code>columns = principales_infos + indices_synthetiques</code> pour nâ€™importer que les variables nÃ©cessaires.</li>
</ul>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div id="get-openfood-parquet-2" class="cell yellow-code" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># methode 1: pandas</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fs.<span class="bu">open</span>(INPUT_OPENFOOD, <span class="st">"rb"</span>) <span class="im">as</span> remote_file:</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    openfood <span class="op">=</span> pd.read_parquet(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        remote_file,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        columns <span class="op">=</span> principales_infos <span class="op">+</span> <span class="op">\</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        indices_synthetiques</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Les donnÃ©es ont ainsi lâ€™aspect suivant:</p>
<div class="cell" data-execution_count="41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>openfood.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="statistiques-descriptives-et" class="level2">
<h2 class="anchored" data-anchor-id="statistiques-descriptives-et">2.3. Statistiques descriptives (ğŸŸ¡, ğŸŸ¢ et ğŸ”µ)</h2>
<p>On dÃ©sire calculer pour chaque classe de produits - par exemple les boissons rafraichissantes - le nombre de produits qui partagent une mÃªme note pour chaque indicateur de qualitÃ© nutritionnelle ou environnementale.</p>
<p>Nous allons utiliser le <code>DataFrame</code> suivant pour les calculs de notes:</p>
<div class="cell" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>openfood_notes <span class="op">=</span> openfood.loc[:,[<span class="st">"coicop"</span>] <span class="op">+</span> indices_synthetiques]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #1976d2;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li><p>Pour chaque valeur de la variable <code>coicop</code>, avec la mÃ©thode <code>agg</code>, effectuer un dÃ©compte des notes (<code>value_counts</code> en <code>Pandas</code>) pour chaque variable de la liste <code>indices_synthetiques</code> grÃ¢ce Ã  la mÃ©thode <code>agg</code>. Renommer ensuite les deux variables dâ€™index â€˜coicopâ€™ et â€˜noteâ€™ grÃ¢ce Ã  la mÃ©thode <code>reset_index</code></p></li>
<li><p>Pivoter les donnÃ©es vers un format <em>long</em> via les axes <code>coicop</code> et <code>note</code></p></li>
<li><p>DÃ©dupliquer les donnÃ©es en ne gardant que les paires uniques sur les variables <code>variable, note, coicop</code></p></li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #7cb342;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (ğŸŸ¢)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>AprÃ¨s un <code>groupby("coicop")</code>, effectuer un dÃ©compte des notes (<code>value_counts</code> en <code>Pandas</code>) pour chaque variable de la liste <code>indices_synthetiques</code> grÃ¢ce Ã  la mÃ©thode <code>agg</code> puis renommer les deux variables dâ€™index â€˜coicopâ€™ et â€˜noteâ€™ grÃ¢ce Ã  la mÃ©thode <code>reset_index</code></li>
</ol>
<details>
<summary>RÃ©ponse en cas de difficultÃ©</summary>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> (</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    openfood_notes</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"coicop"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    .agg({i:<span class="st">'value_counts'</span> <span class="cf">for</span> i <span class="kw">in</span> indices_synthetiques})</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    .reset_index(names<span class="op">=</span>[<span class="st">'coicop'</span>, <span class="st">'note'</span>])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<ol start="2" type="1">
<li><p>Utiliser <code>pd.melt</code> pour pivoter les donnÃ©es vers un format <em>long</em> via les axes <code>coicop</code> et <code>note</code></p></li>
<li><p>DÃ©dupliquer les donnÃ©es en ne gardant que les paires uniques sur les variables <code>variable, note, coicop</code> grÃ¢ce Ã  la mÃ©thode <code>drop_duplicates</code></p></li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->
</div>
<div class="cell" data-execution_count="45">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_stats_grades(data, indices_synthetiques):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> (</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        data</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"coicop"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        .agg({i:<span class="st">'value_counts'</span> <span class="cf">for</span> i <span class="kw">in</span> indices_synthetiques})</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        .reset_index(names<span class="op">=</span>[<span class="st">'coicop'</span>, <span class="st">'note'</span>])</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> pd.melt(stats_notes, id_vars <span class="op">=</span> [<span class="st">'coicop'</span>,<span class="st">'note'</span>])</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    stats_notes <span class="op">=</span> stats_notes.dropna().drop_duplicates(subset <span class="op">=</span> [<span class="st">'variable'</span>,<span class="st">'note'</span>,<span class="st">'coicop'</span>])</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    stats_notes[<span class="st">'value'</span>] <span class="op">=</span> stats_notes[<span class="st">'value'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats_notes</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> compute_stats_grades(openfood_notes, indices_synthetiques)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="import-et-traitement-des-donnÃ©es-avec-duckdb-et" class="level2">
<h2 class="anchored" data-anchor-id="import-et-traitement-des-donnÃ©es-avec-duckdb-et">2.4. Import et traitement des donnÃ©es avec <code>DuckDB</code> (ğŸ”´ et âš«)</h2>
<p>Cette partie propose pour les parcours ğŸ”´ et âš« de reproduire lâ€™analyse faite par les parcours ğŸŸ¡,ğŸŸ¢ et ğŸ”µ via <code>Pandas</code>.</p>
<p><code>DuckDB</code> va Ãªtre utilisÃ© pour lire et agrÃ©ger les donnÃ©es. Pour lire directement depuis un systÃ¨me de stockage distant, sans prÃ©-tÃ©lÃ©charger les donnÃ©es, vous pouvez utiliser la configuration suivante de <code>DuckDB</code>:</p>
<div class="cell" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">    INSTALL httpfs;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="st">    LOAD httpfs;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Et voici un exemple minimal de lecture de donnÃ©es Ã  partir du chemin <code>INPUT_OPENFOOD</code> dÃ©fini prÃ©cÃ©demment.</p>
<div class="cell" data-execution_count="47">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>duckdb_data <span class="op">=</span> con.sql(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"SELECT product_name, preprocessed_labels, coicop, energy_100g FROM read_parquet('s3://</span><span class="sc">{</span>INPUT_OPENFOOD<span class="sc">}</span><span class="ss">') LIMIT 10"</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>duckdb_data.df() <span class="co">#conversion en pandas dataframe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Nous proposons de crÃ©er une unique requÃªte SQL qui, dans une clause <code>SELECT</code>, pour chaque classe de produit (notre variable de COICOP), compte le nombre de produits qui partagent une mÃªme note.</p>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading anchored"><i class="fa fa-pencil"></i> Distribution des notes par catÃ©gorie de produit (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ul>
<li>CrÃ©er une fonction <code>count_one_variable_sql</code> prenant un argument nommÃ© <code>con</code> (connexion DuckDB), un argument <code>variable</code> (par dÃ©faut Ã©gal Ã  <code>nova_group</code>) et un chemin de lecture des donnÃ©es dans le systÃ¨me <code>S3</code>. Cette fonction agrÃ¨ge calcule la statistique descriptive dÃ©sirÃ©e pour <code>variable</code>.</li>
<li>CrÃ©er le <code>DataFrame</code> qui combine toutes ces statistiques pour les variables <code>["nutriscore_grade", "ecoscore_grade", "nova_group"]</code>. Celui-ci comporte quatre variables: <code>coicop</code>, <code>note</code>, <code>value</code> et <code>variable</code>.</li>
</ul>
</details>
</div>
<!----- end âš« ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->



<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction <code>count_one_variable_sql</code> prenant un argument nommÃ© <code>con</code> (connexion DuckDB), un argument <code>variable</code> (par dÃ©faut Ã©gal Ã  <code>nova_group</code>) et un chemin de lecture des donnÃ©es dans le systÃ¨me <code>S3</code>.</p>
<p>Cette fonction effectue les opÃ©rations suivantes:</p>
<ul>
<li>CrÃ©er un <code>DataFrame</code> <code>Pandas</code> aprÃ¨s avoir agrÃ©gÃ© les donnÃ©es via <code>DuckDB</code> grÃ¢ce au modÃ¨le de requÃªte</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f"SELECT coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss"> AS note, COUNT(</span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">) AS value FROM read_parquet('s3://</span><span class="sc">{</span>path_within_s3<span class="sc">}</span><span class="ss">') GROUP BY coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>CrÃ©e une variable <code>variable</code> Ã©gale Ã  la valeur de lâ€™argument <code>variable</code></p></li>
<li><p>CrÃ©er le <code>DataFrame</code> qui combine toutes ces statistiques de la maniÃ¨re suivante en appliquant la fonction de maniÃ¨re rÃ©pÃ©tÃ©e :</p></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> [<span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span>]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> [count_one_variable_sql(con, note, INPUT_OPENFOOD) <span class="cf">for</span> note <span class="kw">in</span> grades]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> pd.concat(stats_notes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!----- end ğŸ”´ ----->
</section></main></div>
<div class="cell" data-execution_count="50">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution Ã  la voie ğŸ”´ et âš« pour les curieux de la voie ğŸŸ¡, ğŸŸ¢ et ğŸ”µ</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_one_variable_sql(con, variable, path_within_s3 <span class="op">=</span> <span class="st">"temp.parquet"</span>):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="ss">f"SELECT coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss"> AS note, COUNT(</span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">) AS value FROM read_parquet('s3://</span><span class="sc">{</span>path_within_s3<span class="sc">}</span><span class="ss">') GROUP BY coicop, </span><span class="sc">{</span>variable<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    stats_one_variable <span class="op">=</span> con.sql(query).df().dropna()</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    stats_one_variable[<span class="st">'variable'</span>] <span class="op">=</span> variable</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stats_one_variable</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>grades <span class="op">=</span> [<span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span>]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> [count_one_variable_sql(con, note, INPUT_OPENFOOD) <span class="cf">for</span> note <span class="kw">in</span> grades]</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>stats_notes_sql <span class="op">=</span> pd.concat(stats_notes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Ceci nous donne donc le <code>DataFrame</code> suivant:</p>
<div class="cell" data-execution_count="51">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>stats_notes_sql.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>

<section id="sauvegarde-dans-lespace-de-stockage-distant" class="level2">
<h2 data-anchor-id="sauvegarde-dans-lespace-de-stockage-distant">2.5. Sauvegarde dans lâ€™espace de stockage distant (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Ces statistiques descriptives sont Ã  Ã©crire dans lâ€™espace de stockage distant pour ne plus avoir Ã  les calculer.</p>
<div class="cell" data-execution_count="52">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_stats_to_s3(data, destination):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ecriture au format parquet sur l'espace de stockage distant</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> fs.<span class="bu">open</span>(destination, <span class="st">"wb"</span>) <span class="im">as</span> file_location:</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        data.to_parquet(file_location)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>write_stats_to_s3(stats_notes, <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/stats_notes_pandas.parquet"</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>write_stats_to_s3(stats_notes_sql, <span class="ss">f"</span><span class="sc">{</span>config[<span class="st">'BUCKET'</span>]<span class="sc">}{</span>config[<span class="st">'DESTINATION_DATA_S3'</span>]<span class="sc">}</span><span class="ss">/stats_notes_sql.parquet"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>âš ï¸ <strong>Il faut avoir modifiÃ© la valeur de <code>BUCKET</code> dans le fichier <code>config.yaml</code> pour que cette commande fonctionne</strong>.</p>
</section>
<section id="crÃ©ation-dun-modÃ¨le-de-graphiques" class="level2">
<h2 data-anchor-id="crÃ©ation-dun-modÃ¨le-de-graphiques">2.6. CrÃ©ation dâ€™un modÃ¨le de graphiques (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>On va utiliser <code>Plotly</code> pour crÃ©er des graphiques et, ultÃ©rieurement, les afficher sur notre page web. Cela permettra dâ€™avoir un peu de rÃ©activitÃ©, câ€™est lâ€™intÃ©rÃªt de faire un format <em>web</em> plutÃ´t quâ€™une publication figÃ©e comme un <code>PDF</code>.</p>
<div class="cell markdown">
<!----- boite âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #424242;">
<h3 class="alert-heading"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction standardisÃ©e dont lâ€™<em>output</em> est un objet <code>Plotly</code> respectant le cahier des charges suivant, pour chaque classe de produit :</p>
<ul>
<li>Diagramme en barre prÃ©sentant le nombre de produits ayant telle ou telle note</li>
<li>PrÃ©voir un argument pour mettre en surbrillance une valeur donnÃ©e (par exemple la note <code>B</code>).</li>
<li>PrÃ©voir un argument pour le titre du graphique</li>
</ul>
</details>
</div>
<!----- end âš« ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #f44336;">
<h3 class="alert-heading"><i class="fa fa-pencil"></i> ModÃ¨le de figure pour les notes (ğŸ”´)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>CrÃ©er une fonction standardisÃ©e dont les arguments sont</p>
<ul>
<li>Un jeu de donnÃ©es nommÃ© <code>data</code></li>
<li>Une caractÃ©ristique nutritionnelle nommÃ©e <code>variable_note</code> par dÃ©faut Ã©gale Ã  <code>nutriscore_grade</code></li>
<li>Une catÃ©gorie nommÃ©e <code>coicop</code>, par dÃ©faut Ã©gale Ã  <code>01.1.7.3.2</code></li>
<li>Une note pour le produit dans une variable nommÃ©e <code>note_produit</code> par dÃ©faut Ã©gal Ã  <code>B</code></li>
<li>Un titre par dÃ©faut Ã©gal Ã  <code>Nutriscore</code></li>
</ul>
<p>Cette fonction effectue les tÃ¢ches suivantes:</p>
<ul>
<li>Ne conserver, dans notre ensemble de valeurs agrÃ©gÃ©es, que celles relatives Ã  la COICOP et Ã  la caractÃ©ristique nutritionnelle quâ€™on recherche ;</li>
<li>ReprÃ©senter sous forme de diagramme en barre les valeurs nutritionnelles pour chaque dÃ©cile de la distribution avec, en rouge, celle de notre produit (<code>valeur_produit</code>)</li>
<li>Nâ€™hÃ©sitez pas Ã  utiliser les options de <code>Plotly</code> pour personnaliser la figure</li>
</ul>
</details>
</div>
<!----- end ğŸ”´ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”µ ----->



<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour prÃ©parer cet exercice, crÃ©er les objets suivants:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> stats_nutritionnelles.copy()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>note_produit <span class="op">=</span> <span class="st">"B"</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>titre <span class="op">=</span> <span class="st">"Nutriscore"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>Ne conserver que les observations oÃ¹ <code>data['variable']</code> est Ã©gale Ã  la valeur <code>variable_note</code> et oÃ¹ la variable <code>coicop</code> est Ã©gale Ã  la valeur <code>coicop</code>. A lâ€™issue de ces filtres, nommer le dataframe obtenu <code>example_coicop</code></li>
<li>CrÃ©er une colonne stockant les couleurs de notre graphique. Nommer cette variable <code>color</code>.</li>
<li>CrÃ©er un diagramme en barre avec: + sur lâ€™axe des <em>x</em> les quantiles + sur lâ€™axe des <em>y</em>, la valeur Ã  reprÃ©senter + la couleur Ã  partir de la variable <code>color</code> + Les <em>labels</em> : pour lâ€™axe des <em>x</em> ne rien mettre et pour lâ€™axe des <em>y</em> : <em>â€œNoteâ€</em> + Masquer la lÃ©gende + Le titre Ã  partir de la variable <code>titre</code></li>
<li>Encapsuler ce code dans une fonction nommÃ©e <code>figure_infos_notes</code> dont les arguments sont les variables prÃ©cÃ©demment crÃ©es.</li>
</ol>
</details>
</div>
<!----- end ğŸ”µ ----->

<div class="cell markdown">
<!----- boite ğŸŸ¢ ----->



<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<p>Pour prÃ©parer cet exercice, crÃ©er les objets suivants:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> stats_nutritionnelles.copy()</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>note_produit <span class="op">=</span> <span class="st">"B"</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>titre <span class="op">=</span> <span class="st">"Nutriscore"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>Utiliser la mÃ©thode <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.loc.html"><code>loc</code></a> pour ne conserver que les observations oÃ¹ <code>data['variable']</code> est Ã©gale Ã  la valeur <code>variable_note</code> et oÃ¹ la variable <code>coicop</code> est Ã©gale Ã  la valeur <code>coicop</code> (quâ€™on a fixÃ© Ã  <code>"01.1.7.3.2"</code>). A lâ€™issue de ces filtres, nommer le dataframe obtenu <code>example_coicop</code></li>
<li>Utiliser <a href="https://numpy.org/doc/stable/reference/generated/numpy.where.html"><code>np.where</code></a> pour crÃ©er une colonne stockant les couleurs de notre graphique. On utilisera le rouge (<em>red</em>) lorsque la variable quantile est Ã©gale Ã  <code>note_produit</code> et du bleu (<em>royalblue</em>) sinon. Nommer cette variable <code>color</code>.</li>
<li>CrÃ©er un diagramme en barre avec: + sur lâ€™axe des <em>x</em> les notes (stockÃ©s dans la variable <code>note</code>) + sur lâ€™axe des <em>y</em>, la valeur Ã  reprÃ©senter (stockÃ©e dans la variable <code>value</code>) + la couleur Ã  partir de la variable <code>color</code> + Les <em>labels</em> : pour lâ€™axe des <em>x</em> ne rien mettre et pour lâ€™axe des <em>y</em> : <em>â€œNoteâ€</em> + Masquer la lÃ©gende via lâ€™argument <code>showlegend</code> de la mÃ©thode <code>update_layout</code> + Le titre Ã  partir de la variable <code>titre</code></li>
<li>Encapsuler ce code dans une fonction nommÃ©e <code>figure_infos_nutritionnelles</code> dont les arguments sont <code>data</code>, <code>variable_nutritionnelle = 'nutriscore_grade'</code>, <code>coicop = "01.1.7.3.2"</code> et <code>valeur_produit = "B"</code>.</li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ ----->

<p>Voici un exemple de fonction qui rÃ©pond aux cahiers des charges ci-dessus:</p>
<div class="cell" data-execution_count="57">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#&nbsp;Solution pour voie ğŸŸ¡</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> figure_infos_notes(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    data, variable_note <span class="op">=</span> <span class="st">'nutriscore_grade'</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    coicop <span class="op">=</span> <span class="st">"01.1.7.3.2"</span>, note_produit <span class="op">=</span> <span class="st">"B"</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">"Nutriscore"</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    example_coicop <span class="op">=</span> data.loc[data[<span class="st">'variable'</span>] <span class="op">==</span> variable_note]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    example_coicop <span class="op">=</span> example_coicop.loc[example_coicop[<span class="st">'coicop'</span>]<span class="op">==</span>coicop]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    example_coicop[<span class="st">'color'</span>] <span class="op">=</span> np.where(example_coicop[<span class="st">'note'</span>] <span class="op">==</span> note_produit, <span class="st">"Note du produit"</span>, <span class="st">"Autres produits"</span>)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.bar(</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        example_coicop,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">'note'</span>, y<span class="op">=</span><span class="st">'value'</span>, color <span class="op">=</span> <span class="st">"color"</span>, template <span class="op">=</span> <span class="st">"simple_white"</span>,</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span>title,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>        color_discrete_map<span class="op">=</span>{<span class="st">"Note produit"</span>: <span class="st">"red"</span>, <span class="st">"Autres produits"</span>: <span class="st">"royalblue"</span>},</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>{</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"note"</span>: <span class="st">"Note"</span>,</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"value"</span>: <span class="st">""</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    fig.update_xaxes(</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        categoryorder<span class="op">=</span><span class="st">'array'</span>,</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        categoryarray<span class="op">=</span> [<span class="st">'A'</span>, <span class="st">'B'</span>, <span class="st">'C'</span>, <span class="st">'D'</span>, <span class="st">'E'</span>])</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(showlegend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    fig.update_layout(hovermode<span class="op">=</span><span class="st">"x"</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    fig.update_traces(</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        hovertemplate<span class="op">=</span><span class="st">"&lt;br&gt;"</span>.join([</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Note %</span><span class="sc">{x}</span><span class="st">"</span>,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>variable_note<span class="sc">}</span><span class="ss">: "</span> <span class="op">+</span><span class="st">" %</span><span class="sc">{y}</span><span class="st"> produits"</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici un exemple dâ€™utilisation</p>
<div class="cell" data-execution_count="58">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.construct_figures <span class="im">import</span> figure_infos_notes</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> figure_infos_notes(stats_notes)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="comparer-un-produit-Ã -un-groupe-similaire" class="level1">
<h1>3ï¸âƒ£ Comparer un produit Ã  un groupe similaire</h1>
<p>Tout ce travail prÃ©liminaire nous permettra dâ€™afficher sur notre application des statistiques propres Ã  chaque catÃ©gorie.</p>
<p>On propose dâ€™utiliser le jeu de donnÃ©es prÃ©parÃ© prÃ©cedemment</p>
<div class="cell" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>indices_synthetiques <span class="op">=</span> [</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nutriscore_grade"</span>, <span class="st">"ecoscore_grade"</span>, <span class="st">"nova_group"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>principales_infos <span class="op">=</span> [<span class="st">'product_name'</span>, <span class="st">'code'</span>, <span class="st">'preprocessed_labels'</span>, <span class="st">'coicop'</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>liste_colonnes <span class="op">=</span> principales_infos <span class="op">+</span> indices_synthetiques</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>liste_colonnes_sql <span class="op">=</span> [<span class="ss">f"</span><span class="ch">\"</span><span class="sc">{</span>s<span class="sc">}</span><span class="ch">\"</span><span class="ss">"</span> <span class="cf">for</span> s <span class="kw">in</span> liste_colonnes]</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>liste_colonnes_sql <span class="op">=</span> <span class="st">', '</span>.join(liste_colonnes_sql)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On va aussi utiliser la nomenclature COICOP qui peut Ãªtre importÃ©e via le code ci-dessous:</p>
<div class="cell" data-execution_count="60">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.download_pb <span class="im">import</span> import_coicop_labels</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>coicop <span class="op">=</span> import_coicop_labels(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://www.insee.fr/fr/statistiques/fichier/2402696/coicop2016_liste_n5.xls"</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="dÃ©tection-de-code-barre" class="level2">
<h2 data-anchor-id="dÃ©tection-de-code-barre">3.1. DÃ©tection de code barre (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>La premiÃ¨re brique de notre application consiste Ã  repÃ©rer un produit par le scan du code-barre. Nous allons partir pour le moment dâ€™un produit dâ€™exemple, ci-dessous:</p>
<p><img src="https://images.openfoodfacts.org/images/products/500/011/260/2791/front_fr.4.400.jpg" class="img-fluid"></p>
<div class="cell" data-execution_count="61">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>url_image <span class="op">=</span> <span class="st">"https://images.openfoodfacts.org/images/products/500/011/260/2791/front_fr.4.400.jpg"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Dans le cadre de notre application, on permettra aux utilisateurs dâ€™<em>uploader</em> la photo dâ€™un produit, ce sera plus <em>fun</em>. En attendant notre application, partir dâ€™un produit standardisÃ© permet dÃ©jÃ  de mettre en oeuvre la logique Ã  rÃ©-appliquer plus tard.</p>
<p>Pour se simplifier la vie, le plus simple pour repÃ©rer un code-barre est dâ€™utiliser le <em>package</em> <a href="https://pypi.org/project/pyzbar/"><code>pyzbar</code></a>. Pour transformer une image en matrice <code>Numpy</code> (lâ€™objet attendu par <a href="https://pypi.org/project/pyzbar/"><code>pyzbar</code></a>), on peut utiliser le module <code>skimage</code> de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skimage <span class="im">import</span> io</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>io.imread(url_image)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>GrÃ¢ce Ã  <code>sklearn.image</code>, on peut utiliser lâ€™URL dâ€™une page web ou le chemin dâ€™un fichier de maniÃ¨re indiffÃ©rente pour la valeur de <code>url_image</code>.</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ğŸ”µğŸ”´ et âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading"><i class="fa fa-pencil"></i> Extraire le code-barre Ã  partir d'une image (ğŸŸ¢ğŸ”µğŸ”´ et âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>
<ol type="1">
<li>AprÃ¨s avoir importÃ© lâ€™image via <code>io.imread</code>, utiliser <code>pyzbar.decode</code> pour extraire les informations voulues, notamment le code-barre.</li>
<li>Si vous avez nommÃ© lâ€™objet gÃ©nÃ©rÃ©, vÃ©rifier le code-barre avec <code>obj[0].data.decode()</code>.</li>
<li>A partir de cela, crÃ©er une fonction <code>extract_ean</code> pour dÃ©coder lâ€™image (en retournant lâ€™objet gÃ©nÃ©rÃ© par <code>pyzbar</code>)</li>
</ol>
</details>
</div>
<!----- end ğŸŸ¢ğŸ”µğŸ”´ et âš« ----->
</div>
<div id="get-openfood-parquet" class="cell yellow-code" data-execution_count="64">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyzbar <span class="im">import</span> pyzbar</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_ean(url, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> io.imread(url)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    decoded_objects <span class="op">=</span> pyzbar.decode(img)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose <span class="kw">is</span> <span class="va">True</span>:</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> obj <span class="kw">in</span> decoded_objects:</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># draw the barcode</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"detected barcode:"</span>, obj)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print barcode type &amp; data</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Type:"</span>, obj.<span class="bu">type</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Data:"</span>, obj.data)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> decoded_objects</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> extract_ean(url_image, verbose <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>obj[<span class="dv">0</span>].data.decode()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On obtient bien un code identifiant notre produit. Il sâ€™agit de lâ€™EAN qui est un identifiant unique, partagÃ© quelque soit le point de vente dâ€™un produit. Il sâ€™agit dâ€™un identifiant prÃ©sent sur tout code-barre, utilisÃ© dans les systÃ¨mes dâ€™information des grandes enseignes mais aussi dans les bases produits qui peuvent Ãªtre utilisÃ©es de maniÃ¨re annexe (par exemple lâ€™<code>OpenFoodFacts</code>).</p>
</section>
<section id="association-dun-code-barre-Ã -un-produit-dopenfoodfacts" class="level2">
<h2 data-anchor-id="association-dun-code-barre-Ã -un-produit-dopenfoodfacts">3.2. Association dâ€™un code barre Ã  un produit dâ€™<code>OpenFoodFacts</code> (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>Maintenant quâ€™on dispose dâ€™un code-barre (le numÃ©ro EAN), on va trouver le produit dans <code>OpenFoodFacts</code> Ã  partir de ce code-barre.</p>
<p>Cependant, comme il peut arriver quâ€™un produit dispose dâ€™informations incomplÃ¨tes, il peut Ãªtre utile de faire non seulement de lâ€™appariement exact (trouver le produit avec le mÃªme code EAN) mais aussi de lâ€™appariement flou (trouver un produit avec un nom proche de celui quâ€™on veut).</p>
<p>Ceci est un exercice pour les parcours ğŸ”´ et âš«, les autres voies pouvant prendre cette fonction comme donnÃ©e.</p>
<p>Pour aller plus loin sur cette question des appariements flous, il pourrait Ãªtre utile dâ€™aller vers <code>ElasticSearch</code>. Câ€™est nÃ©anmoins un sujet en soi, nous proposons donc aux curieux de consulter <a href="https://pythonds.linogaliana.fr/elastic/">cette ressource</a>.</p>
<p>Voici lâ€™EAN dâ€™exemple :</p>
<div class="cell" data-execution_count="66">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>ean <span class="op">=</span> <span class="st">"5000112602999"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour avoir un outil performant, on propose dâ€™utiliser <code>DuckDB</code> pour lire et filtrer les donnÃ©es. Cela sera plus performant que lire, Ã  chaque fois que lâ€™utilisateur de notre application <em>upload</em> une image, un gros fichier (2 millions de ligne) pour nâ€™en garder quâ€™une.</p>
<p>Voici la configuration Ã  mettre en oeuvre:</p>
<div class="cell" data-execution_count="67">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>con <span class="op">=</span> duckdb.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">':memory:'</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>con.execute(<span class="st">"""</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="st">    INSTALL httpfs;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="st">    LOAD httpfs;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SET s3_endpoint='minio.lab.sspcloud.fr'</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>url_data <span class="op">=</span> <span class="st">"https://projet-funathon.minio.lab.sspcloud.fr/2023/sujet4/diffusion/openfood.parquet"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Pour commencer, effectuons une requÃªte SQL pour rÃ©cupÃ©rer le produit correspondant au code-barre quâ€™on a scannÃ©:</p>
<div class="cell markdown">
<!----- boite ğŸŸ¢ğŸ”µ ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading"><i class="fa fa-pencil"></i> Lire les donnÃ©es avec <code>DuckDB</code> (ğŸŸ¢ et ğŸ”µ)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>

Pour exÃ©cuter une requÃªte SQL, on utilise la structure suivante avec `DuckDB`

```python
data_pandas_from_duckdb = con.sql(REQUETE).df()
<p>La requÃªte que nous proposons dâ€™utiliser est Ã  structurer Ã  partir des Ã©lÃ©ments suivants :</p>
<ul>
<li>Pour la clause <code>SELECT</code>, la liste des colonnes Ã  utiliser est prÃ©-formattÃ©e dans lâ€™objet <code>liste_colonnes_sql</code></li>
<li>Pour la clause <code>FROM</code>, lâ€™instruction <code>read_parquet</code> peut Ãªtre utilisÃ©e avec lâ€™URL stockÃ© dans <code>url_data</code></li>
<li>Pour la clause <code>WHERE</code>, vous pouvez utiliser la syntaxe suivante pour normaliser les code-barres des deux cÃ´tÃ©s en retirant les 0 initiaux: <code>CAST(ltrim(code, '0') AS STRING) = CAST(ltrim({ean}) AS STRING)</code></li>
</ul>
</details>
</div>
<!----- end ğŸŸ¢ğŸ”µ ----->
</div>
<div class="cell markdown">
<!----- boite ğŸ”´ et âš« ----->

<div class="alert alert-warning" role="alert" style="color: rgba(0,0,0,.8); background-color: white; margin-top: 1em; margin-bottom: 1em; margin:1.5625emauto; padding:0 .6rem .8rem!important;overflow:hidden; page-break-inside:avoid; border-radius:.25rem; box-shadow:0 .2rem .5rem rgba(0,0,0,.05),0 0 .05rem rgba(0,0,0,.1); transition:color .25s,background-color .25s,border-color .25s ; border-right: 1px solid #dee2e6 ; border-top: 1px solid #dee2e6 ; border-bottom: 1px solid #dee2e6 ; border-left:.2rem solid #9c9797;">
<h3 class="alert-heading"><i class="fa fa-pencil"></i> Lire les donnÃ©es avec <code>DuckDB</code> (ğŸ”´ et âš«)</h3>


<details>
<summary>DÃ©rouler pour rÃ©vÃ©ler les instructions</summary>

La requÃªte que nous proposons d'utiliser est Ã  structurer Ã  partir des Ã©lÃ©ments suivants :

- Ne garder que les variables prÃ©sentes dans `liste_colonnes_sql`
- Lire les donnÃ©es directement depuis `url_data`
- Filtrer les donnÃ©es pour ne garder que celle dans l'OpenFood avec notre code-barre

Aide pour la voie ğŸ”´

Il faut normaliser les code-barres des deux cÃ´tÃ©s avant d'essayer
de comparer. Cela se fait de la maniÃ¨re suivante: `CAST(ltrim({ean}) AS STRING)`
A vous de mettre en oeuvre cela pour faire de la comparaison entre notre EAN et la
variable `code`.



```{=html}
</details>
</div>
<!----- end ğŸ”´ et âš« ----->
</div>
<p>Voici la solution:</p>
<div class="cell" data-execution_count="70">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_product_ean(con, ean, url_data, liste_colonnes_sql):</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    openfood_produit <span class="op">=</span> con.sql(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> FROM read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE CAST(ltrim(code, '0') AS STRING) = CAST(ltrim(</span><span class="sc">{</span>ean<span class="sc">}</span><span class="ss">) AS STRING)"</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        ).df()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> openfood_produit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>On va nÃ©anmoins intÃ©grer ceci dans un <em>pipeline</em> plus gÃ©nÃ©ral:</p>
<ol type="1">
<li>On cherche le produit Ã  partir du code barre</li>
<li>Si les infos sont manquantes, on rÃ©cupÃ¨re les produits dont le nom ressemble par distance de Jaro-Winkler.</li>
</ol>
<p>Voici la fonction qui permet dâ€™implÃ©menter la deuxiÃ¨me partie:</p>
<div class="cell" data-execution_count="71">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.pipeline <span class="im">import</span> clean_note</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzzy_matching_product(openfood_produit, product_name, con, url_data, liste_colonnes_sql, indices_synthetiques):</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    out_textual <span class="op">=</span> con.sql(<span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> from read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE jaro_winkler_similarity('</span><span class="sc">{</span>product_name<span class="sc">}</span><span class="ss">',product_name) &gt; 0.9 AND </span><span class="ch">\"</span><span class="ss">energy-kcal_100g</span><span class="ch">\"</span><span class="ss"> IS NOT NULL"</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    out_textual <span class="op">=</span> out_textual.df()</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    out_textual_imputed <span class="op">=</span> pd.concat(</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>            openfood_produit.loc[:, [<span class="st">"code"</span>, <span class="st">"product_name"</span>, <span class="st">"coicop"</span>]].reset_index(drop <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>            pd.DataFrame(out_textual.loc[:, indices_synthetiques].replace(<span class="st">"NONE"</span>,<span class="st">""</span>).replace(<span class="st">''</span>,np.nan).mode(dropna<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        ], ignore_index<span class="op">=</span><span class="va">True</span>, axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    out_textual_imputed.columns <span class="op">=</span> [<span class="st">"code"</span>, <span class="st">"product_name"</span>, <span class="st">"coicop"</span>] <span class="op">+</span> indices_synthetiques</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out_textual_imputed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Voici finalement le <em>pipeline</em> mis en oeuvre par une fonction :</p>
<div class="cell" data-execution_count="72">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution pour voie ğŸŸ¡</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_product_openfood(con, liste_colonnes_sql, url_data, ean):</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    openfood_produit <span class="op">=</span> con.sql(</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"SELECT </span><span class="sc">{</span>liste_colonnes_sql<span class="sc">}</span><span class="ss"> FROM read_parquet('</span><span class="sc">{</span>url_data<span class="sc">}</span><span class="ss">') WHERE CAST(ltrim(code, '0') AS STRING) = CAST(ltrim(</span><span class="sc">{</span>ean<span class="sc">}</span><span class="ss">) AS STRING)"</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    ).df()</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    product_name <span class="op">=</span> openfood_produit[<span class="st">"product_name"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> openfood_produit[<span class="st">'nutriscore_grade'</span>].isin([<span class="st">'NONE'</span>,<span class="st">''</span>]).iloc[<span class="dv">0</span>]:</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        openfood_produit <span class="op">=</span> fuzzy_matching_product(</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>            openfood_produit, product_name, con, url_data,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>            liste_colonnes_sql, indices_synthetiques)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        openfood_produit <span class="op">=</span> openfood_produit.merge(coicop, left_on <span class="op">=</span> <span class="st">"coicop"</span>, right_on <span class="op">=</span> <span class="st">"Code"</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> openfood_produit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Qui peut Ãªtre finalisÃ© de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="73">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>openfood_produit <span class="op">=</span> find_product_openfood(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    con, liste_colonnes_sql,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    url_data, ean</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>openfood_produit.head(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="production-automatique-dun-graphique" class="level2">
<h2 data-anchor-id="production-automatique-dun-graphique">Production automatique dâ€™un graphique (ğŸŸ¡,ğŸŸ¢,ğŸ”µ,ğŸ”´,âš«)</h2>
<p>La derniÃ¨re partie du prototypage consiste Ã  enrober nos fonctions de production de graphiques dans une fonction plus gÃ©nÃ©rique.</p>
<p>Pour rappel, lâ€™import des donnÃ©es se fait de la maniÃ¨re suivante:</p>
<div class="cell" data-execution_count="74">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>stats_notes <span class="op">=</span> pd.read_parquet(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://minio.lab.sspcloud.fr/projet-funathon/2023/sujet4/diffusion/stats_notes_pandas.parquet"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Dans notre application, nous allons utiliser cette fonction:</p>
<div class="cell" data-execution_count="75">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.construct_figures <span class="im">import</span> figure_infos_notes</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>variable <span class="op">=</span> <span class="st">'nutriscore_grade'</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_product_info(</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    data, variable,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    stats_notes):</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> figure_infos_notes(</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        stats_notes,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        variable_note <span class="op">=</span> variable,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        coicop <span class="op">=</span> data[<span class="st">'coicop'</span>].iloc[<span class="dv">0</span>],</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        note_produit <span class="op">=</span> data[variable].iloc[<span class="dv">0</span>],</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> variable.split(<span class="st">"_"</span>)[<span class="dv">0</span>].capitalize()</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="76">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_product_info(openfood_produit, variable, stats_notes)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="77">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plot_product_info(openfood_produit, <span class="st">"ecoscore_grade"</span>, stats_notes)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>fig.update_layout(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>


<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
 <!-- /content -->



</body></html>